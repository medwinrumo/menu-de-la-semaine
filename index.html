
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planificateur Menus Sant√© ‚Äî 14-20 f√©v 2026</title>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<style>
:root{--bg:#faf0e6;--bg2:#fff8f0;--txt:#1c1008;--txt2:#7a6a50;--acc:#051428;--acc2:#0d2a50;--accL:rgba(5,20,40,.09);--border:rgba(160,120,70,.18);--card:#fffdf8;--sh:0 2px 8px rgba(180,130,70,.08);--sh2:0 4px 14px rgba(180,130,70,.12);--r:10px;--r2:14px}
@media(prefers-color-scheme:dark){:root{--bg:#1a1208;--bg2:#221a0e;--txt:#f0e8d8;--txt2:#a09070;--acc:#e5c08f;--acc2:#f0d0a0;--accL:rgba(229,192,143,.14);--border:rgba(229,192,143,.12);--card:#251d0e;--sh:0 2px 8px rgba(0,0,0,.18);--sh2:0 4px 14px rgba(0,0,0,.25)}}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--txt);line-height:1.6}
.wrap{max-width:1140px;margin:0 auto;padding:14px}
header{text-align:center;padding:28px 16px;background:var(--card);border-radius:var(--r2);box-shadow:var(--sh2);margin-bottom:20px;border:1px solid var(--border)}
header h1{font-size:1.7rem;color:var(--acc)}
header p{color:var(--txt2);font-size:.88rem;margin-top:4px}
.wk{display:inline-block;margin-top:8px;padding:5px 14px;background:var(--acc);color:#fff;border-radius:20px;font-size:.8rem;font-weight:600}
.tabs{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap;justify-content:center;position:sticky;top:0;z-index:200;background:var(--bg);padding:10px 0}
.tabs button{padding:9px 18px;background:var(--card);border:2px solid var(--border);border-radius:var(--r);color:var(--txt);font-size:.9rem;font-weight:600;cursor:pointer;transition:.2s}
.tabs button:hover{border-color:var(--acc);color:var(--acc)}
.tabs button.on{background:var(--acc);color:#fff;border-color:var(--acc)}
.pnl{display:none}.pnl.on{display:block;animation:fu .25s ease}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(310px,1fr));gap:16px;margin-bottom:20px}
.day{background:var(--card);border-radius:var(--r2);padding:16px;box-shadow:var(--sh);border:1px solid var(--border)}
.day h3{color:var(--acc);font-size:.95rem;margin-bottom:10px;padding-bottom:7px;border-bottom:2px solid var(--acc)}
.meal{margin-bottom:8px;padding:8px 10px;background:var(--bg);border-radius:var(--r);border-left:3px solid var(--acc)}
.ml{font-weight:700;color:var(--acc);font-size:.72rem;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.mc{color:var(--txt);font-size:.85rem;line-height:1.45}
.swap-row{display:flex;gap:4px;margin-top:8px;align-items:center;flex-wrap:wrap;opacity:.4;transition:.2s}
.swap-row:hover{opacity:1}
.swap-row select{padding:3px 6px;border:1px solid var(--border);border-radius:4px;font-size:.7rem;background:var(--card);color:var(--txt2);flex:1;min-width:0}
.swap-row button{padding:3px 8px;background:var(--bg);color:var(--txt2);border:1px solid var(--border);border-radius:4px;font-size:.68rem;cursor:pointer;white-space:nowrap}
.swap-row button:hover{background:var(--acc);color:#fff;border-color:var(--acc)}
.recipe{background:var(--card);border-radius:var(--r2);margin-bottom:20px;box-shadow:var(--sh);border:1px solid var(--border);padding:22px}
.recipe-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:4px}
.recipe-top h3{color:var(--acc);font-size:1.3rem;flex:1}
.recipe-title-link{cursor:pointer;text-decoration:underline dotted;text-underline-offset:3px;transition:.15s}
.recipe-title-link:hover{opacity:.75}
.recipe-top .r-ico{font-size:2.2rem;line-height:1;flex-shrink:0}
.recipe-link{display:inline-block;margin-bottom:14px;font-size:.78rem;color:var(--acc);text-decoration:none;padding:3px 10px;background:var(--accL);border-radius:6px;word-break:break-all}
.recipe-link:hover{text-decoration:underline}
.rmeta{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.rmeta span{padding:4px 10px;background:var(--bg);border-radius:var(--r);font-size:.76rem;color:var(--txt2)}
.rmeta span b{color:var(--acc)}
.recipe h4{color:var(--txt);margin:14px 0 8px;font-size:.95rem;border-bottom:1px solid var(--border);padding-bottom:5px}
.recipe ul{list-style:none;padding:0}
.recipe ul li{padding:4px 0 4px 18px;position:relative;font-size:.84rem}
.recipe ul li::before{content:"‚Ä¢";position:absolute;left:3px;color:var(--acc);font-weight:700}
.recipe ol{padding-left:20px}
.recipe ol li{margin-bottom:8px;font-size:.84rem}
.ntag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.7rem;font-weight:600;margin:1px}
.nt1{background:#dcfce7;color:#166534}.nt2{background:#dbeafe;color:#1e40af}.nt3{background:#fef3c7;color:#92400e}
@media(prefers-color-scheme:dark){.nt1{background:#064e3b;color:#6ee7b7}.nt2{background:#1e3a5f;color:#93c5fd}.nt3{background:#451a03;color:#fcd34d}}
.shop{background:var(--card);border-radius:var(--r2);padding:22px;box-shadow:var(--sh);border:1px solid var(--border)}
.shop h2{color:var(--acc);margin-bottom:6px;font-size:1.4rem}
.shop-sub{color:var(--txt2);font-size:.82rem;margin-bottom:16px}
.rayon-nav{display:none;flex-wrap:wrap;gap:5px;margin-bottom:16px;padding:10px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border)}
.rayon-nav.open{display:flex}
.rayon-nav span{padding:5px 10px;font-size:.75rem;color:var(--txt);text-decoration:none;border-radius:6px;background:var(--card);border:1px solid var(--border);white-space:nowrap;cursor:pointer}
.rayon-nav span:hover{background:var(--accL);color:var(--acc);border-color:var(--acc)}
.toggle-rayons{display:inline-block;padding:6px 14px;font-size:.78rem;color:var(--acc);background:var(--accL);border:1px solid var(--acc);border-radius:6px;cursor:pointer;margin-bottom:10px;font-weight:600}
.toggle-rayons:hover{background:var(--acc);color:#fff}
.scat{margin-bottom:20px;scroll-margin-top:10px}
.scat h4{color:var(--acc);font-size:1rem;margin-bottom:8px;padding-bottom:5px;border-bottom:2px solid var(--acc);position:sticky;top:0;background:var(--card);z-index:2;padding-top:6px}
.sitem{display:flex;align-items:flex-start;gap:8px;padding:7px 10px;margin-bottom:5px;background:var(--bg);border-radius:var(--r);cursor:pointer;transition:.15s}
.sitem:hover{box-shadow:var(--sh)}
.sitem input[type=checkbox]{width:17px;height:17px;accent-color:var(--acc);cursor:pointer;flex-shrink:0;margin-top:2px}
.sitem .sn{font-weight:500;flex:1;font-size:.84rem;min-width:0}
.sitem .sr{font-size:.72rem;color:var(--txt2);font-style:italic;text-align:right;max-width:55%;line-height:1.3}
.caddie{margin-top:26px;padding:18px;background:var(--bg);border-radius:var(--r2);border:2px dashed var(--acc)}
.caddie h3{color:var(--acc);margin-bottom:12px;font-size:1.1rem}
.caddie-empty{color:var(--txt2);font-style:italic;font-size:.85rem}
.add-area{margin-top:22px;padding:18px;background:var(--bg);border-radius:var(--r2);border:1px solid var(--border)}
.add-area h4{color:var(--acc);margin-bottom:10px;font-size:.95rem}
.add-row{display:flex;gap:6px;flex-wrap:wrap}
.add-row input,.add-row select{padding:8px 10px;border:2px solid var(--border);border-radius:var(--r);font-size:.84rem;background:var(--card);color:var(--txt)}
.add-row input{flex:1;min-width:100px}
.add-row input:focus,.add-row select:focus{outline:none;border-color:var(--acc)}
.add-row button{padding:8px 16px;background:var(--acc);color:#fff;border:none;border-radius:var(--r);font-size:.84rem;font-weight:600;cursor:pointer}
.ctr{text-align:center;padding:10px;background:var(--bg);border-radius:var(--r);font-size:.84rem;color:var(--txt2);margin-bottom:16px}
.ctr b{color:var(--acc);font-size:1rem}
.ph{font-size:.8rem;color:var(--txt2);padding:6px 10px;font-style:italic}
.btn-print{position:fixed;bottom:20px;right:20px;padding:10px 18px;background:var(--acc);color:#fff;border:none;border-radius:30px;font-size:.85rem;font-weight:600;cursor:pointer;box-shadow:var(--sh2);z-index:100;transition:.2s}
.btn-print:hover{transform:translateY(-2px);background:var(--acc2)}
@media print{.tabs,.btn-print,.add-area,.caddie,.swap-row,.recipe-link,.toggle-rayons,.rayon-nav{display:none!important}.pnl{display:block!important}.sitem input{display:none}.wrap{padding:0}header,.day,.recipe,.shop{box-shadow:none;border:1px solid #ddd;break-inside:avoid}}
@media(max-width:700px){
  header h1{font-size:1.3rem}
  .grid{grid-template-columns:1fr}
  .tabs{position:fixed;bottom:0;left:0;right:0;top:auto;flex-direction:row;flex-wrap:nowrap;overflow-x:auto;margin:0;padding:0;padding-bottom:env(safe-area-inset-bottom,0px);border-top:1px solid var(--border);box-shadow:0 -2px 10px rgba(0,0,0,.1);gap:0;z-index:300}
  .tabs button{flex:1;min-width:54px;padding:8px 2px 6px;font-size:.6rem;border-radius:0;border:none;border-top:3px solid transparent;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background:var(--bg)}
  .tabs button.on{background:var(--accL);border-top-color:var(--acc);color:var(--acc)}
  .wrap{padding-bottom:64px}
  .sitem{flex-wrap:wrap}
  .sitem .sr{max-width:100%;text-align:left}
}
@media(orientation:landscape) and (max-height:500px){.grid{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}.wrap{padding:8px}}
.meal-din{cursor:pointer;transition:.15s}.meal-din:hover{background:var(--accL);border-left-color:var(--acc2)}
.din-ml{display:flex;justify-content:space-between;align-items:center}
.din-actions{display:flex;align-items:center;gap:8px;flex-shrink:0}
.din-btn{background:none;border:none;cursor:pointer;font-size:1.05rem;opacity:.65;padding:5px 9px;color:var(--txt2);transition:.15s;line-height:1;border-radius:6px}
.din-btn:hover{opacity:1;color:var(--acc);background:var(--accL)}
.din-btn:disabled{opacity:.2;cursor:wait}
.din-handle{cursor:pointer;font-size:1.15rem;opacity:.65;padding:5px 9px;user-select:none;-webkit-user-select:none;touch-action:manipulation;-webkit-touch-callout:none;line-height:1;transition:.15s;border-radius:6px}
.din-handle:hover{opacity:1;color:var(--acc);background:var(--accL)}
.din-handle:active{cursor:grabbing}
.day.drag-over{border-color:var(--acc)!important;background:var(--accL)!important;box-shadow:0 0 0 2px var(--acc)}
.day.swap-selected{border-color:var(--acc)!important;background:var(--accL)!important;box-shadow:0 0 0 3px var(--acc);animation:swappulse 1.2s ease-in-out infinite}
@keyframes swappulse{0%,100%{box-shadow:0 0 0 3px var(--acc)}50%{box-shadow:0 0 0 7px var(--accL)}}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:var(--acc);color:#fff;padding:10px 22px;border-radius:20px;font-size:.84rem;font-weight:600;z-index:500;box-shadow:0 4px 16px rgba(0,0,0,.2);pointer-events:none;animation:fu .2s ease}
.btn-back{margin-bottom:14px;padding:6px 14px;background:var(--accL);color:var(--acc);border:1px solid var(--acc);border-radius:6px;font-size:.8rem;font-weight:600;cursor:pointer}
.btn-back:hover{background:var(--acc);color:#fff}
.recipe ul li.ing-item{cursor:pointer;border-radius:4px;transition:.12s;padding-right:6px}
.recipe ul li.ing-item:hover{background:var(--accL);padding-left:22px}
.recipe ul li.ing-item:hover::after{content:" ‚úèÔ∏è";font-size:.65rem;opacity:.7}
.ing-edit{display:flex;gap:4px;align-items:center;flex-wrap:wrap;padding:3px 0 3px 0;list-style:none}
.ing-edit input{flex:1;min-width:90px;padding:5px 8px;border:2px solid var(--acc);border-radius:4px;font-size:.82rem;background:var(--card);color:var(--txt)}
.ing-edit select{padding:4px 5px;border:1px solid var(--border);border-radius:4px;font-size:.7rem;background:var(--card);color:var(--txt2)}
.ing-btn-ok{padding:5px 10px;background:var(--acc);color:#fff;border:none;border-radius:4px;font-size:.75rem;cursor:pointer;font-weight:600}
.ing-btn-cancel{padding:5px 8px;background:var(--bg);color:var(--txt2);border:1px solid var(--border);border-radius:4px;font-size:.75rem;cursor:pointer}
.recipe-titre-wrap{flex:1;display:flex;align-items:center;gap:6px}
.recipe-titre-wrap h3{flex:1;margin:0}
.edit-titre-btn{background:none;border:none;cursor:pointer;font-size:.85rem;opacity:.35;padding:0;flex-shrink:0;transition:.15s}
.edit-titre-btn:hover{opacity:1}
.edit-titre-input{flex:1;font-size:1.1rem;font-weight:700;color:var(--acc);border:2px solid var(--acc);border-radius:6px;padding:4px 8px;background:var(--card);width:100%;font-family:inherit}
.recipe ol li.etape-item{cursor:pointer;border-radius:4px;transition:.12s}
.recipe ol li.etape-item:hover{background:var(--accL)}
.recipe ol li.etape-item:hover::after{content:" ‚úèÔ∏è";font-size:.65rem;opacity:.7}
.etape-edit{display:flex;flex-direction:column;gap:4px;list-style:none;padding:2px 0}
.etape-textarea{width:100%;padding:6px 8px;border:2px solid var(--acc);border-radius:4px;font-size:.83rem;background:var(--card);color:var(--txt);resize:vertical;font-family:inherit;line-height:1.4;box-sizing:border-box}
.etape-btns{display:flex;gap:4px}
.ing-changed{color:var(--acc);font-style:italic}
.ing-hint{font-size:.72rem;color:var(--txt2);font-style:italic;margin:4px 0 8px;opacity:.7}
.chat-wrap{display:flex;flex-direction:column;height:calc(70vh - 110px);min-height:400px;background:var(--card);border-radius:var(--r2);border:1px solid var(--border);overflow:hidden}
.chat-messages{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;}
.msg{display:flex;flex-direction:column;max-width:88%}
.msg-user{align-self:flex-end;align-items:flex-end}
.msg-bot{align-self:flex-start;align-items:flex-start}
.msg-bubble{padding:10px 14px;border-radius:18px;font-size:.84rem;line-height:1.55;word-break:break-word}
.msg-user .msg-bubble{background:var(--acc);color:#fff;border-bottom-right-radius:4px}
.msg-bot .msg-bubble{background:var(--bg);color:var(--txt);border:1px solid var(--border);border-bottom-left-radius:4px}
.msg-action .msg-bubble{background:var(--accL)!important;border-color:var(--acc)!important;color:var(--acc)!important;font-weight:600}
.msg-bubble ul{padding-left:16px;margin:6px 0}
.msg-bubble li{margin-bottom:3px}
.chat-typing .msg-bubble{color:var(--txt2);font-style:italic}
.chat-input-area{display:flex;gap:8px;padding:10px 12px;border-top:1px solid var(--border);align-items:flex-end;background:var(--card)}
.chat-input-area textarea{flex:1;padding:10px 12px;border:2px solid var(--border);border-radius:14px;font-size:.85rem;background:var(--bg);color:var(--txt);resize:none;font-family:inherit;line-height:1.4;max-height:120px}
.chat-input-area textarea:focus{outline:none;border-color:var(--acc)}
#btn-chat-send{padding:10px 16px;background:var(--acc);color:#fff;border:none;border-radius:14px;font-size:1.1rem;cursor:pointer;flex-shrink:0;transition:.15s}
#btn-chat-send:hover{background:var(--acc2)}
#btn-chat-send:disabled{opacity:.5;cursor:wait}
.btn-gen{margin-top:12px;padding:9px 22px;background:var(--acc);color:#fff;border:none;border-radius:20px;font-size:.85rem;font-weight:600;cursor:pointer;transition:.2s;display:inline-block}
.btn-gen:hover{background:var(--acc2);transform:translateY(-2px)}
.btn-gen:disabled{opacity:.6;cursor:wait;transform:none}
.btn-swap{margin-top:10px;padding:7px 14px;background:var(--bg);color:var(--txt2);border:1px solid var(--border);border-radius:var(--r);font-size:.78rem;cursor:pointer;width:100%;transition:.15s;text-align:center}
.btn-swap:hover{background:var(--accL);color:var(--acc);border-color:var(--acc)}
.btn-swap:disabled{opacity:.5;cursor:wait}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:300;align-items:center;justify-content:center;padding:16px}
.modal-overlay.on{display:flex}
.modal{background:var(--card);border-radius:var(--r2);padding:24px;max-width:540px;width:100%;max-height:88vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,.25)}
.modal-overlay.fullscreen{padding:0;background:none}
.modal-overlay.fullscreen .modal{max-width:100%;width:100%;max-height:100vh;height:100vh;border-radius:0;box-shadow:none;padding:20px 20px 32px}
.modal-overlay.fullscreen .modal-head{position:sticky;top:0;background:var(--card);z-index:10;padding:10px 0 8px;margin-bottom:4px;border-bottom:1px solid var(--border)}
.modal-head{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px}
.modal-head h2{color:var(--acc);font-size:1.2rem;flex:1}
.modal-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--txt2);flex-shrink:0;margin-left:8px}
.modal .rmeta{margin-bottom:12px}
.modal h4{color:var(--txt);margin:12px 0 6px;font-size:.9rem;border-bottom:1px solid var(--border);padding-bottom:4px}
.modal ul{list-style:none;padding:0}
.modal ul li{padding:3px 0 3px 18px;position:relative;font-size:.83rem}
.modal ul li::before{content:"‚Ä¢";position:absolute;left:3px;color:var(--acc);font-weight:700}
.modal ol{padding-left:20px}
.modal ol li{margin-bottom:6px;font-size:.83rem}
.modal-actions{display:flex;gap:8px;margin-top:18px;flex-wrap:wrap}
.btn-accept{padding:9px 18px;background:var(--acc);color:#fff;border:none;border-radius:var(--r);font-size:.85rem;font-weight:600;cursor:pointer;flex:1}
.btn-accept:hover{background:var(--acc2)}
.btn-reject{padding:9px 18px;background:var(--bg);color:var(--txt2);border:1px solid var(--border);border-radius:var(--r);font-size:.85rem;cursor:pointer;flex:1}
.btn-reject:hover{border-color:var(--acc);color:var(--acc)}
.btn-attach{padding:10px 12px;background:var(--bg);color:var(--txt2);border:2px solid var(--border);border-radius:14px;font-size:1.1rem;cursor:pointer;flex-shrink:0;transition:.15s}
.btn-attach:hover{border-color:var(--acc);color:var(--acc);background:var(--accL)}
.recette-card{background:var(--card);border-radius:var(--r);padding:14px;border:1px solid var(--border);margin-bottom:10px;transition:.15s;position:relative}
.recette-card.selected{border-color:var(--acc);background:var(--accL)}
.recette-card-header{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.recette-card-check{width:18px;height:18px;accent-color:var(--acc);cursor:pointer;flex-shrink:0}
.recette-card-emoji{font-size:1.4rem;flex-shrink:0}
.recette-card-nom{order:10;flex-basis:100%;font-weight:600;font-size:.95rem;cursor:pointer;color:var(--acc);margin-top:2px;padding-left:2px}
.recette-card-nom:hover{text-decoration:underline}
@media(min-width:600px){
  .recette-card-header{flex-wrap:nowrap}
  .recette-card-nom{order:0;flex-basis:auto;flex:1;margin-top:0;padding-left:0}
  .recette-card .btn-del-recette{position:absolute;bottom:10px;right:10px}
  .recette-card{padding-bottom:36px}
}
.recette-card-desc{font-size:.78rem;color:var(--txt2);margin-top:5px;padding-left:28px;line-height:1.4}
.recette-card-jour{margin-top:10px;padding:10px;background:var(--bg);border-radius:var(--r);display:flex;align-items:flex-start;gap:8px;flex-wrap:wrap}
.recette-card-jour label{font-size:.82rem;color:var(--txt2);white-space:nowrap;line-height:2}
.recette-card-jour select{padding:6px 10px;border:2px solid var(--acc);border-radius:var(--r);font-size:.82rem;background:var(--card);color:var(--txt);flex:1}
.btn-cuisiner{display:block;width:100%;padding:13px;background:var(--acc);color:#fff;border:none;border-radius:var(--r);font-size:.95rem;font-weight:700;cursor:pointer;transition:.2s;margin-top:18px;text-align:center}
.btn-cuisiner:hover{background:var(--acc2);transform:translateY(-2px)}
.btn-cuisiner:disabled{opacity:.5;cursor:wait;transform:none}
.mr-empty{color:var(--txt2);font-style:italic;font-size:.86rem;text-align:center;padding:30px 0}
.mr-sub{color:var(--txt2);font-size:.82rem;margin-bottom:16px}
.source-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;margin-bottom:8px;display:flex;align-items:flex-start;gap:10px}
.source-card a{font-weight:700;font-size:.88rem;color:var(--acc);text-decoration:none;word-break:break-all}
.source-card a:hover{text-decoration:underline}
.source-card-desc{font-size:.78rem;color:var(--txt2);margin-top:3px;line-height:1.4}
.source-card-body{flex:1}
.source-section-title{font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--txt2);margin:18px 0 8px}
.source-add{display:flex;flex-direction:column;gap:8px;margin-top:18px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:var(--r)}
.source-add input{padding:9px 12px;border:2px solid var(--border);border-radius:var(--r);font-size:.85rem;background:var(--bg);color:var(--txt);width:100%;box-sizing:border-box}
.source-add input:focus{outline:none;border-color:var(--acc)}
.btn-del-recette{background:none;border:none;cursor:pointer;font-size:.9rem;opacity:.35;transition:.15s;padding:2px 5px;flex-shrink:0;line-height:1}
.btn-del-recette:hover{opacity:1}
.tag-badge{display:inline-block;font-size:.62rem;padding:2px 7px;border-radius:10px;background:var(--accL);color:var(--acc);margin:2px 2px 0 0;white-space:nowrap;font-weight:500}
.service-tag-badge{font-size:.58rem;font-weight:700;padding:2px 8px;border-radius:10px;background:rgba(234,108,0,.11);color:#c2620a;white-space:nowrap;flex-shrink:0;align-self:center;letter-spacing:.02em}
.service-tag-badge.lg{font-size:.85rem;padding:3px 12px;border-radius:12px}
@media(prefers-color-scheme:dark){.service-tag-badge{background:rgba(251,146,60,.15);color:#fb923c}}
.btn-fav{background:none;border:none;font-size:1rem;cursor:pointer;padding:0 2px;color:var(--txt2);opacity:.5;transition:.15s;line-height:1;flex-shrink:0}
.btn-fav.active{opacity:1;color:#f59e0b}
@media(prefers-color-scheme:dark){.btn-fav{color:#8a9a9a}.btn-fav-filter,.btn-tag-filter{color:#e4eded}}
.mr-search-row{margin-bottom:10px}
.mr-search-input{width:100%;padding:9px 14px;border:2px solid var(--border);border-radius:20px;font-size:.88rem;background:var(--card);color:var(--txt);box-sizing:border-box;transition:.15s}
.mr-search-input:focus{outline:none;border-color:var(--acc)}
.tp-bar{margin:12px 0 8px}
.tp-filtres{display:flex;gap:6px;overflow-x:auto;padding:4px 0 10px;-webkit-overflow-scrolling:touch;scrollbar-width:none;margin-bottom:4px}
.tp-filtres::-webkit-scrollbar{display:none}
.tp-filtre{padding:5px 13px;border-radius:20px;border:1.5px solid var(--border);background:var(--card);color:var(--txt);font-size:.78rem;cursor:pointer;white-space:nowrap;transition:.15s;flex-shrink:0}
.tp-filtre.on{background:var(--acc);color:#fff;border-color:var(--acc)}
.tp-badge{display:inline-flex;align-items:center;justify-content:center;min-width:17px;height:17px;background:#fff;color:var(--acc);border-radius:10px;font-size:.65rem;font-weight:700;padding:0 4px;margin-left:4px;vertical-align:middle}
.tp-filtre-ajouter{border-color:#4caf50;color:#388e3c}
.tp-filtre-ajouter.plein{border-color:#e53935;color:#c62828}
.tp-filtre-ajouter.on{background:#ff9800;border-color:#ff9800;color:#fff}
.tp-rsel{font-size:.75rem;border:1px solid #ddd;border-radius:6px;padding:3px 5px;background:#f8f8f8;cursor:pointer;max-width:110px;flex-shrink:0}
.tp-btn-ok{padding:5px 12px;background:#4caf50;color:#fff;border:none;border-radius:var(--r2);font-size:.85rem;font-weight:700;cursor:pointer;white-space:nowrap;flex-shrink:0}
.tp-item{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--card);border-radius:var(--r);border:1px solid var(--border);margin-bottom:7px}
.tp-nom{flex:1;font-size:.9rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tp-rayon-badge{font-size:.72rem;color:var(--txt2);background:var(--bg);padding:2px 8px;border-radius:10px;white-space:nowrap;flex-shrink:0}
.tp-btn-add{padding:5px 12px;background:var(--acc);color:#fff;border:none;border-radius:var(--r2);font-size:.8rem;font-weight:600;cursor:pointer;white-space:nowrap;flex-shrink:0}
.tp-btn-del{padding:5px 8px;background:none;border:1px solid var(--border);border-radius:var(--r2);font-size:.8rem;cursor:pointer;color:var(--txt2);flex-shrink:0}
.mr-filtres{display:flex;gap:8px;align-items:center;margin-bottom:4px;flex-wrap:wrap}
.btn-fav-filter{padding:6px 12px;border:1px solid var(--border);border-radius:20px;background:var(--card);color:var(--txt);font-size:.8rem;cursor:pointer;transition:.15s;white-space:nowrap}
.btn-fav-filter.on{background:var(--acc);color:#fff;border-color:var(--acc)}
.btn-tag-filter{padding:6px 12px;border:1px solid var(--border);border-radius:20px;background:var(--card);color:var(--txt);font-size:.8rem;cursor:pointer;transition:.15s;white-space:nowrap}
.btn-tag-filter.has-active{background:var(--acc);color:#fff;border-color:var(--acc)}
.tag-filter-panel{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:14px;margin-bottom:12px;box-shadow:var(--sh2);display:none}
.tag-filter-section{margin-bottom:10px}
.tag-filter-section:last-child{margin-bottom:0}
.tag-filter-cat-title{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--txt2);display:block;margin-bottom:6px}
.tag-filter-chips{display:flex;flex-wrap:wrap;gap:5px}
.tag-chip{padding:3px 10px;border:1px solid var(--border);border-radius:16px;font-size:.72rem;cursor:pointer;background:var(--bg);color:var(--txt2);transition:.15s;white-space:nowrap}
.tag-chip:hover{border-color:var(--acc);color:var(--acc)}
.tag-chip.active{background:var(--acc);color:#fff;border-color:var(--acc)}
.tag-chip.dim{opacity:.3;cursor:default}
.tag-chip.dim:hover{border-color:var(--border);color:var(--txt2)}
.chip-count{font-size:.58rem;font-weight:700;opacity:.65;margin-left:2px}
.tag-filter-reset{width:100%;padding:6px;font-size:.75rem;color:var(--txt2);background:none;border:none;border-top:1px solid var(--border);cursor:pointer;margin-top:10px;padding-top:10px;display:block}
.tag-filter-reset:hover{color:var(--acc)}
.tag-mgr-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999;display:flex;align-items:center;justify-content:center;padding:16px}
.tag-mgr-modal{background:var(--card);border-radius:var(--r2);padding:20px;max-width:520px;width:100%;max-height:82vh;overflow-y:auto;box-shadow:var(--sh2)}
.tag-mgr-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.tag-mgr-hdr h3{font-size:.95rem;font-weight:700}
.tag-mgr-close{background:none;border:none;cursor:pointer;font-size:1.1rem;color:var(--txt2)}
.tag-mgr-cat{margin-bottom:18px}
.tag-mgr-cat-title{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--txt2);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.tag-mgr-chips{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px}
.tag-mgr-chip{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:14px;font-size:.72rem;background:var(--accL);color:var(--acc);border:1px solid transparent}
.tag-mgr-del{background:none;border:none;cursor:pointer;color:var(--acc);font-size:.7rem;line-height:1;padding:0;opacity:.6;flex-shrink:0}
.tag-mgr-del:hover{opacity:1}
.tag-mgr-add{display:flex;gap:6px}
.tag-mgr-input{flex:1;padding:5px 10px;border:1.5px solid var(--border);border-radius:20px;font-size:.8rem;background:var(--bg);color:var(--txt);outline:none}
.tag-mgr-input:focus{border-color:var(--acc)}
.tag-mgr-btn{padding:5px 12px;background:var(--acc);color:#fff;border:none;border-radius:20px;font-size:.78rem;cursor:pointer;white-space:nowrap}
.tag-mgr-separator{border:none;border-top:1px solid var(--border);margin:16px 0}
.tag-mgr-del-cat{background:none;border:none;cursor:pointer;color:var(--txt2);font-size:.65rem;opacity:.5;padding:0}
.tag-mgr-del-cat:hover{opacity:1;color:#ef4444}
.mr-count{font-size:.78rem;color:var(--txt2);white-space:nowrap;margin-left:auto}
.din-line{display:flex;gap:5px;align-items:baseline;font-size:.88rem}
.din-type{font-size:.68rem;color:var(--acc);font-weight:700;min-width:38px;opacity:.85;text-transform:uppercase}
.btn-del-service{background:none;border:none;color:var(--txt2);font-size:.72rem;cursor:pointer;padding:0 0 0 6px;opacity:.35;transition:.15s;flex-shrink:0;line-height:1;margin-left:auto}
.btn-del-service:hover{opacity:1;color:#e55}
.meal-gou{border-bottom:1px dashed var(--border)}
.recette-type-sel{padding:6px 10px;border:2px solid var(--acc);border-radius:var(--r);font-size:.82rem;background:var(--card);color:var(--txt)}
.svc-menu{position:absolute;top:calc(100% + 4px);left:0;background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh2);z-index:600;min-width:150px;padding:4px 0;white-space:nowrap}
.svc-menu button{display:block;width:100%;text-align:left;padding:6px 14px;background:none;border:none;font-size:.78rem;cursor:pointer;color:var(--txt)}
.svc-menu button:hover{background:var(--accL);color:var(--acc)}
.svc-menu button.active{font-weight:700;color:var(--acc)}
.tags-edit-btn{background:none;border:none;cursor:pointer;font-size:.72rem;color:var(--txt2);padding:0 3px;opacity:.45;transition:.15s;line-height:1}
.tags-edit-btn:hover{opacity:1;color:var(--acc)}
.tag-picker{background:var(--card);border:1px solid var(--acc);border-radius:var(--r);padding:10px;margin-top:6px;display:flex;flex-wrap:wrap;gap:5px;box-shadow:var(--sh2)}
.tag-picker-group{width:100%}
.tag-picker-title{font-size:.6rem;color:var(--txt2);font-weight:700;text-transform:uppercase;letter-spacing:.05em;display:block;margin:6px 0 4px}
.tag-picker-title:first-child{margin-top:0}
.tag-picker-chip{padding:3px 9px;border:1px solid var(--border);border-radius:12px;font-size:.68rem;cursor:pointer;background:var(--bg);color:var(--txt2);transition:.15s}
.tag-picker-chip:hover{border-color:var(--acc);color:var(--acc)}
.tag-picker-chip.has{background:var(--acc);color:#fff;border-color:var(--acc)}
.recette-card-img{width:100%;height:130px;object-fit:cover;border-radius:var(--r);margin-bottom:8px;display:block}
.modal-img{width:100%;max-height:220px;object-fit:cover;border-radius:var(--r);margin-bottom:14px;display:block}
.modal-astuces-box{margin-top:10px;padding:10px 12px;background:var(--accL);border-radius:var(--r);border-left:3px solid var(--acc)}
.modal-astuces-box h4{color:var(--acc);font-size:.85rem;margin-bottom:5px;border:none;padding:0;margin-top:0}
.modal-sante-box{margin-top:8px;padding:8px 12px;background:#dcfce7;border-radius:var(--r);border-left:3px solid #16a34a}
@media(prefers-color-scheme:dark){.modal-sante-box{background:#052e16;border-color:#4ade80}}
.modal-sante-box h4{color:#166534;font-size:.82rem;margin-bottom:4px;border:none;padding:0;margin-top:0}
@media(prefers-color-scheme:dark){.modal-sante-box h4,.modal-sante-box li{color:#86efac}}
</style>
</head>
<body>
<div class="wrap">
<header>
<h1>üçΩÔ∏è Planificateur Menus</h1>
<div class="wk" id="wk-label">üìÖ Samedi 14 ‚Üí Vendredi 20 f√©vrier 2026</div>
<br>
<button id="btn-gen" class="btn-gen" onclick="genererSemaine()">üóìÔ∏è G√©n√©rer la semaine</button>
</header>
<div class="tabs">
<button class="on" onclick="tab('apercu',this)">üìÖ Semaine</button>
<button onclick="tab('recettes',this)">üë®‚Äçüç≥ Recettes</button>
<button onclick="tab('courses',this)">üõí Courses</button>
<button onclick="tab('mesrecettes',this)">üìö Mes recettes</button>
<button onclick="tab('sources',this)">üîó Sources</button>
<button onclick="tab('tous-produits',this)">üì¶ Produits</button>
<button onclick="tab('chat',this)">üí¨ NutriCoach</button>
</div>

<!-- ===== APER√áU ===== -->
<div id="apercu" class="pnl on">
<div class="grid" id="weekgrid"></div>
</div>

<!-- ===== RECETTES ===== -->
<div id="recettes" class="pnl">

<div class="recipe" id="recipe-0"><button class="btn-back" onclick="goMenu()">‚Üê Retour au menu</button></div>
<div class="recipe" id="recipe-1"><button class="btn-back" onclick="goMenu()">‚Üê Retour au menu</button></div>
<div class="recipe" id="recipe-2"><button class="btn-back" onclick="goMenu()">‚Üê Retour au menu</button></div>
<div class="recipe" id="recipe-3"><button class="btn-back" onclick="goMenu()">‚Üê Retour au menu</button></div>
<div class="recipe" id="recipe-4"><button class="btn-back" onclick="goMenu()">‚Üê Retour au menu</button></div>
<div class="recipe" id="recipe-5"><button class="btn-back" onclick="goMenu()">‚Üê Retour au menu</button></div>
<div class="recipe" id="recipe-6"><button class="btn-back" onclick="goMenu()">‚Üê Retour au menu</button></div>
</div>

<!-- ===== CHAT ===== -->
<div id="chat" class="pnl">
<div class="chat-wrap">
  <div class="chat-messages" id="chat-messages">
    <div class="msg msg-bot"><div class="msg-bubble">Bonjour ! Je suis NutriCoach üëã<br>Posez-moi une question sur la nutrition, demandez-moi de modifier un repas, ou utilisez le bouton üìé pour importer une recette ou un article.</div></div>
  </div>
  <div class="chat-input-area">
    <textarea id="chat-input" rows="2" placeholder="Question ou instruction‚Ä¶"></textarea>
    <input type="file" id="fichierImport" accept=".txt,.md,.pdf,.jpg,.jpeg,.png,.webp" style="display:none" onchange="importerFichier(this)">
    <button class="btn-attach" onclick="document.getElementById('fichierImport').click()" title="Importer un fichier (recette, article, photo)">üìé</button>
    <button id="btn-chat-send" onclick="envoyerChat()">‚û§</button>
  </div>
</div>
</div>

<!-- ===== MES RECETTES ===== -->
<div id="mesrecettes" class="pnl">
<div class="shop">
<h2>üìö Mes recettes</h2>
<p class="mr-sub">Recettes import√©es via NutriCoach ‚Ä¢ Cliquez sur un nom pour voir le d√©tail ‚Ä¢ Cochez + choisissez un jour pour cuisiner</p>
<div class="mr-search-row" id="mr-search-row" style="display:none">
  <input type="search" id="mr-search" class="mr-search-input" placeholder="üîç Rechercher une recette‚Ä¶" oninput="filtrerRecettes()">
</div>
<div class="mr-filtres" id="mr-filtres" style="display:none">
  <button class="btn-fav-filter" id="btn-filtre-fav"
    onclick="filtreFavoris=!filtreFavoris;this.classList.toggle('on',filtreFavoris);filtrerRecettes()">
    ‚òÖ Favoris
  </button>
  <button class="btn-tag-filter" id="btn-tag-filter" onclick="toggleTagFilterPanel()">
    üè∑Ô∏è Tags<span id="tag-filter-badge"></span> ‚ñæ
  </button>
  <span class="mr-count" id="mr-count"></span>
</div>
<div class="tag-filter-panel" id="tag-filter-panel" style="display:none"></div>
<div id="mes-recettes-liste">
  <p class="mr-empty">Aucune recette import√©e. Allez dans l'onglet NutriCoach et utilisez le bouton üìé pour importer une recette (texte, PDF ou photo).</p>
</div>
<button class="btn-cuisiner" id="btn-cuisiner" onclick="cuisinerCetteSemaine()">üçΩÔ∏è Cuisiner cette semaine</button>
</div>
</div>

<!-- ===== SOURCES ===== -->
<div id="sources" class="pnl">
<div class="shop">
<h2>üîó Sources de r√©f√©rence</h2>
<p class="mr-sub">Sites et comptes utilis√©s par NutriCoach pour proposer des recettes adapt√©es √† ton profil sant√©.</p>

<div class="source-section-title">üìå Sites int√©gr√©s par d√©faut</div>
<div id="sources-defaut"></div>

<div class="source-section-title">‚≠ê Mes sources ajout√©es</div>
<div id="sources-perso">
  <p class="mr-empty" id="sources-perso-empty">Aucune source ajout√©e. Utilise le formulaire ci-dessous ou demande √† NutriCoach d'ajouter un site via le chat.</p>
</div>

<div class="source-add">
  <strong style="font-size:.85rem">Ajouter une source</strong>
  <input type="url" id="source-url-input" placeholder="https://... ou @compte_instagram">
  <input type="text" id="source-desc-input" placeholder="Description courte (sp√©cialit√©, type de recettes...)">
  <button class="btn-cuisiner" style="margin-top:4px" onclick="ajouterSourceManuelle()">Ôºã Ajouter √† mes sources</button>
</div>

<div class="source-section-title">üì• Importer une recette depuis une URL</div>
<p class="mr-sub">Colle l'URL d'une recette pr√©cise ‚Äî elle sera analys√©e et ajout√©e √† ¬´ Mes recettes ¬ª.</p>
<div class="source-add">
  <input type="url" id="scrape-url-input" placeholder="https://cuisinerigbas.com/curry-lentilles-corail/">
  <button class="btn-cuisiner" id="btn-scrape" style="margin-top:4px" onclick="importerRecetteUrl()">üì• Importer cette recette</button>
</div>
<hr style="margin:28px 0;border:none;border-top:1px solid var(--border)">
<div style="background:rgba(220,38,38,.06);border:1px solid rgba(220,38,38,.2);border-radius:var(--r2);padding:16px">
  <strong style="font-size:.85rem;color:#b91c1c">‚ö†Ô∏è Zone dangereuse</strong>
  <p style="font-size:.82rem;color:var(--txt2);margin:6px 0 12px">Remet le planning et la liste de courses √† z√©ro. <b>Vos recettes personnelles sont conserv√©es.</b></p>
  <button onclick="reinitialiserSysteme()" style="background:#dc2626;color:#fff;border:none;padding:9px 18px;border-radius:var(--r);font-size:.85rem;font-weight:600;cursor:pointer">‚ö†Ô∏è R√©initialiser le planning</button>
</div>
</div>
</div>

<!-- ===== COURSES ===== -->
<div id="courses" class="pnl">
<div class="shop">
<h2>üõí Liste de courses</h2>
<p class="shop-sub" id="courses-sub">Semaine du 14 au 20 f√©vrier 2026</p>

<div class="toggle-rayons" onclick="document.getElementById('rnav').classList.toggle('open')">üìç Navigation par rayon ‚ñæ</div>
<div class="rayon-nav" id="rnav">
<span onclick="sTo('cat-legumes')">ü•¨ L√©gumes</span>
<span onclick="sTo('cat-fruits')">üçé Fruits</span>
<span onclick="sTo('cat-viandes')">ü•© Viandes</span>
<span onclick="sTo('cat-laitier')">ü•ö Laitier</span>
<span onclick="sTo('cat-feculents')">üåæ F√©culents</span>
<span onclick="sTo('cat-boulangerie')">üçû Boulangerie</span>
<span onclick="sTo('cat-epicerie')">ü´ô √âpicerie</span>
<span onclick="sTo('cat-herbes')">üåø Herbes</span>
<span onclick="sTo('cat-oleagineux')">ü•ú Ol√©agineux</span>
<span onclick="sTo('cat-traiteur')">ü´ï Traiteur</span>
<span onclick="sTo('cat-boissons')">ü•§ Boissons</span>
<span onclick="sTo('cat-surgeles')">üßä Surgel√©s</span>
<span onclick="sTo('cat-entretien')">üßπ Entretien</span>
<span onclick="sTo('cat-sante')">üíä Sant√©</span>
<span onclick="sTo('cat-corps')">üß¥ Corps</span>
<span onclick="sTo('cat-divers')">üè∑Ô∏è Divers</span>
</div>

<div id="liste-principale">

<div class="scat" id="cat-legumes"><h4>ü•¨ L√©gumes frais</h4><div class="si" data-cat="legumes">
</div></div>

<div class="scat" id="cat-fruits"><h4>üçé Fruits</h4><div class="si" data-cat="fruits">
</div></div>

<div class="scat" id="cat-viandes"><h4>ü•© Viandes, Volailles & Poissons</h4><div class="si" data-cat="viandes">
</div></div>

<div class="scat" id="cat-laitier"><h4>ü•ö ≈íufs & Produits laitiers</h4><div class="si" data-cat="laitier">
</div></div>

<div class="scat" id="cat-feculents"><h4>üåæ F√©culents & L√©gumineuses</h4><div class="si" data-cat="feculents">
</div></div>

<div class="scat" id="cat-boulangerie"><h4>üçû Boulangerie</h4><div class="si" data-cat="boulangerie">
</div></div>

<div class="scat" id="cat-epicerie"><h4>ü´ô √âpicerie & Condiments</h4><div class="si" data-cat="epicerie">
</div></div>

<div class="scat" id="cat-herbes"><h4>üåø Herbes fra√Æches</h4><div class="si" data-cat="herbes">
</div></div>

<div class="scat" id="cat-oleagineux"><h4>ü•ú Ol√©agineux & Graines</h4><div class="si" data-cat="oleagineux">
</div></div>

<div class="scat" id="cat-traiteur"><h4>ü´ï Fait maison / Traiteur</h4><div class="si" data-cat="traiteur">
</div></div>

<div class="scat" id="cat-boissons"><h4>ü•§ Boissons</h4><div class="si" data-cat="boissons"></div></div>
<div class="scat" id="cat-surgeles"><h4>üßä Surgel√©s</h4><div class="si" data-cat="surgeles"></div></div>
<div class="scat" id="cat-entretien"><h4>üßπ Entretien</h4><div class="si" data-cat="entretien"></div></div>
<div class="scat" id="cat-sante"><h4>üíä Sant√© / Pharmacie</h4><div class="si" data-cat="sante"></div></div>
<div class="scat" id="cat-corps"><h4>üß¥ Soin du corps</h4><div class="si" data-cat="corps"></div></div>
<div class="scat" id="cat-divers"><h4>üè∑Ô∏è Divers</h4><div class="si" data-cat="divers"></div></div>

</div>

<div class="caddie"><h3>‚úÖ Dans le caddie <button onclick="viderCaddie()" style="float:right;font-size:.72rem;padding:3px 10px;border:1px solid var(--acc);background:none;color:var(--acc);border-radius:12px;cursor:pointer;font-weight:600">Tout vider</button></h3>
<div id="caddie"><p class="caddie-empty">Cochez les produits pour les ajouter ici.</p></div></div>

<div class="add-area"><h4>‚ûï Ajouter un produit</h4>
<div class="add-row">
<input type="text" id="add-nom" placeholder="Nom du produit" onkeydown="if(event.key==='Enter')ajP()">
<select id="add-rayon">
<option value="legumes">ü•¨ L√©gumes</option><option value="fruits">üçé Fruits</option>
<option value="viandes">ü•© Viandes</option><option value="laitier">ü•ö Laitier</option>
<option value="feculents">üåæ F√©culents</option><option value="boulangerie">üçû Boulangerie</option>
<option value="epicerie">ü´ô √âpicerie</option><option value="herbes">üåø Herbes</option>
<option value="oleagineux">ü•ú Ol√©agineux</option><option value="traiteur">ü´ï Traiteur</option>
<option value="boissons">ü•§ Boissons</option><option value="surgeles">üßä Surgel√©s</option>
<option value="entretien">üßπ Entretien</option><option value="sante">üíä Sant√©</option>
<option value="corps">üß¥ Corps</option><option value="divers" selected>üè∑Ô∏è Divers</option>
</select>
<button onclick="ajP()">Ajouter</button>
</div></div>

</div>
</div>

<!-- ===== TOUS MES PRODUITS ===== -->
<div id="tous-produits" class="pnl">
<div class="shop">
<h2>üì¶ Mes produits</h2>
<p class="mr-sub">Votre catalogue personnel. Les nouveaux produits arrivent dans ¬´ ‚è≥ √Ä ajouter ¬ª ‚Äî confirmez ceux que vous voulez garder.</p>
<div class="tp-bar">
  <input type="search" id="tp-search" class="mr-search-input" placeholder="üîç Rechercher un produit‚Ä¶" oninput="afficherTousProduits()">
</div>
<div class="tp-filtres">
  <button class="tp-filtre tp-filtre-ajouter" data-rayon="__ajouter__" onclick="selFiltreTP(this)">‚è≥ √Ä ajouter <span id="tp-ajouter-count" class="tp-badge"></span></button>
  <button class="tp-filtre on" data-rayon="" onclick="selFiltreTP(this)">Tous</button>
  <button class="tp-filtre" data-rayon="legumes" onclick="selFiltreTP(this)">ü•¨ L√©gumes</button>
  <button class="tp-filtre" data-rayon="fruits" onclick="selFiltreTP(this)">üçé Fruits</button>
  <button class="tp-filtre" data-rayon="viandes" onclick="selFiltreTP(this)">ü•© Viandes</button>
  <button class="tp-filtre" data-rayon="laitier" onclick="selFiltreTP(this)">ü•ö Laitier</button>
  <button class="tp-filtre" data-rayon="feculents" onclick="selFiltreTP(this)">üåæ F√©culents</button>
  <button class="tp-filtre" data-rayon="epicerie" onclick="selFiltreTP(this)">ü´ô √âpicerie</button>
  <button class="tp-filtre" data-rayon="boulangerie" onclick="selFiltreTP(this)">üçû Boulangerie</button>
  <button class="tp-filtre" data-rayon="herbes" onclick="selFiltreTP(this)">üåø Herbes</button>
  <button class="tp-filtre" data-rayon="oleagineux" onclick="selFiltreTP(this)">ü•ú Ol√©agineux</button>
  <button class="tp-filtre" data-rayon="traiteur" onclick="selFiltreTP(this)">ü´ï Traiteur</button>
  <button class="tp-filtre" data-rayon="boissons" onclick="selFiltreTP(this)">ü•§ Boissons</button>
  <button class="tp-filtre" data-rayon="divers" onclick="selFiltreTP(this)">üè∑Ô∏è Divers</button>
</div>
<div id="tp-liste">
  <p class="mr-empty">Aucun produit enregistr√©. Ajoutez des produits manuellement via l'onglet Courses ‚Äî ils seront automatiquement m√©moris√©s ici.</p>
</div>
</div>
</div>

<div class="modal-overlay" id="recette-modal">
<div class="modal">
  <img id="modal-img" class="modal-img" src="" alt="" style="display:none" onerror="this.style.display='none'">
  <div class="modal-head">
    <h2 id="modal-titre"></h2>
    <button class="modal-close" onclick="fermerModal()">‚úï</button>
  </div>
  <div id="modal-infos" style="display:none">
    <h4>Infos pratiques</h4>
    <div class="rmeta" id="modal-meta"></div>
  </div>
  <div id="modal-url"></div>
  <h4>Ingr√©dients</h4>
  <ul id="modal-ingredients"></ul>
  <h4>Pr√©paration</h4>
  <ol id="modal-etapes"></ol>
  <div id="modal-astuces-wrap" style="display:none">
    <div class="modal-astuces-box">
      <h4>üí° Astuces & conseils</h4>
      <ul id="modal-astuces"></ul>
    </div>
  </div>
  <div id="modal-sante-wrap" style="display:none">
    <div class="modal-sante-box">
      <h4>ü´Ä Infos sant√© & nutrition</h4>
      <ul id="modal-sante"></ul>
    </div>
  </div>
  <div class="modal-actions">
    <button class="btn-accept" onclick="accepterRecette()">‚úì Adopter cette recette</button>
    <button class="btn-reject" onclick="chercherAutre()">‚Ü∫ En chercher une autre</button>
  </div>
</div>
</div>
</div>

<script>
var J=[
{id:0},{id:1},{id:2},{id:3},{id:4},{id:5},{id:6}
];
var SERVICE_ORDER = {'entr√©e':1,'plat principal':2,'accompagnement':3,'dessert':4,'go√ªter':5};
function sortDI(arr) {
  if (!arr) return arr;
  var a = Array.isArray(arr) ? arr : Object.values(arr).filter(Boolean);
  return a.slice().sort(function(a,b){ return (SERVICE_ORDER[a.type]||99)-(SERVICE_ORDER[b.type]||99); });
}
function toDateStr(d){var y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return y+'-'+m+'-'+dd;}
(function() {
  var today = new Date();
  var joursNomsFr = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
  var moisFr = ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];
  var moisCourt = ['jan.','f√©v.','mars','avr.','mai','juin','juil.','ao√ªt','sept.','oct.','nov.','d√©c.'];
  for (var i = 0; i < 7; i++) {
    var d = new Date(today); d.setDate(today.getDate() + i);
    J[i].nom = joursNomsFr[d.getDay()] + ' ' + d.getDate() + ' ' + moisFr[d.getMonth()];
    J[i].date = toDateStr(d);
  }
  var fin = new Date(today); fin.setDate(today.getDate() + 6);
  var el = document.getElementById('wk-label');
  if (el) el.textContent = 'üìÖ ' + joursNomsFr[today.getDay()] + ' ' + today.getDate() + ' ' + moisCourt[today.getMonth()] + ' ‚Üí ' + joursNomsFr[fin.getDay()] + ' ' + fin.getDate() + ' ' + moisCourt[fin.getMonth()] + ' ' + fin.getFullYear();
})();
function rW(){
var g=document.getElementById('weekgrid');g.innerHTML='';
J.forEach(function(j,i){
g.innerHTML+=
'<div class="day" id="day-'+i+'">' +
'<h3>'+j.nom+'</h3>'+
'<div class="meal"><div class="ml">‚òÄÔ∏è Petit-d√©jeuner</div><div class="mc">'+(j.pdj||'')+'</div></div>'+
'<div class="meal"><div class="ml">ü•ó Midi</div><div class="mc">'+(j.col||'')+'</div></div>'+
(j.gou ? '<div class="meal meal-gou"><div class="ml">‚òï Go√ªter<button class="btn-del-service" onclick="event.stopPropagation();supprimerGouteur('+i+')" title="Supprimer le go√ªter">‚úï</button></div><div class="mc">'+j.gou+'</div></div>' : '') +
'<div class="meal meal-din" onclick="goRecette('+i+')">' +
'<div class="ml din-ml">üçΩÔ∏è D√Æner' +
'<span class="din-actions" onclick="event.stopPropagation()">' +
'<button class="din-btn" onclick="sauvegarderRecetteDiner('+i+')" title="Sauvegarder dans Mes recettes">Ôºã</button>' +
'<button class="din-btn" data-swap-idx="'+i+'" onclick="changerRecette('+i+',this)" title="Autre recette">‚Ü∫</button>' +
'<span class="din-handle" onclick="selectSwap('+i+')" title="Intervertir ce d√Æner">‚†ø</span>' +
'</span></div>' +
'<div class="mc">' +
(j.dinerItems && j.dinerItems.length
  ? sortDI(j.dinerItems).map(function(it){
      var lab=it.type==='entr√©e'?'Entr√©e':it.type==='dessert'?'Dessert':it.type==='accompagnement'?'Accomp.':it.type==='go√ªter'?'Go√ªter':'Plat';
      return '<div class="din-line"><span class="din-type">'+lab+'</span>'+it.nom+'<button class="btn-del-service" onclick="event.stopPropagation();supprimerService('+i+',\''+it.type+'\')" title="Supprimer ce service">‚úï</button></div>';
    }).join('')
  : j.din||'') +
'</div>' +
'</div>' +
'</div>';
});
}
rW();

function tab(id,btn){
document.querySelectorAll('.pnl').forEach(function(p){p.classList.remove('on')});
document.querySelectorAll('.tabs button').forEach(function(b){b.classList.remove('on')});
document.getElementById(id).classList.add('on');btn.classList.add('on');
}
function sTo(id){var e=document.getElementById(id);if(e)e.scrollIntoView({behavior:'smooth',block:'start'});}

function mC(){
  document.querySelectorAll('#liste-principale .scat').forEach(function(cat){
    var hasItems=cat.querySelector('.sitem')!==null;
    cat.style.display=hasItems?'':'none';
  });
}
function bascule(cb){
var it=cb.closest('.sitem');var cd=document.getElementById('caddie');
if(cb.checked){
var em=cd.querySelector('.caddie-empty');if(em)em.remove();
var cl=it.cloneNode(true);cl.querySelector('input').checked=true;
cl.querySelector('input').onchange=function(){deb(this)};
cd.appendChild(cl);it.style.display='none';
if(db)db.ref('courses/coches/'+fbKey(it.querySelector('.sn').textContent)).set(true);
}mC();
}
function deb(cb){
var it=cb.closest('.sitem');var nm=it.querySelector('.sn').textContent;
var ajoutesKey=it.dataset.ajoutesKey||'';
if(ajoutesKey){
  // Produit ajout√© manuellement ‚Üí supprimer du DOM et de Firebase (1 seul update atomique)
  document.querySelectorAll('#liste-principale .sitem').forEach(function(o){if(o.querySelector('.sn').textContent===nm)o.remove();});
  if(db){var upd={};upd['coches/'+fbKey(nm)]=null;upd['ajoutes/'+ajoutesKey]=null;db.ref('courses').update(upd);}
}else{
  // Ingr√©dient recette ‚Üí restaurer dans la liste principale
  document.querySelectorAll('#liste-principale .sitem').forEach(function(o){
    if(o.querySelector('.sn').textContent===nm&&o.style.display==='none'){o.style.display='';o.querySelector('input').checked=false;}
  });
  if(db)db.ref('courses/coches/'+fbKey(nm)).remove();
}
it.remove();
var cd=document.getElementById('caddie');
if(!cd.querySelector('.sitem'))cd.innerHTML='<p class="caddie-empty">Cochez les produits pour les ajouter ici.</p>';
mC();
}
function viderCaddie(){
  var cd=document.getElementById('caddie');
  cd.querySelectorAll('.sitem').forEach(function(it){
    var nm=it.querySelector('.sn').textContent;
    var ajoutesKey=it.dataset.ajoutesKey||'';
    if(ajoutesKey){
      // Produit ajout√© manuellement ‚Üí supprimer du DOM et de Firebase (1 seul update atomique)
      document.querySelectorAll('#liste-principale .sitem').forEach(function(o){if(o.querySelector('.sn').textContent===nm)o.remove();});
      if(db){var upd={};upd['coches/'+fbKey(nm)]=null;upd['ajoutes/'+ajoutesKey]=null;db.ref('courses').update(upd);}
    }else{
      // Ingr√©dient recette ‚Üí restaurer dans la liste principale
      document.querySelectorAll('#liste-principale .sitem').forEach(function(o){
        if(o.querySelector('.sn').textContent===nm&&o.style.display==='none'){o.style.display='';o.querySelector('input').checked=false;}
      });
      if(db)db.ref('courses/coches/'+fbKey(nm)).remove();
    }
    it.remove();
  });
  if(!cd.querySelector('.sitem'))cd.innerHTML='<p class="caddie-empty">Cochez les produits pour les ajouter ici.</p>';
  mC();
}
function ajP(){
var n=document.getElementById('add-nom').value.trim();var r=document.getElementById('add-rayon').value;
if(!n)return;var c=document.querySelector('.si[data-cat="'+r+'"]');if(!c)return;
var ph=c.closest('.scat').querySelector('.ph');if(ph)ph.remove();
var l=document.createElement('label');l.className='sitem';
l.innerHTML='<input type="checkbox" onchange="bascule(this)"><span class="sn">'+n+'</span><span class="sr">Ajout√© manuellement</span>';
c.appendChild(l);document.getElementById('add-nom').value='';
if(db){var aRef=db.ref('courses/ajoutes').push({nom:n,rayon:r});l.dataset.ajoutesKey=aRef.key;}
// M√©moriser dans "Tous mes produits" si pas d√©j√† pr√©sent
var dejaDansProduits=produitsHabituels.some(function(p){return p.nom.toLowerCase()===n.toLowerCase();});
if(!dejaDansProduits&&db)db.ref('produits_habituels').push({nom:n,rayon:r,a_ajouter:true});
mC();
}
mC();
function goRecette(idx){
  var btn=document.querySelectorAll('.tabs button')[1];
  tab('recettes',btn);
  var recipeDiv=document.getElementById('recipe-'+idx);
  if(recipeDiv){
    if(J[idx]&&((J[idx].dinerItems&&J[idx].dinerItems.length>0)||J[idx].recetteGou)){
      recipeDiv.innerHTML=buildMultiRecipeDiv(idx);initIngredients();
    }else if(J[idx]&&J[idx].recette){
      recipeDiv.innerHTML=buildRecipeDiv(idx,J[idx].recette);initIngredients();
    }else{
      recipeDiv.innerHTML='<button class="btn-back" onclick="goMenu()">‚Üê Retour au menu</button><p style="color:var(--txt2);text-align:center;margin:30px 0;font-size:.9rem">Aucun d√Æner planifi√© pour ce soir.</p>';
    }
    if(ingredientsFirebase)appliquerIngredientsFirebase(ingredientsFirebase);
  }
  if(recipeDiv)recipeDiv.scrollIntoView({behavior:'instant',block:'start'});
}
function goMenu(){
  var btn=document.querySelector('.tabs button');
  tab('apercu',btn);
}
initIngredients();
document.getElementById('chat-input').onkeydown = function(e){
  if(e.key==='Enter' && !e.shiftKey){e.preventDefault();envoyerChat();}
};
document.getElementById('chat-input').oninput = function(){
  this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px';
};

// ===== PHASE 5 ‚Äî MODIFICATION D'INGR√âDIENT =====
var ingCounter = 0;
var ingData = {};

function initIngredients() {
  document.querySelectorAll('.recipe ul li').forEach(function(li) {
    li.classList.add('ing-item');
    li.onclick = function() { editerIngredient(this); };
  });
  document.querySelectorAll('.recipe h4').forEach(function(h4) {
    if (h4.textContent.trim() === 'Ingr√©dients' && !h4.nextElementSibling.classList.contains('ing-hint')) {
      var hint = document.createElement('p');
      hint.className = 'ing-hint';
      hint.textContent = '‚úèÔ∏è Cliquez sur un ingr√©dient pour le modifier';
      h4.parentNode.insertBefore(hint, h4.nextElementSibling);
    }
  });
}

function editerIngredient(li) {
  if (li.dataset.editing) return;
  var id = 'ing-' + (++ingCounter);
  li.id = id;
  ingData[id] = li.textContent.trim();
  li.dataset.editing = '1';
  li.classList.remove('ing-item');
  li.onclick = null;

  var opts = [
    ['legumes','ü•¨ L√©gumes'],['fruits','üçé Fruits'],['viandes','ü•© Viandes'],
    ['laitier','ü•ö Laitier'],['feculents','üåæ F√©culents'],['epicerie','ü´ô √âpicerie'],
    ['herbes','üåø Herbes'],['oleagineux','ü•ú Ol√©agineux'],['boulangerie','üçû Boulangerie']
  ].map(function(o){return '<option value="'+o[0]+'">'+o[1]+'</option>';}).join('');

  li.innerHTML = '<div class="ing-edit" onclick="event.stopPropagation()">'+
    '<input id="inp-'+id+'" type="text" onkeydown="ingKey(event,\''+id+'\')">'+
    '<select id="sel-'+id+'">'+opts+'</select>'+
    '<button class="ing-btn-ok" onclick="ingOk(\''+id+'\');return false;">‚úì</button>'+
    '<button class="ing-btn-cancel" onclick="ingAnnuler(\''+id+'\');return false;">‚úï</button>'+
  '</div>';

  var input = document.getElementById('inp-'+id);
  input.value = ingData[id];
  input.focus();
  input.select();
  // Pr√©-s√©lectionner le rayon depuis la liste de courses
  var selEl = document.getElementById('sel-'+id);
  var ancienText = ingData[id].toLowerCase();
  document.querySelectorAll('#liste-principale .sitem .sn').forEach(function(sn) {
    if (sn.textContent.toLowerCase() === ancienText) {
      var si = sn.closest('.si');
      if (si && si.dataset.cat) selEl.value = si.dataset.cat;
    }
  });
}

function ingKey(e, id) {
  if (e.key === 'Enter') ingOk(id);
  if (e.key === 'Escape') ingAnnuler(id);
}

function ingOk(id) {
  var li = document.getElementById(id);
  if (!li) return;
  var nouveau = document.getElementById('inp-'+id).value.trim();
  var rayon = document.getElementById('sel-'+id).value;
  var ancien = ingData[id];
  delete ingData[id];
  delete li.dataset.editing;

  if (!nouveau) { ingAnnuler(id); return; }

  li.textContent = nouveau;
  li.classList.add('ing-item');
  if (nouveau !== ancien) li.classList.add('ing-changed');
  li.onclick = function() { editerIngredient(this); };

  if (nouveau === ancien) return;

  // Sauvegarder la modification dans Firebase
  var recipeDiv = li.closest('.recipe');
  if (recipeDiv && db) {
    var recipeIdx = recipeDiv.id.replace('recipe-', '');
    db.ref('ingredients/' + recipeIdx + '/' + fbKey(ancien)).set({original: ancien, nouveau: nouveau});
  }

  // Mettre √† jour l'ingr√©dient en place dans la liste de courses
  var mots = ancien.toLowerCase().split(' ').filter(function(m){return m.length > 3;});
  var updated = false;
  document.querySelectorAll('#liste-principale .sitem').forEach(function(label) {
    var sn = label.querySelector('.sn');
    if (!sn) return;
    var nm = sn.textContent.toLowerCase();
    if (mots.length > 0 && mots.some(function(m){return nm.includes(m);})) {
      sn.textContent = nouveau;
      label.title = '';
      label.style.opacity = '';
      updated = true;
    }
  });
  // Si non trouv√© dans les courses, ajouter comme nouvel item
  if (!updated) {
    var c = document.querySelector('.si[data-cat="'+rayon+'"]');
    if (c) {
      var ph = c.closest('.scat').querySelector('.ph');
      if (ph) ph.remove();
      var l = document.createElement('label');
      l.className = 'sitem';
      l.innerHTML = '<input type="checkbox" onchange="bascule(this)"><span class="sn">'+nouveau+'</span><span class="sr">‚úèÔ∏è '+ancien+' ‚Üí '+nouveau+'</span>';
      c.appendChild(l);
    }
  }
  mC();
}

function ingAnnuler(id) {
  var li = document.getElementById(id);
  if (!li) return;
  var ancien = ingData[id] || '';
  delete ingData[id];
  delete li.dataset.editing;
  li.textContent = ancien;
  li.classList.add('ing-item');
  li.onclick = function() { editerIngredient(this); };
}

// ===== SITES RESSOURCES =====
var sitesExtra = [];

// ===== ONGLET SOURCES =====
var SITES_DEFAUT = [
  { url: 'https://cuisinerigbas.com', desc: 'Cuisine IG bas quotidienne, plats mijot√©s, terroir adapt√©' },
  { url: 'https://www.lanutrition.fr/cuisine-et-recettes/recettes-sante/index-glycemique-bas', desc: 'Recettes IG bas valid√©es scientifiquement, l√©gumineuses, c√©r√©ales compl√®tes' },
  { url: 'https://www.santemagazine.fr', desc: 'Menus anti-cholest√©rol cuisine familiale fran√ßaise, huile colza/noix' },
  { url: 'https://www.primevere.com/idees-recettes/plats/', desc: 'Plats terroir/famille all√©g√©s cholest√©rol (pizzas, gratins, parmentier, falafels)' },
  { url: 'https://bienvenuechezvero.fr', desc: 'Blog IG bas familial, l√©gumineuses, bons gras, f√©culents complets' },
  { url: 'https://saines-gourmandises.fr', desc: 'Cuisine terroir gourmande IG bas, tartes sal√©es, gratins, pains complets' },
  { url: 'http://www.adoptelacuisineigbas.com', desc: 'Recettes quotidiennes IG bas, l√©gumes, l√©gumineuses, farines compl√®tes' },
  { url: 'https://jow.fr', desc: 'Recettes et conseils IG bas, f√©culents complets, association prot√©ines/fibres/graisses' },
  { url: 'https://www.cuisineaz.com', desc: 'Recettes anti-cholest√©rol et IG bas gourmandes, poulet, l√©gumes, f√©culents' },
  { url: 'https://www.marieclaire.fr/cuisine', desc: 'Recettes anti-cholest√©rol cuisine fran√ßaise et m√©diterran√©enne' },
  { url: 'https://www.passionnutrition.com', desc: 'Di√©t√©ticienne IG bas, recettes cholest√©rol, association fibres+prot√©ines+bonnes graisses' },
  { url: 'https://www.isabellehuot.com', desc: 'Recettes sant√© cholest√©rol, petits-d√©jeuners prot√©in√©s, collations crues' },
  { url: 'https://lacerisesurlemaillot.fr', desc: 'Cuisine familiale IG bas, terroir fran√ßais, alternatives l√©g√®res' },
  { url: 'https://www.750g.com', desc: 'Recettes saines adaptables, large base, filtrage possible IG bas' }
];

function nomDomaine(url) {
  try { return new URL(url).hostname.replace('www.', ''); } catch(e) { return url; }
}

function afficherSourcesDefaut() {
  var el = document.getElementById('sources-defaut');
  if (!el) return;
  el.innerHTML = SITES_DEFAUT.map(function(s) {
    return '<div class="source-card">' +
      '<div class="source-card-body">' +
      '<a href="'+s.url+'" target="_blank" rel="noopener">'+nomDomaine(s.url)+'</a>' +
      '<div class="source-card-desc">'+s.desc+'</div>' +
      '</div></div>';
  }).join('');
}

function afficherSourcesPerso() {
  var el = document.getElementById('sources-perso');
  var empty = document.getElementById('sources-perso-empty');
  if (!el) return;
  var cards = sitesExtra.map(function(s, i) {
    return '<div class="source-card">' +
      '<div class="source-card-body">' +
      '<a href="'+(s.url.startsWith('http') ? s.url : 'https://'+s.url)+'" target="_blank" rel="noopener">'+nomDomaine(s.url)+'</a>' +
      '<div class="source-card-desc">'+(s.desc||'')+'</div>' +
      '</div>' +
      (s._fbKey ? '<button class="btn-del-recette" onclick="supprimerSource(\''+s._fbKey+'\')" title="Supprimer">üóë</button>' : '') +
      '</div>';
  }).join('');
  el.innerHTML = cards || '';
  if (empty) empty.style.display = sitesExtra.length ? 'none' : '';
}

function ajouterSourceManuelle() {
  var url = document.getElementById('source-url-input').value.trim();
  var desc = document.getElementById('source-desc-input').value.trim();
  if (!url) { toast('Saisis une URL ou un compte'); return; }
  var site = { url: url, desc: desc };
  sitesExtra.push(site);
  if (db) db.ref('sites_ressources').push(site);
  document.getElementById('source-url-input').value = '';
  document.getElementById('source-desc-input').value = '';
  afficherSourcesPerso();
  toast('‚úÖ Source ajout√©e !');
}

function importerRecetteUrl() {
  var url = document.getElementById('scrape-url-input').value.trim();
  if (!url) { toast('Colle une URL de recette'); return; }
  var btn = document.getElementById('btn-scrape');
  btn.textContent = '‚è≥ Analyse en cours...';
  btn.disabled = true;
  fetch('/api/scrape', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url: url })
  })
  .then(function(r){ return r.json(); })
  .then(function(data) {
    btn.textContent = 'üì• Importer cette recette';
    btn.disabled = false;
    if (data.error) { toast('‚ùå ' + data.error); return; }
    data.favoris = false;
    if (db) {
      db.ref('recettes_perso').push(data);
    } else {
      recettesPerso.push(data);
      afficherRecettesPerso();
    }
    document.getElementById('scrape-url-input').value = '';
    toast('‚úÖ ¬´ ' + data.nom + ' ¬ª ajout√©e √† Mes recettes !');
  })
  .catch(function(err) {
    btn.textContent = 'üì• Importer cette recette';
    btn.disabled = false;
    toast('‚ùå Erreur : ' + err.message);
  });
}

function supprimerSource(fbKey) {
  if (!fbKey || !db) return;
  db.ref('sites_ressources/'+fbKey).remove();
}

// ===== PHASE 8 ‚Äî PROFIL DYNAMIQUE + RECETTES PERSO =====
var profilExtra = {};
var recettesPerso = [];
var _rmp = {}; // cache recettes semaine pour la modale (recipe modal pool)
var recettesPersoMap = {}; // lookup rapide key ‚Üí recette

// Convertit n'importe quoi en tableau (string ‚Üí split newlines, objet Firebase ‚Üí Object.values)
function toArr(x) {
  if (!x) return [];
  if (Array.isArray(x)) return x;
  if (typeof x === 'string') return x.split('\n').map(function(s){return s.trim();}).filter(Boolean);
  return Object.values(x);
}

// ===== PHASE 6 ‚Äî NUTRICOACH CHAT =====
var chatHisto = [];

function envoyerChat() {
  var input = document.getElementById('chat-input');
  var msg = input.value.trim();
  if (!msg) return;
  ajouterMsg('user', msg);
  input.value = '';
  input.style.height = 'auto';
  var btn = document.getElementById('btn-chat-send');
  btn.disabled = true;
  var typingId = afficherTyping();
  var menusCtx = J.map(function(j){return {nom:j.nom, din:j.din};});
  fetch('/api/chat', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({message:msg, historique:chatHisto, menus:menusCtx, sitesExtra:sitesExtra, profilExtra:profilExtra, recettesPerso:recettesPerso})
  })
  .then(function(r){return r.json();})
  .then(function(data){
    retirerTyping(typingId);
    btn.disabled = false;
    chatHisto.push({role:'user',content:msg});
    chatHisto.push({role:'assistant',content:data.reponse});
    if(chatHisto.length > 20) chatHisto = chatHisto.slice(-20);
    ajouterMsg('bot', data.reponse);
    if(data.action) executerActionChat(data.action);
  })
  .catch(function(){
    retirerTyping(typingId);
    btn.disabled = false;
    ajouterMsg('bot','‚ùå Erreur de connexion. R√©essayez.');
  });
}

function ajouterMsg(role, texte, type) {
  var cont = document.getElementById('chat-messages');
  var div = document.createElement('div');
  div.className = 'msg msg-' + (role==='user'?'user':'bot') + (type?' '+type:'');
  var fmt = texte
    .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
    .replace(/\*(.*?)\*/g,'<i>$1</i>')
    .replace(/\n- /g,'<br>‚Ä¢ ')
    .replace(/\n/g,'<br>');
  div.innerHTML = '<div class="msg-bubble">'+fmt+'</div>';
  cont.appendChild(div);
  cont.scrollTop = cont.scrollHeight;
}

function afficherTyping() {
  var cont = document.getElementById('chat-messages');
  var div = document.createElement('div');
  var id = 'typing-'+Date.now();
  div.id = id; div.className = 'msg msg-bot chat-typing';
  div.innerHTML = '<div class="msg-bubble">NutriCoach r√©dige‚Ä¶</div>';
  cont.appendChild(div);
  cont.scrollTop = cont.scrollHeight;
  return id;
}

function retirerTyping(id) {
  var el = document.getElementById(id);
  if(el) el.remove();
}

function executerActionChat(action) {
  if (action.type === 'remplacer_repas' && action.recette) {
    var idx = action.jour_idx;
    var r = action.recette;
    if (J[idx]) {
      // Int√®gre la recette comme "plat principal" dans dinerItems
      if (!J[idx].dinerItems) J[idx].dinerItems = [];
      var found = false;
      J[idx].dinerItems = J[idx].dinerItems.map(function(it) {
        if (it.type === 'plat principal') { found = true; return {type:'plat principal', nom:r.nom, recette:r}; }
        return it;
      });
      if (!found) J[idx].dinerItems.push({type:'plat principal', nom:r.nom, recette:r});
      recomputeDin(idx);
      rW();
      var recipeDiv = document.getElementById('recipe-'+idx);
      if (recipeDiv) { recipeDiv.innerHTML = buildMultiRecipeDiv(idx); initIngredients(); }
      rebuilderListeRecettes(J);
      if(db) db.ref('menus/'+J[idx].date).set({nom:J[idx].nom, din:J[idx].din, dn:J[idx].dn, recette:J[idx].recette||null, dinerItems:J[idx].dinerItems});
      ajouterMsg('bot','‚úÖ Planning mis √† jour !','msg-action');
    }
  } else if (action.type === 'generer_semaine') {
    genererSemaine(true);
  } else if (action.type === 'ajouter_site' && action.url) {
    var site = {url: action.url, desc: action.desc || ''};
    sitesExtra.push(site);
    if(db) db.ref('sites_ressources').push(site);
    ajouterMsg('bot','‚úÖ Site ajout√© √† vos r√©f√©rences : '+action.url,'msg-action');
  } else if (action.type === 'ajouter_courses' && action.produits) {
    action.produits.forEach(function(item){
      var c=document.querySelector('.si[data-cat="'+item.rayon+'"]');
      var l=null;
      if(c){
        var ph=c.closest('.scat').querySelector('.ph');if(ph)ph.remove();
        l=document.createElement('label');l.className='sitem';
        l.innerHTML='<input type="checkbox" onchange="bascule(this)"><span class="sn">'+item.nom+'</span><span class="sr">üí¨ Ajout√© par NutriCoach</span>';
        c.appendChild(l);
      }
      if(db){var ncRef=db.ref('courses/ajoutes').push({nom:item.nom,rayon:item.rayon});if(l)l.dataset.ajoutesKey=ncRef.key;}
    });
    mC();
    ajouterMsg('bot','‚úÖ '+action.produits.length+' produit(s) ajout√©(s) √† votre liste !','msg-action');
  } else if (action.type === 'supprimer_recette' && action.nom) {
    var nomCherche = action.nom.toLowerCase();
    var idx = -1;
    recettesPerso.forEach(function(r, i) {
      if (r.nom.toLowerCase().includes(nomCherche) || nomCherche.includes(r.nom.toLowerCase())) idx = i;
    });
    if (idx !== -1) {
      var r = recettesPerso[idx];
      if (r._fbKey && db) {
        db.ref('recettes_perso/' + r._fbKey).remove();
      } else {
        recettesPerso.splice(idx, 1);
        afficherRecettesPerso();
      }
      ajouterMsg('bot', '‚úÖ Recette ¬´ ' + r.nom + ' ¬ª supprim√©e.', 'msg-action');
    } else {
      ajouterMsg('bot', '‚ö†Ô∏è Je ne trouve pas cette recette dans ta liste.');
    }
  } else if (action.type === 'ajouter_tag' && action.nom) {
    var foundR = null;
    recettesPerso.forEach(function(r) {
      if (r.nom.toLowerCase().includes(action.nom.toLowerCase())) foundR = r;
    });
    if (foundR) {
      foundR.tags = action.tags || [];
      var kR = foundR._fbKey || ('local-'+foundR.nom);
      if (foundR._fbKey && db) db.ref('recettes_perso/'+foundR._fbKey+'/tags').set(foundR.tags);
      renderCardTags(kR);
      buildTagFilterPanel();
      ajouterMsg('bot', '‚úÖ Tags mis √† jour pour ¬´ '+foundR.nom+' ¬ª : '+foundR.tags.join(', ')+'.', 'msg-action');
    } else {
      ajouterMsg('bot', '‚ö†Ô∏è Je ne trouve pas cette recette dans ta liste.');
    }
  } else if (action.type === 'modifier_profil' && action.champ && action.valeur) {
    var champsValides = ['aime','naime_pas','restrictions','notes_sante','notes_nutrition'];
    if (champsValides.indexOf(action.champ) !== -1) {
      if (!profilExtra[action.champ]) profilExtra[action.champ] = [];
      profilExtra[action.champ].push(action.valeur);
      if (db) db.ref('profil/' + action.champ).set(profilExtra[action.champ]);
      ajouterMsg('bot','‚úÖ Profil mis √† jour : ¬´ '+action.valeur+' ¬ª ajout√© dans "'+action.champ+'"','msg-action');
    }
  }
}

// ===== PHASE 7 ‚Äî G√âN√âRER LA SEMAINE =====
function genererSemaine(skipConfirm) {
  if (!skipConfirm && !confirm('G√©n√©rer de nouveaux menus pour les 7 prochains jours ?\nLes menus actuels seront remplac√©s.')) return;
  var btn = document.getElementById('btn-gen');
  btn.disabled = true;
  btn.textContent = '‚è≥ G√©n√©ration en cours‚Ä¶';

  var today = new Date();
  var joursNomsFr = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
  var moisFr = ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];

  var joursDates = [];
  for (var i = 0; i < 7; i++) {
    var d = new Date(today); d.setDate(today.getDate() + i);
    joursDates.push(joursNomsFr[d.getDay()] + ' ' + d.getDate());
  }
  var fin = new Date(today); fin.setDate(today.getDate() + 6);
  var dateDebut = today.getDate() + ' ' + moisFr[today.getMonth()] + ' ' + today.getFullYear();
  var dateFin = fin.getDate() + ' ' + moisFr[fin.getMonth()] + ' ' + fin.getFullYear();

  fetch('/api/menus', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({jours: joursDates, dateDebut: dateDebut, dateFin: dateFin, sitesExtra: sitesExtra, profilExtra: profilExtra, recettesPerso: recettesPerso})
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    appliquerNouveauxMenus(data);
    btn.disabled = false;
    btn.textContent = 'üóìÔ∏è G√©n√©rer la semaine';
  })
  .catch(function() {
    alert('Erreur lors de la g√©n√©ration. R√©essayez.');
    btn.disabled = false;
    btn.textContent = 'üóìÔ∏è G√©n√©rer la semaine';
  });
}

function appliquerNouveauxMenus(data) {
  // 1. Mettre √† jour le tableau J
  data.jours.forEach(function(jour, i) {
    if (J[i]) {
      J[i].nom = jour.nom;
      J[i].pdj = jour.pdj;
      J[i].col = jour.col;
      J[i].din = jour.din;
      J[i].dn = jour.dn;
      J[i].recette = jour.recette;
      J[i].dinerItems = jour.recette ? [{type:'plat principal', nom:jour.recette.nom, recette:jour.recette}] : null;
    }
  });

  // 2. Mettre √† jour le label de semaine
  if (data.semaine) {
    document.getElementById('wk-label').textContent = 'üìÖ ' + data.semaine;
  }

  // 3. Rafra√Æchir le planning
  rW();

  // 4. Reconstruire la section Recettes
  var recDiv = document.getElementById('recettes');
  recDiv.innerHTML = '';
  data.jours.forEach(function(jour, i) {
    var r = jour.recette;
    if (!r) return;
    recDiv.innerHTML += '<div class="recipe" id="recipe-'+i+'">' + buildRecipeDiv(i, r) + '</div>';
  });
  initIngredients();

  // 5. Reconstruire la liste de courses depuis J[]
  rebuilderListeRecettes(J);

  // 6. Sauvegarder dans Firebase
  if (db) {
    data.jours.forEach(function(jour, i) {
      if (J[i] && J[i].date) db.ref('menus/'+J[i].date).set({nom:jour.nom, pdj:jour.pdj, col:jour.col, din:jour.din, dn:jour.dn, recette:jour.recette||null, dinerItems:J[i].dinerItems||null});
    });
    db.ref('ingredients').remove();
    db.ref('courses/ajoutes').remove();
  }
}

// ===== PHASE 8 ‚Äî IMPORT DE FICHIERS =====
function importerFichier(input) {
  var file = input.files[0];
  if (!file) return;
  // R√©initialiser l'input pour permettre de r√©-importer le m√™me fichier
  input.value = '';

  var mimeType = file.type;
  var estTexte = mimeType === 'text/plain' || mimeType === 'text/markdown' ||
                 file.name.endsWith('.txt') || file.name.endsWith('.md');

  ajouterMsg('bot', 'üìé Analyse de ¬´ ' + file.name + ' ¬ª en cours‚Ä¶', 'chat-typing');
  var typingEl = document.getElementById('chat-messages').lastElementChild;

  var reader = new FileReader();

  reader.onload = function(e) {
    var content = e.target.result;
    fetch('/api/import', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({fileName: file.name, fileType: mimeType, content: content})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (typingEl) typingEl.remove();
      if (data.error) {
        ajouterMsg('bot', '‚ùå Erreur lors de l\'analyse : ' + data.error);
        return;
      }
      if (data.type === 'recette' && data.data) {
        var r = data.data;
        r.favoris = false;
        if (db) {
          db.ref('recettes_perso').push(r);
        } else {
          recettesPerso.push(r);
          afficherRecettesPerso();
        }
        ajouterMsg('bot', '‚úÖ Recette import√©e : **' + r.nom + '**\n' + (r.description || '') + '\n\nElle est maintenant disponible dans ¬´ Mes recettes import√©es ¬ª et NutriCoach pourra la proposer dans tes menus.', 'msg-action');
      } else if (data.type === 'note_nutrition' && data.data) {
        var n = data.data;
        var points = (n.points_cles || []);
        if (!profilExtra.notes_nutrition) profilExtra.notes_nutrition = [];
        points.forEach(function(p) { profilExtra.notes_nutrition.push(p); });
        if (db) db.ref('profil/notes_nutrition').set(profilExtra.notes_nutrition);
        ajouterMsg('bot', '‚úÖ Article analys√© : **' + n.titre + '**\n' + points.map(function(p){return '‚Ä¢ '+p;}).join('\n') + '\n\nCes notes ont √©t√© ajout√©es √† ton profil nutrition.', 'msg-action');
      } else if (data.type === 'erreur' && data.data) {
        ajouterMsg('bot', '‚ö†Ô∏è ' + data.data.message);
      } else {
        ajouterMsg('bot', '‚ö†Ô∏è Contenu non reconnu dans ce fichier.');
      }
    })
    .catch(function() {
      if (typingEl) typingEl.remove();
      ajouterMsg('bot', '‚ùå Erreur de connexion lors de l\'import. R√©essayez.');
    });
  };

  if (estTexte) {
    reader.readAsText(file, 'UTF-8');
  } else {
    reader.readAsDataURL(file);
  }
}

function afficherRecettesPerso(liste) {
  recettesPersoMap = {};
  recettesPerso.forEach(function(r) {
    recettesPersoMap[r._fbKey || ('local-'+r.nom)] = r;
  });
  var el = document.getElementById('mes-recettes-liste');
  if (!el) return;

  var show = recettesPerso.length > 0;
  var searchRow = document.getElementById('mr-search-row');
  var filtresEl = document.getElementById('mr-filtres');
  if (searchRow) searchRow.style.display = show ? '' : 'none';
  if (filtresEl) filtresEl.style.display = show ? 'flex' : 'none';
  buildTagFilterPanel();

  var srcList = liste !== undefined ? liste : recettesPerso;
  var countEl = document.getElementById('mr-count');
  if (countEl) countEl.textContent = srcList.length + '/' + recettesPerso.length + ' recette' + (recettesPerso.length > 1 ? 's' : '');

  if (!recettesPerso.length) {
    el.innerHTML = '<p class="mr-empty">Aucune recette import√©e. Allez dans l\'onglet NutriCoach et utilisez le bouton üìé pour importer une recette (texte, PDF ou photo).</p>';
    return;
  }

  var sorted = srcList.slice().sort(function(a, b) {
    if (!!b.favoris !== !!a.favoris) return b.favoris ? 1 : -1;
    return a.nom.localeCompare(b.nom, 'fr');
  });

  if (!sorted.length) {
    el.innerHTML = '<p class="mr-empty">Aucune recette ne correspond √† la recherche.</p>';
    return;
  }

  el.innerHTML = sorted.map(function(r) {
    var k = r._fbKey || ('local-'+r.nom);
    var opts = J.map(function(j, idx) {
      return '<option value="'+idx+'">'+j.nom+'</option>';
    }).join('');
    var serviceTagsList = ['entr√©e','plat principal','accompagnement','dessert','go√ªter','soupe'];
    var serviceTag = (r.tags||[]).find(function(t){ return serviceTagsList.includes(t); });
    var tags = (r.tags||[]).filter(function(t){ return !serviceTagsList.includes(t); })
                           .map(function(t){ return '<span class="tag-badge">'+t+'</span>'; }).join('');
    return '<div class="recette-card" id="rcard-'+k+'">' +
      (r.image ? '<img class="recette-card-img" src="'+r.image+'" alt="'+r.nom+'" onerror="this.style.display=\'none\'">' : '') +
      '<div class="recette-card-header">' +
        '<input type="checkbox" class="recette-card-check" id="rcheck-'+k+'" onchange="toggleRecetteJour(\''+k+'\')">' +
        '<button class="btn-fav'+(r.favoris?' active':'')+'" id="rfav-'+k+'" onclick="toggleFavori(\''+k+'\')" title="Favori">'+(r.favoris?'‚òÖ':'‚òÜ')+'</button>' +
        '<span class="recette-card-emoji">'+(r.emoji||'ü•ò')+'</span>' +
        '<span class="recette-card-nom" onclick="voirRecettePerso(\''+k+'\')" title="Voir la recette compl√®te">'+(r.nom)+'</span>' +
        '<span style="position:relative"><span class="service-tag-badge" id="rsvc-'+k+'" onclick="toggleSvcDropdown(\''+k+'\')" style="cursor:pointer">'+(serviceTag||'+ type')+' ‚ñæ</span></span>' +
        '<button class="btn-del-recette" onclick="supprimerRecettePerso(\''+k+'\')" title="Supprimer cette recette">üóë</button>' +
      '</div>' +
      (r.description ? '<div class="recette-card-desc">'+(r.description)+'</div>' : '') +
      '<div style="padding:4px 0 2px 28px;display:flex;align-items:center;flex-wrap:wrap;gap:3px;min-height:22px" id="rtags-'+k+'">' +
        tags + '<button class="tags-edit-btn" onclick="ouvrePickerTag(\''+k+'\')" title="Modifier les tags">‚úèÔ∏è</button>' +
      '</div>' +
      '<div class="recette-card-jour" id="rjour-'+k+'" style="display:none">' +
        '<label>le :</label>' +
        '<select id="rsel-'+k+'"><option value="">‚Äî Jour ‚Äî</option>'+opts+'</select>' +
      '</div>' +
      '</div>';
  }).join('');
}

function supprimerRecettePerso(k) {
  var r = recettesPersoMap[k];
  if (!r) return;
  if (!confirm('Supprimer ¬´ ' + r.nom + ' ¬ª ?')) return;
  if (r._fbKey && db) {
    db.ref('recettes_perso/' + r._fbKey).remove();
    // Le listener Firebase mettra √† jour recettesPerso + afficherRecettesPerso automatiquement
  } else {
    recettesPerso = recettesPerso.filter(function(x) { return x !== r; });
    afficherRecettesPerso();
  }
}

function toggleRecetteJour(k) {
  var cb = document.getElementById('rcheck-'+k);
  var jourDiv = document.getElementById('rjour-'+k);
  var card = document.getElementById('rcard-'+k);
  if (!cb || !jourDiv || !card) return;
  jourDiv.style.display = cb.checked ? 'flex' : 'none';
  card.classList.toggle('selected', cb.checked);
}

function buildRecipeDiv(idx, r) {
  var nom = J[idx] ? J[idx].nom : '';
  var rmKey = 'r'+idx+'_main'; _rmp[rmKey] = r;
  return '<button class="btn-back" onclick="goMenu()">‚Üê Retour au menu</button>' +
    '<div class="recipe-top"><div class="recipe-titre-wrap"><h3 class="recipe-title-link" onclick="ouvrirRecetteModal(\''+rmKey+'\')">'+(r.nom)+'</h3><button class="edit-titre-btn" onclick="event.stopPropagation();editRecetteTitre(\''+rmKey+'\',this)" title="Modifier le titre">‚úèÔ∏è</button></div><div class="r-ico">'+(r.emoji||'ü•ò')+'</div></div>' +
    '<div class="rmeta"><span><b>Pr√©pa :</b> '+(r.prepTime||'‚Äî')+'</span><span><b>Cuisson :</b> '+(r.cookTime||'‚Äî')+'</span><span><b>üìÖ</b> '+nom+'</span></div>' +
    (r.url ? '<a class="recipe-link" href="'+r.url+'" target="_blank" rel="noopener">üîó Voir la recette originale</a>' : '<span class="recipe-link" style="opacity:.5;cursor:default">üîó Source non disponible</span>') +
    '<h4>Ingr√©dients</h4>' +
    '<ul>'+toArr(r.ingredients).map(function(ing){return '<li>'+ing+'</li>';}).join('')+'</ul>' +
    '<h4>Pr√©paration</h4>' +
    '<ol>'+toArr(r.etapes).map(function(e,si){return '<li class="etape-item" onclick="editEtape(this,\''+rmKey+'\','+si+')">'+e+'</li>';}).join('')+'</ol>';
}

// Ajoute un item recette dans la liste de courses (avec data-recipe pour tracking)
function addCourseItem(nom, rayon, label, recipeKey, jourIdx) {
  var existe = false;
  document.querySelectorAll('#liste-principale .sitem .sn').forEach(function(el) {
    if (el.textContent.toLowerCase() === nom.toLowerCase()) existe = true;
  });
  if (existe) return;
  var c = document.querySelector('.si[data-cat="'+rayon+'"]');
  if (!c) c = document.querySelector('.si[data-cat="epicerie"]');
  if (!c) return;
  var ph = c.closest('.scat').querySelector('.ph');
  if (ph) ph.remove();
  var l = document.createElement('label');
  l.className = 'sitem';
  l.dataset.recipe = recipeKey;
  l.dataset.jourIdx = String(jourIdx);
  l.innerHTML = '<input type="checkbox" onchange="bascule(this)"><span class="sn">'+nom+'</span><span class="sr">'+label+'</span>';
  c.appendChild(l);
}

// Reconstruit tous les items recettes dans la liste de courses depuis J[] ou data.menus
function rebuilderListeRecettes(menus) {
  document.querySelectorAll('#liste-principale .sitem[data-recipe]').forEach(function(l){ l.remove(); });
  var entries = Array.isArray(menus)
    ? menus.map(function(m, i){ return {idx:i, m:m}; })
    : Object.keys(menus || {}).map(function(k){ return {idx:parseInt(k), m:menus[k]}; });
  entries.forEach(function(entry) {
    var idx = entry.idx;
    var m = entry.m;
    if (!m) return;
    var jourNom = m.nom || 'Jour ' + idx;
    var abbrev = jourNom.substring(0, 3); // "Sam", "Dim", "Lun"...
    function truncNom(s) { if(!s||s.length<=16)return s||''; var cut=s.lastIndexOf(' ',15); return s.substring(0,cut>0?cut:15)+'‚Ä¶'; }
    // dinerItems (multi-services)
    var rawDI = m.dinerItems || null;
    var dinerItems = rawDI ? (Array.isArray(rawDI) ? rawDI : Object.values(rawDI).filter(Boolean)) : null;
    if (dinerItems && dinerItems.length) {
      dinerItems.forEach(function(dit) {
        if (!dit.recette) return;
        var labelDit = abbrev + ' ‚Äî ' + truncNom(dit.nom);
        var ings = dit.recette.coursesAAjouter
          || toArr(dit.recette.ingredients || []).map(function(ing){ return {nom:ing, rayon:devinerRayon(ing)}; });
        ings.forEach(function(item) { addCourseItem(item.nom, item.rayon, labelDit, dit.nom, idx); });
      });
    } else if (m.recette && m.recette.coursesAAjouter) {
      // Recette API (sans dinerItems)
      var labelRec = abbrev + ' ‚Äî ' + truncNom(m.recette.nom);
      m.recette.coursesAAjouter.forEach(function(item) { addCourseItem(item.nom, item.rayon, labelRec, m.recette.nom, idx); });
    }
    // Go√ªter
    if (m.recetteGou && m.gou) {
      var labelGou = abbrev + ' ‚Äî ' + truncNom(m.gou);
      var gouIngs = m.recetteGou.coursesAAjouter
        || toArr(m.recetteGou.ingredients || []).map(function(ing){ return {nom:ing, rayon:devinerRayon(ing)}; });
      gouIngs.forEach(function(item) { addCourseItem(item.nom, item.rayon, labelGou, m.gou, idx); });
    }
  });
  mC();
}

function devinerRayon(ing) {
  var s = ing.toLowerCase();
  var map = [
    ['legumes',    ['carotte','courgette','aubergine','poivron','tomate','poireau','oignon','√©chalote','ail','pomme de terre','patate','brocoli','chou','√©pinard','salade','laitue','c√©leri','navet','betterave','radis','fenouil','artichaut','asperge','haricot vert','petits pois','concombre','champignon','courge','potiron','potimarron','roquette','blette','endive','m√¢che','cresson','l√©gume']],
    ['fruits',     ['pomme','poire','orange','citron','mandarine','banane','fraise','framboise','myrtille','cerise','p√™che','abricot','prune','mangue','ananas','kiwi','raisin','melon','past√®que','figue','grenade','avocat']],
    ['viandes',    ['poulet','dinde','canard','pintade','lapin','b≈ìuf','veau','agneau','porc','cochon','lardons','jambon','saucisse','merguez','chorizo','steak','escalope','c√¥telette','filet','volaille','gibier','viande','blanc de poulet']],
    ['traiteur',   ['saumon','thon','cabillaud','maquereau','truite','sardine','bar','dorade','crevette','moule','hu√Ætre','poulpe','calamar','anchois','poisson','fruits de mer']],
    ['laitier',    ['lait','cr√®me fra√Æche','cr√®me','yaourt','beurre','fromage','mozzarella','parmesan','emmental','gruy√®re','ricotta','feta','mascarpone','cheddar','kefir','camembert','comt√©']],
    ['feculents',  ['p√¢tes','pasta','riz','semoule','boulgour','quinoa','avoine','√©peautre','millet','polenta','vermicelle','nouille','lasagne','gnocchi','f√©cule']],
    ['boulangerie',['pain','baguette','brioche','farine','levure']],
    ['herbes',     ['basilic','persil','coriandre','thym','romarin','laurier','menthe','ciboulette','origan','cumin','curry','paprika','curcuma','cannelle','gingembre','ras el hanout','safran','cardamome','√©pice']],
    ['oleagineux', ['noix','amande','noisette','pistache','cajou','graine','s√©same','lin','tournesol','chia','cacahu√®te','tahini']],
    ['epicerie',   ['huile','vinaigre','sucre','bouillon','cube','miel','conserve','pois chiche','lentille','haricot','f√®ve','lait de coco','concentr√©','moutarde','sauce soja','sauce tomate','cornichon']]
  ];
  for (var i = 0; i < map.length; i++) {
    var kws = map[i][1];
    if (kws.some(function(k){return s.includes(k);})) return map[i][0];
  }
  return 'epicerie';
}

function ajouterProduit(nom, rayon, label) {
  if (!nom) return;
  var nomLow = nom.toLowerCase();
  var existe = false;
  document.querySelectorAll('#liste-principale .sitem .sn').forEach(function(el) {
    if (el.textContent.toLowerCase() === nomLow) existe = true;
  });
  if (existe) return;
  var c = document.querySelector('.si[data-cat="'+rayon+'"]');
  if (!c) c = document.querySelector('.si[data-cat="epicerie"]');
  if (!c) return;
  var ph = c.closest('.scat').querySelector('.ph');
  if (ph) ph.remove();
  var l = document.createElement('label');
  l.className = 'sitem';
  l.innerHTML = '<input type="checkbox" onchange="bascule(this)"><span class="sn">'+nom+'</span><span class="sr">'+(label||'üçΩÔ∏è Recette semaine')+'</span>';
  c.appendChild(l);
  mC();
}

function buildMultiRecipeDiv(idx) {
  var dayNom = J[idx] ? J[idx].nom : '';
  var html = '<button class="btn-back" onclick="goMenu()">‚Üê Retour au menu</button>';
  var items = sortDI(J[idx] && J[idx].dinerItems ? J[idx].dinerItems : []);
  var typeLabels = {'entr√©e':'ü•ó Entr√©e','plat principal':'üçΩÔ∏è Plat principal','accompagnement':'ü•¶ Accompagnement','dessert':'üçÆ Dessert','go√ªter':'‚òï Go√ªter'};
  items.forEach(function(item, diIdx) {
    var r = item.recette;
    if (!r) return;
    var tl = typeLabels[item.type] || item.type;
    var rmKey = 'r'+idx+'_'+diIdx; _rmp[rmKey] = r;
    html += '<div style="margin:20px 0 8px"><span class="service-tag-badge lg">'+tl+'</span></div>' +
      '<div class="recipe-top"><div class="recipe-titre-wrap"><h3 class="recipe-title-link" onclick="ouvrirRecetteModal(\''+rmKey+'\')">'+(r.nom)+'</h3><button class="edit-titre-btn" onclick="event.stopPropagation();editRecetteTitre(\''+rmKey+'\',this)" title="Modifier le titre">‚úèÔ∏è</button></div><div class="r-ico">'+(r.emoji||'ü•ò')+'</div></div>' +
      '<div class="rmeta"><span><b>Pr√©pa :</b> '+(r.prepTime||'‚Äî')+'</span><span><b>Cuisson :</b> '+(r.cookTime||'‚Äî')+'</span><span><b>üìÖ</b> '+dayNom+'</span></div>' +
      (r.url ? '<a class="recipe-link" href="'+r.url+'" target="_blank" rel="noopener">üîó Voir la recette originale</a>' : '<span class="recipe-link" style="opacity:.5;cursor:default">üîó Source non disponible</span>') +
      '<h4>Ingr√©dients</h4><ul>'+toArr(r.ingredients).map(function(ing){return '<li>'+ing+'</li>';}).join('')+'</ul>' +
      '<h4>Pr√©paration</h4><ol>'+toArr(r.etapes).map(function(e,si){return '<li class="etape-item" onclick="editEtape(this,\''+rmKey+'\','+si+')">'+e+'</li>';}).join('')+'</ol>';
  });
  if (J[idx].gou && J[idx].recetteGou) {
    var rg = J[idx].recetteGou;
    var rmKeyG = 'r'+idx+'_gou'; _rmp[rmKeyG] = rg;
    html += '<div style="margin:20px 0 8px"><span class="service-tag-badge lg">‚òï Go√ªter</span></div>' +
      '<div class="recipe-top"><div class="recipe-titre-wrap"><h3 class="recipe-title-link" onclick="ouvrirRecetteModal(\''+rmKeyG+'\')">'+(rg.nom)+'</h3><button class="edit-titre-btn" onclick="event.stopPropagation();editRecetteTitre(\''+rmKeyG+'\',this)" title="Modifier le titre">‚úèÔ∏è</button></div><div class="r-ico">'+(rg.emoji||'‚òï')+'</div></div>' +
      '<h4>Ingr√©dients</h4><ul>'+toArr(rg.ingredients).map(function(ing){return '<li>'+ing+'</li>';}).join('')+'</ul>' +
      '<h4>Pr√©paration</h4><ol>'+toArr(rg.etapes).map(function(e,si){return '<li class="etape-item" onclick="editEtape(this,\''+rmKeyG+'\','+si+')">'+e+'</li>';}).join('')+'</ol>';
  }
  return html;
}

function cuisinerCetteSemaine() {
  var selectionnes = [];
  var erreur = false;
  var checks = document.querySelectorAll('#mes-recettes-liste .recette-card-check:checked');
  Array.prototype.forEach.call(checks, function(cb) {
    var k = cb.id.replace('rcheck-', '');
    var r = recettesPersoMap[k];
    var sel = document.getElementById('rsel-'+k);
    if (!r) return;
    if (!sel || sel.value === '') {
      toast('‚ö†Ô∏è Choisissez un jour pour : ¬´ ' + r.nom + ' ¬ª');
      erreur = true;
      return;
    }
    // Type lu depuis le s√©lecteur de type de la carte (priorit√©) ou depuis les tags
    var svcList = ['entr√©e','plat principal','accompagnement','dessert','go√ªter','soupe'];
    var typeEl = document.getElementById('rtype-'+k);
    var type = (typeEl && typeEl.value) ? typeEl.value : ((r.tags||[]).find(function(t){ return svcList.includes(t); }) || 'plat principal');
    selectionnes.push({recette: r, jourIdx: parseInt(sel.value), type: type});
  });
  if (erreur || !selectionnes.length) {
    if (!selectionnes.length && !erreur) toast('‚ö†Ô∏è Cochez au moins une recette et choisissez un jour.');
    return;
  }

  // Grouper par jour pour √©viter les conflits Firebase (1 seule √©criture par jour)
  var parJour = {};
  selectionnes.forEach(function(item) {
    if (!parJour[item.jourIdx]) parJour[item.jourIdx] = [];
    parJour[item.jourIdx].push(item);
  });

  Object.keys(parJour).forEach(function(idxStr) {
    var idx = parseInt(idxStr);
    var items = parJour[idxStr];

    items.forEach(function(item) {
      var r = item.recette;
      var type = item.type;

      if (type === 'go√ªter') {
        J[idx].gou = r.nom;
        J[idx].recetteGou = r;
      } else {
        if (!J[idx].dinerItems) J[idx].dinerItems = [];
        var found = false;
        J[idx].dinerItems = J[idx].dinerItems.map(function(it) {
          if (it.type === type) { found = true; return {type:type, nom:r.nom, recette:r}; }
          return it;
        });
        if (!found) J[idx].dinerItems.push({type:type, nom:r.nom, recette:r});
      }
    });

    // recomputeDin et √©criture Firebase UNE SEULE FOIS apr√®s tous les items du jour
    recomputeDin(idx);

    // Mettre √† jour l'onglet Recettes pour ce jour
    var recipeDiv = document.getElementById('recipe-'+idx);
    if (recipeDiv) {
      if ((J[idx].dinerItems && J[idx].dinerItems.length > 0) || J[idx].recetteGou) {
        recipeDiv.innerHTML = buildMultiRecipeDiv(idx);
      } else if (J[idx].recette) {
        recipeDiv.innerHTML = buildRecipeDiv(idx, J[idx].recette);
      }
    }

    if (db) db.ref('menus/'+J[idx].date).set({
      nom: J[idx].nom, din: J[idx].din, dn: J[idx].dn, recette: J[idx].recette||null,
      dinerItems: J[idx].dinerItems||null,
      gou: J[idx].gou||null, recetteGou: J[idx].recetteGou||null
    });
  });

  rebuilderListeRecettes(J);
  rW();
  initIngredients();

  // D√©cocher + r√©initialiser l'affichage
  recettesPerso.forEach(function(r) {
    var k = r._fbKey || ('local-'+r.nom);
    var cb = document.getElementById('rcheck-'+k);
    var jourDiv = document.getElementById('rjour-'+k);
    var card = document.getElementById('rcard-'+k);
    if (cb) cb.checked = false;
    if (jourDiv) jourDiv.style.display = 'none';
    if (card) card.classList.remove('selected');
  });

  toast('‚úÖ Planning mis √† jour ‚Äî ingr√©dients ajout√©s √† la liste de courses !');

  // Retourner √† l'onglet Semaine
  var tabBtn = document.querySelector('.tabs button');
  tab('apercu', tabBtn);
}

function voirRecettePerso(k) {
  var r = recettesPersoMap[k];
  if (!r) { toast('‚ùå Recette introuvable'); return; }
  var modalData = {
    nom: r.nom,
    emoji: r.emoji || 'ü•ò',
    prepTime: r.prepTime || '‚Äî',
    cookTime: r.cookTime || '‚Äî',
    url: r.url || r.source || null,
    ingredients: toArr(r.ingredients),
    etapes: toArr(r.etapes),
    image: r.image || null,
    astuces: toArr(r.astuces || []),
    infosSante: toArr(r.infosSante || [])
  };
  afficherModal(modalData);
  document.getElementById('recette-modal').classList.add('fullscreen');
  var actions = document.querySelector('.modal-actions');
  if (actions) actions.style.display = 'none';
  var closeBtn = document.querySelector('.modal-close');
  if (closeBtn) {
    var origOnclick = closeBtn.onclick;
    closeBtn.onclick = function() {
      document.getElementById('recette-modal').classList.remove('fullscreen');
      fermerModal();
      if (actions) actions.style.display = '';
      closeBtn.onclick = origOnclick;
    };
  }
}

function ouvrirRecetteModal(key) {
  var r = _rmp[key];
  if (!r) return;
  afficherModal({
    nom: r.nom,
    emoji: r.emoji || 'ü•ò',
    prepTime: r.prepTime || '‚Äî',
    cookTime: r.cookTime || '‚Äî',
    url: r.url || null,
    ingredients: toArr(r.ingredients || []),
    etapes: toArr(r.etapes || []),
    image: r.image || null,
    astuces: toArr(r.astuces || []),
    infosSante: toArr(r.infosSante || [])
  });
  document.getElementById('recette-modal').classList.add('fullscreen');
  var actions = document.querySelector('.modal-actions');
  if (actions) actions.style.display = 'none';
  var closeBtn = document.querySelector('.modal-close');
  if (closeBtn) {
    var origOnclick = closeBtn.onclick;
    closeBtn.onclick = function() {
      document.getElementById('recette-modal').classList.remove('fullscreen');
      fermerModal();
      if (actions) actions.style.display = '';
      closeBtn.onclick = origOnclick;
    };
  }
}

// ===== √âDITION TITRE & √âTAPES RECETTE SEMAINE =====
function _rmpInfo(rmKey) {
  var m = rmKey.match(/^r(\d+)_(.+)$/);
  if (!m) return null;
  var idx = parseInt(m[1]), part = m[2];
  var r, fbPath;
  var dateKey = J[idx] && J[idx].date;
  if (part === 'main') {
    r = J[idx] && J[idx].recette;
    fbPath = 'menus/' + dateKey + '/recette';
  } else if (part === 'gou') {
    r = J[idx] && J[idx].recetteGou;
    fbPath = 'menus/' + dateKey + '/recetteGou';
  } else {
    var di = parseInt(part);
    r = J[idx] && J[idx].dinerItems && J[idx].dinerItems[di] && J[idx].dinerItems[di].recette;
    fbPath = 'menus/' + dateKey + '/dinerItems/' + di + '/recette';
  }
  return r ? {r: r, fbPath: fbPath} : null;
}

function editRecetteTitre(rmKey, btn) {
  var info = _rmpInfo(rmKey);
  if (!info) return;
  var wrap = btn.parentElement; // .recipe-titre-wrap
  var h3 = wrap.querySelector('h3');
  var oldNom = h3.textContent;
  var inp = document.createElement('input');
  inp.type = 'text'; inp.value = oldNom; inp.className = 'edit-titre-input';
  inp.onclick = function(e) { e.stopPropagation(); };
  h3.style.display = 'none'; btn.style.display = 'none';
  wrap.insertBefore(inp, h3);
  inp.focus(); inp.select();
  function save() {
    var newNom = inp.value.trim() || oldNom;
    info.r.nom = newNom; _rmp[rmKey].nom = newNom;
    h3.textContent = newNom; h3.style.display = ''; btn.style.display = '';
    inp.remove();
    if (newNom !== oldNom && db) db.ref(info.fbPath + '/nom').set(newNom);
  }
  function cancel() { h3.style.display = ''; btn.style.display = ''; inp.remove(); }
  inp.onblur = save;
  inp.onkeydown = function(e) {
    if (e.key === 'Enter') { e.preventDefault(); inp.onblur = null; save(); }
    if (e.key === 'Escape') { inp.onblur = null; cancel(); }
  };
}

function editEtape(li, rmKey, stepIdx) {
  if (li.dataset.editing) return;
  var info = _rmpInfo(rmKey);
  if (!info) return;
  var etapes = toArr(info.r.etapes);
  var oldVal = etapes[stepIdx] || '';
  li.dataset.editing = '1'; li.onclick = null; li.classList.remove('etape-item');
  var textarea = document.createElement('textarea');
  textarea.value = oldVal; textarea.className = 'etape-textarea'; textarea.rows = 3;
  var btnOk = document.createElement('button');
  btnOk.textContent = '‚úì'; btnOk.className = 'ing-btn-ok';
  var btnAnn = document.createElement('button');
  btnAnn.textContent = '‚úï'; btnAnn.className = 'ing-btn-cancel';
  var btns = document.createElement('div'); btns.className = 'etape-btns';
  btns.appendChild(btnOk); btns.appendChild(btnAnn);
  li.innerHTML = ''; li.classList.add('etape-edit');
  li.appendChild(textarea); li.appendChild(btns);
  textarea.focus();
  function save() {
    var newVal = textarea.value.trim() || oldVal;
    delete li.dataset.editing; li.classList.remove('etape-edit'); li.classList.add('etape-item');
    li.innerHTML = newVal;
    li.onclick = function() { editEtape(this, rmKey, stepIdx); };
    if (newVal !== oldVal) {
      if (info.r.etapes) info.r.etapes[stepIdx] = newVal;
      _rmp[rmKey].etapes[stepIdx] = newVal;
      if (db) db.ref(info.fbPath + '/etapes').set(toArr(info.r.etapes));
    }
  }
  function cancel() {
    delete li.dataset.editing; li.classList.remove('etape-edit'); li.classList.add('etape-item');
    li.innerHTML = oldVal;
    li.onclick = function() { editEtape(this, rmKey, stepIdx); };
  }
  btnOk.onclick = function(e) { e.stopPropagation(); save(); };
  btnAnn.onclick = function(e) { e.stopPropagation(); cancel(); };
  textarea.onkeydown = function(e) {
    if (e.key === 'Enter' && e.ctrlKey) { e.preventDefault(); save(); }
    if (e.key === 'Escape') { cancel(); }
  };
}

// ===== INTERVERTIR D√éNERS (deux-taps ‚Äî tous appareils) =====
var swapInProgress = false;
var swapSelectIdx = null;

function selectSwap(i) {
  if (swapSelectIdx === null) {
    swapSelectIdx = i;
    document.getElementById('day-'+i).classList.add('swap-selected');
    toast('üìå Tape ‚†ø sur un autre d√Æner pour intervertir');
  } else if (swapSelectIdx === i) {
    document.getElementById('day-'+i).classList.remove('swap-selected');
    swapSelectIdx = null;
  } else {
    document.getElementById('day-'+swapSelectIdx).classList.remove('swap-selected');
    var src = swapSelectIdx, dst = i;
    swapSelectIdx = null;
    var d = J[src].din, n = J[src].dn;
    J[src].din = J[dst].din; J[src].dn = J[dst].dn;
    J[dst].din = d; J[dst].dn = n;
    rW();
    if (db) {
      swapInProgress = true;
      var updates = {};
      updates['menus/'+src] = {din:J[src].din, dn:J[src].dn};
      updates['menus/'+dst] = {din:J[dst].din, dn:J[dst].dn};
      db.ref().update(updates).then(function(){ swapInProgress = false; })
                              .catch(function(){ swapInProgress = false; });
    }
    toast('‚úÖ D√Æners intervertis !');
  }
}

// ===== TOAST =====
function toast(msg) {
  var t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(function() { t.remove(); }, 2500);
}

// ===== SAUVEGARDER RECETTE DU D√éNER =====
function sauvegarderRecetteDiner(i) {
  var nom = J[i].dn;
  if (!nom) return;
  if (recettesPerso.some(function(r) { return r.nom.toLowerCase() === nom.toLowerCase(); })) {
    toast('D√©j√† dans Mes recettes');
    return;
  }
  var recipeDiv = document.getElementById('recipe-'+i);
  var emoji = recipeDiv && recipeDiv.querySelector('.r-ico') ? recipeDiv.querySelector('.r-ico').textContent.trim() : 'ü•ò';
  var ingredients = [];
  if (recipeDiv) recipeDiv.querySelectorAll('ul li').forEach(function(li) { ingredients.push(li.textContent.trim()); });
  var etapes = [];
  if (recipeDiv) recipeDiv.querySelectorAll('ol li').forEach(function(li) { etapes.push(li.textContent.trim()); });
  var recette = { nom: nom, emoji: emoji, description: J[i].din, ingredients: ingredients, etapes: etapes, source: 'Semaine' };
  if (db) {
    db.ref('recettes_perso').push(recette);
  } else {
    recettesPerso.push(recette);
    afficherRecettesPerso();
  }
  toast('‚úÖ ¬´ ' + nom + ' ¬ª ajout√©e √† Mes recettes');
}

// ===== PHASE 4 ‚Äî AUTRE RECETTE =====
var recetteEnCours = null;
var filtresTags = new Set();
var filtreFavoris = false;
var tagPickerOpen = null;
var tagPickerDirtyKey = null; // cl√© dont les tags ont chang√© mais Firebase pas encore √©crit
var svcDropdownOpen = null;

function toggleSvcDropdown(k) {
  if (svcDropdownOpen === k) { fermeSvcDropdown(); return; }
  fermeSvcDropdown();
  svcDropdownOpen = k;
  var badge = document.getElementById('rsvc-'+k);
  if (!badge) return;
  var r = recettesPersoMap[k];
  var svcList = ['entr√©e','plat principal','accompagnement','dessert','go√ªter','soupe'];
  var current = r ? (r.tags||[]).find(function(t){ return svcList.includes(t); }) : null;
  var options = [
    {v:'entr√©e',         l:'ü•ó Entr√©e'},
    {v:'plat principal', l:'üçΩÔ∏è Plat principal'},
    {v:'accompagnement', l:'ü•¶ Accompagnement'},
    {v:'dessert',        l:'üçÆ Dessert'},
    {v:'go√ªter',         l:'‚òï Go√ªter'},
    {v:'soupe',          l:'ü•£ Soupe'}
  ];
  var menu = document.createElement('div');
  menu.id = 'sdrop-'+k;
  menu.className = 'svc-menu';
  menu.innerHTML = options.map(function(o){
    return '<button class="'+(o.v===current?'active':'')+'" onclick="changerService(\''+k+'\',\''+o.v+'\')">'+o.l+'</button>';
  }).join('');
  badge.parentNode.appendChild(menu);
  setTimeout(function(){ document.addEventListener('click', fermeSvcOutside); }, 0);
}
function fermeSvcOutside(e) {
  if (!e.target.closest('.svc-menu') && !(e.target.id && e.target.id.startsWith('rsvc-'))) {
    fermeSvcDropdown();
    document.removeEventListener('click', fermeSvcOutside);
  }
}
function fermeSvcDropdown() {
  if (svcDropdownOpen) {
    var el = document.getElementById('sdrop-'+svcDropdownOpen);
    if (el) el.remove();
    svcDropdownOpen = null;
  }
  document.removeEventListener('click', fermeSvcOutside);
}
function toggleTagCard(k, tag) {
  var r = recettesPersoMap[k];
  if (!r) return;
  var tags = (r.tags||[]).slice();
  var idx = tags.indexOf(tag);
  if (idx !== -1) tags.splice(idx, 1); else tags.push(tag);
  r.tags = tags;
  buildTagFilterPanel();
  var picker = document.getElementById('tpicker-'+k);
  if (picker) {
    // Picker ouvert : mise √† jour visuelle uniquement, PAS d'√©criture Firebase
    // (l'√©criture Firebase d√©clenche le listener qui appelle afficherRecettesPerso
    //  et d√©truit le picker)
    tagPickerDirtyKey = k;
    picker.querySelectorAll('.tag-picker-chip').forEach(function(chip){
      chip.classList.toggle('has', tags.includes(chip.dataset.tag));
    });
  } else {
    // Picker ferm√© : √©criture Firebase imm√©diate
    if (r._fbKey && db) db.ref('recettes_perso/'+r._fbKey+'/tags').set(tags);
    renderCardTags(k);
  }
}
function ouvrePickerTag(k) {
  if (tagPickerOpen === k) { fermePickerTag(); return; }
  fermePickerTag();
  tagPickerOpen = k;
  var area = document.getElementById('rtags-'+k);
  if (!area) return;
  var r = recettesPersoMap[k];
  var existing = r ? (r.tags||[]) : [];
  var picker = document.createElement('div');
  picker.id = 'tpicker-'+k;
  picker.className = 'tag-picker';
  // Exclure la cat√©gorie Service (g√©r√©e par le badge dropdown)
  var groupes = taxonomieActive.filter(function(g){ return g.cat !== 'Service'; });
  picker.innerHTML =
    '<div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">' +
      '<span style="font-size:.68rem;color:var(--txt2)">Cliquez pour ajouter / retirer</span>' +
      '<button style="background:none;border:none;cursor:pointer;font-size:.8rem;color:var(--txt2)" onclick="fermePickerTag()">‚úï</button>' +
    '</div>' +
    groupes.map(function(g){
      return '<div class="tag-picker-group">' +
        '<span class="tag-picker-title">'+g.cat+'</span>' +
        g.tags.map(function(t){
          return '<button class="tag-picker-chip'+(existing.includes(t)?' has':'')+'" data-tag="'+t+'" onclick="event.stopPropagation();toggleTagCard(\''+k+'\',\''+t+'\')">'+t+'</button>';
        }).join('') +
      '</div>';
    }).join('');
  area.parentNode.insertBefore(picker, area.nextSibling);
  setTimeout(function(){ document.addEventListener('click', fermePickerOutside); }, 0);
}
function fermePickerOutside(e) {
  if (!e.target.closest('.tag-picker') && !e.target.classList.contains('tags-edit-btn')) {
    fermePickerTag();
  }
}
function fermePickerTag() {
  var wasOpen = tagPickerOpen;
  if (tagPickerOpen) {
    var el = document.getElementById('tpicker-'+tagPickerOpen);
    if (el) el.remove();
    tagPickerOpen = null;
  }
  document.removeEventListener('click', fermePickerOutside);
  if (wasOpen) renderCardTags(wasOpen);
  // √âcriture Firebase diff√©r√©e : maintenant que le picker est ferm√©,
  // le listener peut reconstruire la liste sans probl√®me
  if (tagPickerDirtyKey) {
    var r = recettesPersoMap[tagPickerDirtyKey];
    if (r && r._fbKey && db) db.ref('recettes_perso/'+r._fbKey+'/tags').set(r.tags);
    tagPickerDirtyKey = null;
  }
}
function changerService(k, newType) {
  var r = recettesPersoMap[k];
  if (!r) return;
  var svcList = ['entr√©e','plat principal','accompagnement','dessert','go√ªter','soupe'];
  var tags = (r.tags||[]).filter(function(t){ return !svcList.includes(t); });
  tags.unshift(newType);
  r.tags = tags;
  if (r._fbKey && db) db.ref('recettes_perso/'+r._fbKey+'/tags').set(tags);
  var badge = document.getElementById('rsvc-'+k);
  if (badge) { badge.textContent = newType+' ‚ñæ'; badge.style.display = ''; }
  fermeSvcDropdown();
  buildTagFilterPanel();
}
var TAG_TAXONOMY = [
  {cat:'Service',    tags:['entr√©e','plat principal','dessert','go√ªter','soupe']},
  {cat:'Prot√©ine',   tags:['volaille','viande rouge','cochon','gibier','poisson','fruits de mer','≈ìufs','l√©gumineuses','v√©g√©tarien','vegan']},
  {cat:'Style',      tags:['terroir fran√ßais','m√©diterran√©en','maghr√©bin','asiatique','barbecue','mijot√©','grill√©','vapeur','salade','gratin','pasta / risotto']},
  {cat:'Nutrition',  tags:['healthy','IG bas','anti-cholest√©rol','l√©ger']}
];
// Copie mutable ‚Äî surcharg√©e depuis Firebase si l'utilisateur a personnalis√©
var taxonomieActive = TAG_TAXONOMY.map(function(g){ return {cat:g.cat, tags:g.tags.slice()}; });

function sauvegarderTaxonomieFirebase() {
  if (!db) return;
  var obj = {};
  taxonomieActive.forEach(function(g){ obj[g.cat] = g.tags; });
  db.ref('tag_taxonomy_custom').set(obj);
}

function ouvrirGestionTags() {
  var overlay = document.getElementById('tag-mgr-overlay');
  if (overlay) { overlay.style.display = 'flex'; renderGestionTags(); }
}

function fermerGestionTags() {
  var overlay = document.getElementById('tag-mgr-overlay');
  if (overlay) overlay.style.display = 'none';
}

function renderGestionTags() {
  var content = document.getElementById('tag-mgr-content');
  if (!content) return;
  var html = taxonomieActive.map(function(g, gi) {
    var chips = g.tags.map(function(t) {
      var ts = t.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      return '<span class="tag-mgr-chip">'+t+
        '<button class="tag-mgr-del" onclick="supprimerTagDuSysteme('+gi+',\''+ts+'\')" title="Supprimer">‚úï</button>'+
        '</span>';
    }).join('');
    return '<div class="tag-mgr-cat">'+
      '<div class="tag-mgr-cat-title">'+
        '<span>'+g.cat+'</span>'+
        (gi >= 4 ? '<button class="tag-mgr-del-cat" onclick="supprimerCategorie('+gi+')" title="Supprimer cette cat√©gorie">üóë Cat√©gorie</button>' : '')+
      '</div>'+
      '<div class="tag-mgr-chips">'+(chips||'<span style="font-size:.72rem;color:var(--txt2);font-style:italic">Aucun tag</span>')+'</div>'+
      '<div class="tag-mgr-add">'+
        '<input class="tag-mgr-input" id="tmadd-'+gi+'" placeholder="Nouveau tag‚Ä¶" onkeydown="if(event.key===\'Enter\')ajouterTagAuSysteme('+gi+',\'tmadd-'+gi+'\')">'+
        '<button class="tag-mgr-btn" onclick="ajouterTagAuSysteme('+gi+',\'tmadd-'+gi+'\')">+ Ajouter</button>'+
      '</div>'+
      '</div>';
  }).join('');
  html += '<hr class="tag-mgr-separator">'+
    '<div class="tag-mgr-cat">'+
      '<div class="tag-mgr-cat-title"><span>Nouvelle cat√©gorie</span></div>'+
      '<div class="tag-mgr-add">'+
        '<input class="tag-mgr-input" id="tmadd-newcat" placeholder="Nom de la cat√©gorie‚Ä¶">'+
        '<button class="tag-mgr-btn" onclick="ajouterCategorie()">+ Cr√©er</button>'+
      '</div>'+
    '</div>';
  content.innerHTML = html;
}

function supprimerTagDuSysteme(catIdx, tag) {
  taxonomieActive[catIdx].tags = taxonomieActive[catIdx].tags.filter(function(t){ return t !== tag; });
  sauvegarderTaxonomieFirebase();
  renderGestionTags();
  buildTagFilterPanel();
}

function ajouterTagAuSysteme(catIdx, inputId) {
  var input = document.getElementById(inputId);
  if (!input) return;
  var tag = input.value.trim().toLowerCase();
  if (!tag) return;
  if (taxonomieActive[catIdx].tags.indexOf(tag) !== -1) { toast('Tag d√©j√† pr√©sent dans cette cat√©gorie'); return; }
  taxonomieActive[catIdx].tags.push(tag);
  input.value = '';
  sauvegarderTaxonomieFirebase();
  renderGestionTags();
  buildTagFilterPanel();
}

function ajouterCategorie() {
  var input = document.getElementById('tmadd-newcat');
  if (!input) return;
  var cat = input.value.trim();
  if (!cat) return;
  if (taxonomieActive.some(function(g){ return g.cat.toLowerCase() === cat.toLowerCase(); })) { toast('Cat√©gorie d√©j√† pr√©sente'); return; }
  taxonomieActive.push({cat: cat, tags: []});
  input.value = '';
  sauvegarderTaxonomieFirebase();
  renderGestionTags();
  buildTagFilterPanel();
}

function supprimerCategorie(catIdx) {
  if (!confirm('Supprimer la cat√©gorie ¬´ '+taxonomieActive[catIdx].cat+' ¬ª ?')) return;
  taxonomieActive.splice(catIdx, 1);
  sauvegarderTaxonomieFirebase();
  renderGestionTags();
  buildTagFilterPanel();
}

function toggleFavori(k) {
  var r = recettesPersoMap[k];
  if (!r || !r._fbKey) return;
  r.favoris = !r.favoris;
  if (db) db.ref('recettes_perso/' + r._fbKey + '/favoris').set(r.favoris);
  var btn = document.getElementById('rfav-'+k);
  if (btn) { btn.textContent = r.favoris ? '‚òÖ' : '‚òÜ'; btn.classList.toggle('active', r.favoris); }
}

function buildTagFilterPanel() {
  // Mettre √† jour le badge du bouton
  var badge = document.getElementById('tag-filter-badge');
  if (badge) badge.textContent = filtresTags.size > 0 ? ' ('+filtresTags.size+')' : '';
  var btn = document.getElementById('btn-tag-filter');
  if (btn) btn.classList.toggle('has-active', filtresTags.size > 0);
  // Reconstruire le panneau seulement s'il est visible
  var panel = document.getElementById('tag-filter-panel');
  if (!panel || panel.style.display !== 'block') return;
  // Compter les recettes par tag
  var countMap = {};
  recettesPerso.forEach(function(r){ (r.tags||[]).forEach(function(t){ countMap[t]=(countMap[t]||0)+1; }); });
  var html = taxonomieActive.map(function(g) {
    var chips = g.tags.map(function(t){
      var cnt = countMap[t]||0;
      var isDim = cnt === 0;
      var isActive = filtresTags.has(t);
      var cls = 'tag-chip' + (isActive?' active':'') + (isDim?' dim':'');
      var onclick = isDim ? '' : ' onclick="toggleFiltreTag(\''+t+'\')"';
      var countBadge = cnt > 0 ? '<span class="chip-count">'+cnt+'</span>' : '';
      return '<button class="'+cls+'"'+onclick+'>'+t+countBadge+'</button>';
    }).join('');
    return '<div class="tag-filter-section"><span class="tag-filter-cat-title">'+g.cat+'</span><div class="tag-filter-chips">'+chips+'</div></div>';
  }).join('');
  if (filtresTags.size > 0) html += '<button class="tag-filter-reset" onclick="resetTagFilter()">‚úï Effacer tous les filtres</button>';
  html += '<button class="tag-filter-reset" onclick="ouvrirGestionTags()" style="color:var(--acc)">‚öôÔ∏è Personnaliser les tags‚Ä¶</button>';
  panel.innerHTML = html;
}

function toggleTagFilterPanel() {
  var panel = document.getElementById('tag-filter-panel');
  if (!panel) return;
  var isOpen = panel.style.display === 'block';
  panel.style.display = isOpen ? 'none' : 'block';
  if (!isOpen) buildTagFilterPanel();
}

function resetTagFilter() {
  filtresTags.clear();
  buildTagFilterPanel();
  filtrerRecettes();
}

function toggleFiltreTag(tag) {
  if (filtresTags.has(tag)) filtresTags.delete(tag);
  else filtresTags.add(tag);
  buildTagFilterPanel();
  filtrerRecettes();
}

function filtrerRecettes() {
  var q = (document.getElementById('mr-search') ? document.getElementById('mr-search').value.trim().toLowerCase() : '');
  var visible = recettesPerso.filter(function(r) {
    if (filtreFavoris && !r.favoris) return false;
    if (filtresTags.size > 0) {
      var rt = r.tags || [];
      var match = false;
      filtresTags.forEach(function(t){ if (rt.includes(t)) match = true; });
      if (!match) return false;
    }
    if (q) {
      var hay = (r.nom + ' ' + (r.description||'')).toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });
  afficherRecettesPerso(visible);
}


function renderCardTags(k) {
  var r = recettesPersoMap[k];
  if (!r) return;
  var serviceTagsList = ['entr√©e','plat principal','accompagnement','dessert','go√ªter','soupe'];
  var serviceTag = (r.tags||[]).find(function(t){ return serviceTagsList.includes(t); });
  // Mettre √† jour le badge service √† c√¥t√© du nom
  var svcBadge = document.getElementById('rsvc-'+k);
  if (svcBadge) {
    svcBadge.textContent = serviceTag || '';
    svcBadge.style.display = serviceTag ? '' : 'none';
  }
  // Mettre √† jour la zone tags (tags non-service uniquement)
  var area = document.getElementById('rtags-'+k);
  if (!area) return;
  var nonSvcTags = (r.tags||[]).filter(function(t){ return !serviceTagsList.includes(t); });
  var tags = nonSvcTags.map(function(t){ return '<span class="tag-badge">'+t+'</span>'; }).join('');
  area.innerHTML = tags + '<button class="tags-edit-btn" onclick="ouvrePickerTag(\''+k+'\')" title="Modifier les tags">‚úèÔ∏è</button>';
}


function recomputeDin(idx) {
  var items = J[idx].dinerItems;
  if (!items || !items.length) return;
  J[idx].din = items.map(function(it){ return it.nom; }).join(' ‚Ä¢ ');
  var plat = items.find(function(it){ return it.type==='plat principal'; }) || items[0];
  J[idx].dn = plat.nom;
  J[idx].recette = plat.recette;
}

function supprimerService(idx, type) {
  if (!J[idx] || !J[idx].dinerItems) return;
  var arr = Array.isArray(J[idx].dinerItems) ? J[idx].dinerItems : Object.values(J[idx].dinerItems).filter(Boolean);
  // Capturer la recette supprim√©e avant de filtrer
  var serviceSuppr = arr.find(function(it){ return it.type === type; });
  J[idx].dinerItems = arr.filter(function(it){ return it.type !== type; });
  // La liste de courses sera reconstruite par rebuilderListeRecettes apr√®s l'√©criture Firebase
  if (!J[idx].dinerItems.length) {
    J[idx].dinerItems = null;
    J[idx].recette = null;
    J[idx].din = '';
    J[idx].dn = '';
  }
  recomputeDin(idx);
  var recipeDiv = document.getElementById('recipe-'+idx);
  if (recipeDiv) {
    if (J[idx].dinerItems && J[idx].dinerItems.length > 0) {
      recipeDiv.innerHTML = buildMultiRecipeDiv(idx);
    } else if (J[idx].recette) {
      recipeDiv.innerHTML = buildRecipeDiv(idx, J[idx].recette);
    } else {
      recipeDiv.innerHTML = '<button class="btn-back" onclick="goMenu()">‚Üê Retour au menu</button><p style="color:var(--txt2);text-align:center;margin:30px 0;font-size:.9rem">Aucun d√Æner planifi√© pour ce soir.</p>';
    }
    initIngredients();
  }
  rebuilderListeRecettes(J);
  rW();
  if (db) db.ref('menus/'+J[idx].date).set({
    nom: J[idx].nom, din: J[idx].din, dn: J[idx].dn, recette: J[idx].recette||null,
    dinerItems: J[idx].dinerItems||null,
    gou: J[idx].gou||null, recetteGou: J[idx].recetteGou||null
  });
}

function supprimerGouteur(idx) {
  if (!J[idx]) return;
  J[idx].gou = null;
  J[idx].recetteGou = null;
  if (db) db.ref('menus/'+J[idx].date).set({
    nom: J[idx].nom, din: J[idx].din, dn: J[idx].dn, recette: J[idx].recette||null,
    dinerItems: J[idx].dinerItems||null,
    gou: null, recetteGou: null
  });
  rW();
}

function changerRecette(idx, btn, recettesRefusees) {
  var origText = btn.textContent;
  btn.textContent = '‚è≥';
  btn.disabled = true;
  var autresRecettes = J.filter(function(j,i){return i!==idx;}).map(function(j){return j.dn;});
  fetch('/api/recette', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({jour:J[idx].nom, recetteActuelle:J[idx].dn, autresRecettes:autresRecettes, recettesRefusees:recettesRefusees||[], sitesExtra:sitesExtra, profilExtra:profilExtra, recettesPerso:recettesPerso})
  })
  .then(function(r){return r.json();})
  .then(function(data){
    recetteEnCours = {idx:idx, data:data, refusees:recettesRefusees||[]};
    afficherModal(data);
    btn.textContent = origText;
    btn.disabled = false;
  })
  .catch(function(){
    alert('Erreur lors de la recherche. R√©essayez.');
    btn.textContent = origText;
    btn.disabled = false;
  });
}

function afficherModal(data) {
  document.getElementById('modal-titre').textContent = data.emoji + ' ' + data.nom;

  var imgEl = document.getElementById('modal-img');
  if (imgEl) {
    if (data.image) { imgEl.src = data.image; imgEl.style.display = ''; }
    else imgEl.style.display = 'none';
  }

  var metas = [];
  if (data.prepTime && data.prepTime !== '‚Äî') metas.push('<span><b>Pr√©pa :</b> '+data.prepTime+'</span>');
  if (data.cookTime && data.cookTime !== '‚Äî') metas.push('<span><b>Cuisson :</b> '+data.cookTime+'</span>');
  var infosEl = document.getElementById('modal-infos');
  if (infosEl) infosEl.style.display = metas.length ? '' : 'none';
  document.getElementById('modal-meta').innerHTML = metas.join('');

  var urlEl = document.getElementById('modal-url');
  urlEl.innerHTML = data.url
    ? '<a class="recipe-link" href="'+data.url+'" target="_blank" rel="noopener">üîó Voir la recette originale</a>'
    : '<span class="recipe-link" style="opacity:.5;cursor:default">üîó Source non disponible</span>';

  document.getElementById('modal-ingredients').innerHTML =
    data.ingredients.map(function(i){return '<li>'+i+'</li>';}).join('');
  document.getElementById('modal-etapes').innerHTML =
    data.etapes.map(function(e){return '<li>'+e+'</li>';}).join('');

  var astuces = toArr(data.astuces || []);
  var astucesWrap = document.getElementById('modal-astuces-wrap');
  if (astucesWrap) {
    astucesWrap.style.display = astuces.length ? '' : 'none';
    document.getElementById('modal-astuces').innerHTML = astuces.map(function(a){return '<li>'+a+'</li>';}).join('');
  }

  var infosSante = toArr(data.infosSante || []);
  var santeWrap = document.getElementById('modal-sante-wrap');
  if (santeWrap) {
    santeWrap.style.display = infosSante.length ? '' : 'none';
    document.getElementById('modal-sante').innerHTML = infosSante.map(function(s){return '<li>'+s+'</li>';}).join('');
  }

  document.getElementById('recette-modal').classList.add('on');
}

function fermerModal() {
  var m = document.getElementById('recette-modal');
  m.classList.remove('on');
  m.classList.remove('fullscreen');
  recetteEnCours = null;
}

function accepterRecette() {
  if (!recetteEnCours) return;
  var idx = recetteEnCours.idx;
  var data = recetteEnCours.data;
  // Int√®gre la recette comme "plat principal" dans dinerItems
  if (!J[idx].dinerItems) J[idx].dinerItems = [];
  var found = false;
  J[idx].dinerItems = J[idx].dinerItems.map(function(it) {
    if (it.type === 'plat principal') { found = true; return {type:'plat principal', nom:data.nom, recette:data}; }
    return it;
  });
  if (!found) J[idx].dinerItems.push({type:'plat principal', nom:data.nom, recette:data});
  recomputeDin(idx);
  rW();
  var recipeDiv = document.getElementById('recipe-'+idx);
  if (recipeDiv) { recipeDiv.innerHTML = buildMultiRecipeDiv(idx); initIngredients(); }
  rebuilderListeRecettes(J);
  if (db) db.ref('menus/'+J[idx].date).set({nom:J[idx].nom, din:J[idx].din, dn:J[idx].dn, recette:J[idx].recette||null, dinerItems:J[idx].dinerItems});
  fermerModal();
}

function chercherAutre() {
  if (!recetteEnCours) return;
  var idx = recetteEnCours.idx;
  var refusees = (recetteEnCours.refusees || []).concat([recetteEnCours.data.nom]);
  fermerModal();
  var btn = document.querySelector('[data-swap-idx="'+idx+'"]');
  if (btn) changerRecette(idx, btn, refusees);
}

// ===== FIREBASE =====
var db=null;
var ingredientsFirebase=null;
var produitsHabituels=[];
var tpFiltresActifs={};
var tpVueAjouter=false;
function fbKey(nom){return nom.replace(/[.#$[\]/]/g,'-').replace(/\s+/g,'_').substring(0,60);}

function appliquerIngredientsFirebase(ingredients){
  if(!ingredients)return;
  Object.keys(ingredients).forEach(function(idx){
    var recipeDiv=document.getElementById('recipe-'+idx);
    if(!recipeDiv)return;
    var changes=ingredients[idx];
    Object.values(changes).forEach(function(change){
      recipeDiv.querySelectorAll('ul li').forEach(function(li){
        if(li.textContent.trim()===change.original){
          li.textContent=change.nouveau;
          li.classList.add('ing-changed');
        }
      });
    });
  });
}

function appliquerDepuisFirebase(data, menus){
  // 0. Reconstruire les items recettes depuis les donn√©es menus Firebase
  rebuilderListeRecettes(menus || {});
  var coches=data.coches||{};
  var ajoutes=data.ajoutes||{};
  // 1. Ajouter les produits manuels absents du DOM
  // Nettoyage migration : supprimer de Firebase les items ajoutes qui doublonnent un ingr√©dient recette
  var recipeNoms={};
  document.querySelectorAll('#liste-principale .sitem[data-recipe] .sn').forEach(function(el){recipeNoms[el.textContent.toLowerCase().trim()]=true;});
  Object.keys(ajoutes).forEach(function(key){
    var item=ajoutes[key];
    if(recipeNoms[item.nom.toLowerCase().trim()]){if(db)db.ref('courses/ajoutes/'+key).remove();return;}
    var dansDOM=false;
    document.querySelectorAll('.sitem .sn').forEach(function(el){if(el.textContent===item.nom)dansDOM=true;});
    if(!dansDOM){
      var c=document.querySelector('.si[data-cat="'+item.rayon+'"]');
      if(c){var ph=c.closest('.scat').querySelector('.ph');if(ph)ph.remove();
        var l=document.createElement('label');l.className='sitem';l.dataset.ajoutesKey=key;
        l.innerHTML='<input type="checkbox" onchange="bascule(this)"><span class="sn">'+item.nom+'</span><span class="sr">Ajout√© manuellement</span>';
        c.appendChild(l);}
    }
  });
  // 2. Cocher les produits pr√©sents dans Firebase mais pas dans le caddie
  document.querySelectorAll('#liste-principale .sitem').forEach(function(it){
    var nm=it.querySelector('.sn').textContent;
    var coche=coches[fbKey(nm)];
    if(coche&&it.style.display!=='none'){
      var cd=document.getElementById('caddie');
      var em=cd.querySelector('.caddie-empty');if(em)em.remove();
      var cl=it.cloneNode(true);cl.querySelector('input').checked=true;
      cl.querySelector('input').onchange=function(){deb(this);};
      cd.appendChild(cl);it.style.display='none';
    }else if(!coche&&it.style.display==='none'){
      it.style.display='';it.querySelector('input').checked=false;
    }
  });
  // 3. Retirer du caddie les produits supprim√©s de Firebase (depuis un autre appareil)
  var toRemove=[];
  document.querySelectorAll('#caddie .sitem').forEach(function(it){
    var nm=it.querySelector('.sn').textContent;
    if(!coches[fbKey(nm)])toRemove.push(it);
  });
  toRemove.forEach(function(it){it.remove();});
  var cd=document.getElementById('caddie');
  if(!cd.querySelector('.sitem'))cd.innerHTML='<p class="caddie-empty">Cochez les produits pour les ajouter ici.</p>';
  mC();
}

function reinitialiserSysteme() {
  if (!confirm('‚ö†Ô∏è R√©initialiser le planning et la liste de courses ?\n\nConserv√©s : Mes Recettes ‚úÖ  |  Mes Produits ‚úÖ\nEffac√©s : Planning de la semaine ‚ùå  |  Liste de courses ‚ùå')) return;
  if (!confirm('Derni√®re confirmation ‚Äî effacer d√©finitivement le planning et la liste de courses ?')) return;
  var ops = [];
  if (db) {
    ops.push(db.ref('menus').remove());
    ops.push(db.ref('courses').remove());
  }
  Promise.all(ops).then(function(){ location.reload(); }).catch(function(){ location.reload(); });
}

var firebaseConfig={
  apiKey:"AIzaSyBr09zcjmNN7hsKyr_832GulpGQc9xfZOo",
  authDomain:"menu-de-la-semaine-9bed7.firebaseapp.com",
  databaseURL:"https://menu-de-la-semaine-9bed7-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"menu-de-la-semaine-9bed7",
  storageBucket:"menu-de-la-semaine-9bed7.firebasestorage.app",
  messagingSenderId:"18330977147",
  appId:"1:18330977147:web:2ef6f58c6baf85ec9e73de"
};
firebase.initializeApp(firebaseConfig);
db=firebase.database();
db.ref('/').on('value',function(snapshot){
  var data=snapshot.val()||{};
  // Sync menus modifi√©s
  if (data.menus && !swapInProgress) {
    var needRW=false;
    Object.keys(data.menus).forEach(function(dateKey){
      if(!/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return;
      var idx=J.findIndex(function(j){return j.date===dateKey;});
      var fbM=data.menus[dateKey];
      if(idx===-1||!fbM) return;
      // Sync din/dn si chang√©
      if(J[idx].din!==fbM.din){
        J[idx].din=fbM.din;
        J[idx].dn=fbM.dn;
        needRW=true;
      }
      // Sync dinerItems ‚Äî Firebase renvoie un objet {0:{‚Ä¶},1:{‚Ä¶}}, convertir en tableau
      var rawDI=fbM.dinerItems||null;
      var newDI=rawDI?(Array.isArray(rawDI)?rawDI:Object.values(rawDI)).filter(Boolean):null;
      if(newDI&&!newDI.length)newDI=null;
      var needRecipe=false;
      if(JSON.stringify(J[idx].dinerItems)!==JSON.stringify(newDI)){
        J[idx].dinerItems=newDI; needRW=true; needRecipe=true;
      }
      // Sync go√ªter
      var newGou=fbM.gou||null;
      if(J[idx].gou!==newGou){ J[idx].gou=newGou; needRW=true; }
      J[idx].recetteGou=fbM.recetteGou||null;
      // Sync recette
      if(fbM.recette){
        var localNom=J[idx].recette?J[idx].recette.nom:null;
        if(localNom!==fbM.recette.nom){ J[idx].recette=fbM.recette; needRecipe=true; }
        // Migration : recette pr√©sente mais dinerItems absent ‚Üí cr√©er dinerItems (ancienne semaine)
        if(!J[idx].dinerItems){
          J[idx].dinerItems=[{type:'plat principal',nom:fbM.recette.nom,recette:fbM.recette}];
          needRW=true; needRecipe=true;
          if(db)db.ref('menus/'+J[idx].date+'/dinerItems').set(J[idx].dinerItems);
        }
      }
      // Mettre √† jour l'onglet Recettes si recette ou dinerItems ont chang√©
      if(needRecipe){
        var recipeDiv=document.getElementById('recipe-'+idx);
        if(recipeDiv){
          if(J[idx].dinerItems&&J[idx].dinerItems.length){
            recipeDiv.innerHTML=buildMultiRecipeDiv(idx);
          } else if(J[idx].recette){
            recipeDiv.innerHTML=buildRecipeDiv(idx,J[idx].recette);
          } else {
            recipeDiv.innerHTML='<button class="btn-back" onclick="goMenu()">‚Üê Retour au menu</button><p style="color:var(--txt2);text-align:center;margin:30px 0;font-size:.9rem">Aucun d√Æner planifi√© pour ce soir.</p>';
          }
          initIngredients();
        }
      }
    });
    if(needRW) rW();
  }
  appliquerDepuisFirebase(data.courses || {}, data.menus || {});
  ingredientsFirebase = data.ingredients || null;
  appliquerIngredientsFirebase(ingredientsFirebase);
  if(data.sites_ressources) {
    sitesExtra = Object.keys(data.sites_ressources).map(function(key) {
      var s = data.sites_ressources[key];
      s._fbKey = key;
      return s;
    });
    afficherSourcesPerso();
  }
  if(data.profil) {
    profilExtra = {};
    Object.keys(data.profil).forEach(function(champ) {
      var val = data.profil[champ];
      profilExtra[champ] = Array.isArray(val) ? val : Object.values(val);
    });
  }
  // Taxonomie personnalis√©e
  if (data.tag_taxonomy_custom) {
    var tc = data.tag_taxonomy_custom;
    taxonomieActive = Object.keys(tc).map(function(cat) {
      var tags = tc[cat];
      return {cat: cat, tags: Array.isArray(tags) ? tags : Object.values(tags||{})};
    });
  }
  recettesPerso = data.recettes_perso
    ? Object.keys(data.recettes_perso).map(function(key) {
        var r = data.recettes_perso[key];
        r._fbKey = key;
        return r;
      })
    : [];
  recettesPersoMap = {};
  recettesPerso.forEach(function(r) {
    recettesPersoMap[r._fbKey || ('local-'+r.nom)] = r;
  });
  afficherRecettesPerso();
  // Sync produits_habituels
  produitsHabituels = data.produits_habituels
    ? Object.keys(data.produits_habituels).map(function(key){
        var p=data.produits_habituels[key];
        return p ? {nom:p.nom||'',rayon:p.rayon||'divers',a_ajouter:!!p.a_ajouter,_fbKey:key} : null;
      }).filter(Boolean)
    : [];
  afficherTousProduits();
});

afficherSourcesDefaut();

// ===== PHASE 9 ‚Äî TOUS MES PRODUITS =====
var TP_RAYON_LABELS={legumes:'ü•¨ L√©gumes',fruits:'üçé Fruits',viandes:'ü•© Viandes',laitier:'ü•ö Laitier',feculents:'üåæ F√©culents',epicerie:'ü´ô √âpicerie',boulangerie:'üçû Boulangerie',herbes:'üåø Herbes',oleagineux:'ü•ú Ol√©agineux',traiteur:'ü´ï Traiteur',boissons:'ü•§ Boissons',surgeles:'üßä Surgel√©s',entretien:'üßπ Entretien',sante:'üíä Sant√©',corps:'üß¥ Corps',divers:'üè∑Ô∏è Divers'};

function afficherTousProduits(){
  var search=(document.getElementById('tp-search').value||'').toLowerCase().trim();
  var liste=document.getElementById('tp-liste');
  // Badge count sur le bouton "√Ä ajouter"
  var countAjouter=produitsHabituels.filter(function(p){return p.a_ajouter;}).length;
  var badgeEl=document.getElementById('tp-ajouter-count');
  if(badgeEl)badgeEl.textContent=countAjouter>0?countAjouter:'';
  var btnAjouter=document.querySelector('.tp-filtre-ajouter');
  if(btnAjouter)btnAjouter.classList.toggle('plein',countAjouter>0);
  if(tpVueAjouter){
    // === Vue "√Ä ajouter" : inbox des nouveaux produits ===
    var items=produitsHabituels.filter(function(p){return !!p.a_ajouter;});
    if(!items.length){
      liste.innerHTML='<p class="mr-empty">Aucun produit en attente. Ajoutez des produits manuellement dans l\'onglet Courses ‚Äî ils arriveront ici automatiquement.</p>';
      return;
    }
    var rayonOpts=Object.keys(TP_RAYON_LABELS).map(function(k){return '<option value="'+k+'">'+TP_RAYON_LABELS[k]+'</option>';}).join('');
    liste.innerHTML=items.map(function(p){
      var keyEsc=(p._fbKey||'').replace(/'/g,"\\'");
      var opts=Object.keys(TP_RAYON_LABELS).map(function(k){return '<option value="'+k+'"'+(k===p.rayon?' selected':'')+'>'+TP_RAYON_LABELS[k]+'</option>';}).join('');
      return '<div class="tp-item">'+
        '<span class="tp-nom">'+p.nom+'</span>'+
        '<select class="tp-rsel" id="rsel-'+p._fbKey+'">'+opts+'</select>'+
        '<button class="tp-btn-ok" onclick="adopterProduit(\''+keyEsc+'\')" title="Confirmer dans le catalogue">‚úì</button>'+
        '<button class="tp-btn-del" onclick="supprimerProduitHabitude(\''+keyEsc+'\')" title="Supprimer">‚úï</button>'+
        '</div>';
    }).join('');
    return;
  }
  // === Vue normale : produits confirm√©s ===
  var items=produitsHabituels.filter(function(p){
    if(p.a_ajouter)return false;
    if(Object.keys(tpFiltresActifs).length>0&&!tpFiltresActifs[p.rayon])return false;
    if(search&&!(p.nom||'').toLowerCase().includes(search))return false;
    return true;
  });
  if(!items.length){
    var hasConfirmed=produitsHabituels.some(function(p){return !p.a_ajouter;});
    var msg=hasConfirmed?'Aucun r√©sultat.':(produitsHabituels.length?'Validez vos produits depuis ‚è≥ √Ä ajouter.':'Aucun produit enregistr√©. Ajoutez des produits dans l\'onglet Courses.');
    liste.innerHTML='<p class="mr-empty">'+msg+'</p>';
    return;
  }
  items=items.slice().sort(function(a,b){return a.rayon!==b.rayon?a.rayon.localeCompare(b.rayon):a.nom.localeCompare(b.nom);});
  liste.innerHTML=items.map(function(p){
    var keyEsc=(p._fbKey||'').replace(/'/g,"\\'");
    return '<div class="tp-item">'+
      '<span class="tp-nom">'+p.nom+'</span>'+
      '<span class="tp-rayon-badge">'+(TP_RAYON_LABELS[p.rayon]||p.rayon)+'</span>'+
      '<button class="tp-btn-del" onclick="supprimerProduitHabitude(\''+keyEsc+'\')" title="Supprimer du catalogue">‚úï</button>'+
      '</div>';
  }).join('');
}

function selFiltreTP(btn){
  var rayon=btn.dataset.rayon;
  document.querySelectorAll('.tp-filtre').forEach(function(b){b.classList.remove('on');});
  if(rayon==='__ajouter__'){
    tpVueAjouter=true;
    tpFiltresActifs={};
    btn.classList.add('on');
  }else if(rayon===''){
    tpVueAjouter=false;
    tpFiltresActifs={};
    btn.classList.add('on');
  }else{
    tpVueAjouter=false;
    if(tpFiltresActifs[rayon]){delete tpFiltresActifs[rayon];}
    else{tpFiltresActifs[rayon]=true;}
    btn.classList.toggle('on',!!tpFiltresActifs[rayon]);
    var btnTous=document.querySelector('.tp-filtre[data-rayon=""]');
    if(btnTous)btnTous.classList.toggle('on',Object.keys(tpFiltresActifs).length===0);
  }
  afficherTousProduits();
}

function adopterProduit(key){
  var rsel=document.getElementById('rsel-'+key);
  var upd={a_ajouter:null};
  if(rsel)upd.rayon=rsel.value;
  if(db)db.ref('produits_habituels/'+key).update(upd);
  var p=produitsHabituels.find(function(x){return x._fbKey===key;});
  if(p){p.a_ajouter=false;if(rsel)p.rayon=rsel.value;}
  afficherTousProduits();
}

function supprimerProduitHabitude(key){
  if(!key)return;
  if(db)db.ref('produits_habituels/'+key).remove();
  produitsHabituels=produitsHabituels.filter(function(p){return p._fbKey!==key;});
  afficherTousProduits();
}
</script>

<!-- ===== MODALE GESTION TAGS ===== -->
<div class="tag-mgr-overlay" id="tag-mgr-overlay" style="display:none" onclick="if(event.target===this)fermerGestionTags()">
  <div class="tag-mgr-modal">
    <div class="tag-mgr-hdr">
      <h3>‚öôÔ∏è Personnaliser les tags</h3>
      <button class="tag-mgr-close" onclick="fermerGestionTags()">‚úï</button>
    </div>
    <div id="tag-mgr-content"></div>
  </div>
</div>

</body>
</html>
