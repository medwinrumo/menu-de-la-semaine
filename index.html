
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planificateur Menus SantÃ© â€” 14-20 fÃ©v 2026</title>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<style>
:root{--bg:#f6f5f1;--bg2:#fff;--txt:#1a2a2a;--txt2:#5f6b7a;--acc:#1a8a7d;--acc2:#14706a;--accL:rgba(26,138,125,.1);--border:rgba(0,0,0,.09);--card:#fff;--sh:0 2px 8px rgba(0,0,0,.05);--sh2:0 4px 14px rgba(0,0,0,.08);--r:10px;--r2:14px}
@media(prefers-color-scheme:dark){:root{--bg:#141919;--bg2:#1c2222;--txt:#e4eded;--txt2:#8a9a9a;--acc:#2dd4bf;--acc2:#5eead4;--accL:rgba(45,212,191,.12);--border:rgba(255,255,255,.08);--card:#1c2222}}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--txt);line-height:1.6}
.wrap{max-width:1140px;margin:0 auto;padding:14px}
header{text-align:center;padding:28px 16px;background:var(--card);border-radius:var(--r2);box-shadow:var(--sh2);margin-bottom:20px;border:1px solid var(--border)}
header h1{font-size:1.7rem;color:var(--acc)}
header p{color:var(--txt2);font-size:.88rem;margin-top:4px}
.wk{display:inline-block;margin-top:8px;padding:5px 14px;background:var(--acc);color:#fff;border-radius:20px;font-size:.8rem;font-weight:600}
.tabs{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap;justify-content:center;position:sticky;top:0;z-index:200;background:var(--bg);padding:10px 0}
.tabs button{padding:9px 18px;background:var(--card);border:2px solid var(--border);border-radius:var(--r);color:var(--txt);font-size:.9rem;font-weight:600;cursor:pointer;transition:.2s}
.tabs button:hover{border-color:var(--acc);color:var(--acc)}
.tabs button.on{background:var(--acc);color:#fff;border-color:var(--acc)}
.pnl{display:none}.pnl.on{display:block;animation:fu .25s ease}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(310px,1fr));gap:16px;margin-bottom:20px}
.day{background:var(--card);border-radius:var(--r2);padding:16px;box-shadow:var(--sh);border:1px solid var(--border)}
.day h3{color:var(--acc);font-size:1.15rem;margin-bottom:10px;padding-bottom:7px;border-bottom:2px solid var(--acc)}
.meal{margin-bottom:8px;padding:8px 10px;background:var(--bg);border-radius:var(--r);border-left:3px solid var(--acc)}
.ml{font-weight:700;color:var(--acc);font-size:.72rem;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.mc{color:var(--txt);font-size:.85rem;line-height:1.45}
.swap-row{display:flex;gap:4px;margin-top:8px;align-items:center;flex-wrap:wrap;opacity:.4;transition:.2s}
.swap-row:hover{opacity:1}
.swap-row select{padding:3px 6px;border:1px solid var(--border);border-radius:4px;font-size:.7rem;background:var(--card);color:var(--txt2);flex:1;min-width:0}
.swap-row button{padding:3px 8px;background:var(--bg);color:var(--txt2);border:1px solid var(--border);border-radius:4px;font-size:.68rem;cursor:pointer;white-space:nowrap}
.swap-row button:hover{background:var(--acc);color:#fff;border-color:var(--acc)}
.recipe{background:var(--card);border-radius:var(--r2);margin-bottom:20px;box-shadow:var(--sh);border:1px solid var(--border);padding:22px}
.recipe-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:4px}
.recipe-top h3{color:var(--acc);font-size:1.3rem;flex:1}
.recipe-top .r-ico{font-size:2.2rem;line-height:1;flex-shrink:0}
.recipe-link{display:inline-block;margin-bottom:14px;font-size:.78rem;color:var(--acc);text-decoration:none;padding:3px 10px;background:var(--accL);border-radius:6px;word-break:break-all}
.recipe-link:hover{text-decoration:underline}
.rmeta{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.rmeta span{padding:4px 10px;background:var(--bg);border-radius:var(--r);font-size:.76rem;color:var(--txt2)}
.rmeta span b{color:var(--acc)}
.recipe h4{color:var(--txt);margin:14px 0 8px;font-size:.95rem;border-bottom:1px solid var(--border);padding-bottom:5px}
.recipe ul{list-style:none;padding:0}
.recipe ul li{padding:4px 0 4px 18px;position:relative;font-size:.84rem}
.recipe ul li::before{content:"â€¢";position:absolute;left:3px;color:var(--acc);font-weight:700}
.recipe ol{padding-left:20px}
.recipe ol li{margin-bottom:8px;font-size:.84rem}
.ntag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.7rem;font-weight:600;margin:1px}
.nt1{background:#dcfce7;color:#166534}.nt2{background:#dbeafe;color:#1e40af}.nt3{background:#fef3c7;color:#92400e}
@media(prefers-color-scheme:dark){.nt1{background:#064e3b;color:#6ee7b7}.nt2{background:#1e3a5f;color:#93c5fd}.nt3{background:#451a03;color:#fcd34d}}
.shop{background:var(--card);border-radius:var(--r2);padding:22px;box-shadow:var(--sh);border:1px solid var(--border)}
.shop h2{color:var(--acc);margin-bottom:6px;font-size:1.4rem}
.shop-sub{color:var(--txt2);font-size:.82rem;margin-bottom:16px}
.rayon-nav{display:none;flex-wrap:wrap;gap:5px;margin-bottom:16px;padding:10px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border)}
.rayon-nav.open{display:flex}
.rayon-nav span{padding:5px 10px;font-size:.75rem;color:var(--txt);text-decoration:none;border-radius:6px;background:var(--card);border:1px solid var(--border);white-space:nowrap;cursor:pointer}
.rayon-nav span:hover{background:var(--accL);color:var(--acc);border-color:var(--acc)}
.toggle-rayons{display:inline-block;padding:6px 14px;font-size:.78rem;color:var(--acc);background:var(--accL);border:1px solid var(--acc);border-radius:6px;cursor:pointer;margin-bottom:10px;font-weight:600}
.toggle-rayons:hover{background:var(--acc);color:#fff}
.scat{margin-bottom:20px;scroll-margin-top:10px}
.scat h4{color:var(--acc);font-size:1rem;margin-bottom:8px;padding-bottom:5px;border-bottom:2px solid var(--acc);position:sticky;top:0;background:var(--card);z-index:2;padding-top:6px}
.sitem{display:flex;align-items:flex-start;gap:8px;padding:7px 10px;margin-bottom:5px;background:var(--bg);border-radius:var(--r);cursor:pointer;transition:.15s}
.sitem:hover{box-shadow:var(--sh)}
.sitem input[type=checkbox]{width:17px;height:17px;accent-color:var(--acc);cursor:pointer;flex-shrink:0;margin-top:2px}
.sitem .sn{font-weight:500;flex:1;font-size:.84rem;min-width:0}
.sitem .sr{font-size:.72rem;color:var(--txt2);font-style:italic;text-align:right;max-width:55%;line-height:1.3}
.caddie{margin-top:26px;padding:18px;background:var(--bg);border-radius:var(--r2);border:2px dashed var(--acc)}
.caddie h3{color:var(--acc);margin-bottom:12px;font-size:1.1rem}
.caddie-empty{color:var(--txt2);font-style:italic;font-size:.85rem}
.add-area{margin-top:22px;padding:18px;background:var(--bg);border-radius:var(--r2);border:1px solid var(--border)}
.add-area h4{color:var(--acc);margin-bottom:10px;font-size:.95rem}
.add-row{display:flex;gap:6px;flex-wrap:wrap}
.add-row input,.add-row select{padding:8px 10px;border:2px solid var(--border);border-radius:var(--r);font-size:.84rem;background:var(--card);color:var(--txt)}
.add-row input{flex:1;min-width:100px}
.add-row input:focus,.add-row select:focus{outline:none;border-color:var(--acc)}
.add-row button{padding:8px 16px;background:var(--acc);color:#fff;border:none;border-radius:var(--r);font-size:.84rem;font-weight:600;cursor:pointer}
.ctr{text-align:center;padding:10px;background:var(--bg);border-radius:var(--r);font-size:.84rem;color:var(--txt2);margin-bottom:16px}
.ctr b{color:var(--acc);font-size:1rem}
.ph{font-size:.8rem;color:var(--txt2);padding:6px 10px;font-style:italic}
.btn-print{position:fixed;bottom:20px;right:20px;padding:10px 18px;background:var(--acc);color:#fff;border:none;border-radius:30px;font-size:.85rem;font-weight:600;cursor:pointer;box-shadow:var(--sh2);z-index:100;transition:.2s}
.btn-print:hover{transform:translateY(-2px);background:var(--acc2)}
@media print{.tabs,.btn-print,.add-area,.caddie,.swap-row,.recipe-link,.toggle-rayons,.rayon-nav{display:none!important}.pnl{display:block!important}.sitem input{display:none}.wrap{padding:0}header,.day,.recipe,.shop{box-shadow:none;border:1px solid #ddd;break-inside:avoid}}
@media(max-width:700px){header h1{font-size:1.3rem}.grid{grid-template-columns:1fr}.tabs{flex-direction:column}.tabs button{width:100%}.sitem{flex-wrap:wrap}.sitem .sr{max-width:100%;text-align:left}}
@media(orientation:landscape) and (max-height:500px){.grid{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}.wrap{padding:8px}}
.meal-din{cursor:pointer;transition:.15s}.meal-din:hover{background:var(--accL);border-left-color:var(--acc2)}
.lien-din{font-size:.62rem;font-weight:400;opacity:.55;margin-left:5px}
.btn-back{margin-bottom:14px;padding:6px 14px;background:var(--accL);color:var(--acc);border:1px solid var(--acc);border-radius:6px;font-size:.8rem;font-weight:600;cursor:pointer}
.btn-back:hover{background:var(--acc);color:#fff}
.recipe ul li.ing-item{cursor:pointer;border-radius:4px;transition:.12s;padding-right:6px}
.recipe ul li.ing-item:hover{background:var(--accL);padding-left:22px}
.recipe ul li.ing-item:hover::after{content:" âœï¸";font-size:.65rem;opacity:.7}
.ing-edit{display:flex;gap:4px;align-items:center;flex-wrap:wrap;padding:3px 0 3px 0;list-style:none}
.ing-edit input{flex:1;min-width:90px;padding:5px 8px;border:2px solid var(--acc);border-radius:4px;font-size:.82rem;background:var(--card);color:var(--txt)}
.ing-edit select{padding:4px 5px;border:1px solid var(--border);border-radius:4px;font-size:.7rem;background:var(--card);color:var(--txt2)}
.ing-btn-ok{padding:5px 10px;background:var(--acc);color:#fff;border:none;border-radius:4px;font-size:.75rem;cursor:pointer;font-weight:600}
.ing-btn-cancel{padding:5px 8px;background:var(--bg);color:var(--txt2);border:1px solid var(--border);border-radius:4px;font-size:.75rem;cursor:pointer}
.ing-changed{color:var(--acc);font-style:italic}
.ing-hint{font-size:.72rem;color:var(--txt2);font-style:italic;margin:4px 0 8px;opacity:.7}
.chat-wrap{display:flex;flex-direction:column;height:calc(100vh - 220px);min-height:380px;background:var(--card);border-radius:var(--r2);border:1px solid var(--border);overflow:hidden}
.chat-messages{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
.msg{display:flex;flex-direction:column;max-width:88%}
.msg-user{align-self:flex-end;align-items:flex-end}
.msg-bot{align-self:flex-start;align-items:flex-start}
.msg-bubble{padding:10px 14px;border-radius:18px;font-size:.84rem;line-height:1.55;word-break:break-word}
.msg-user .msg-bubble{background:var(--acc);color:#fff;border-bottom-right-radius:4px}
.msg-bot .msg-bubble{background:var(--bg);color:var(--txt);border:1px solid var(--border);border-bottom-left-radius:4px}
.msg-action .msg-bubble{background:var(--accL)!important;border-color:var(--acc)!important;color:var(--acc)!important;font-weight:600}
.msg-bubble ul{padding-left:16px;margin:6px 0}
.msg-bubble li{margin-bottom:3px}
.chat-typing .msg-bubble{color:var(--txt2);font-style:italic}
.chat-input-area{display:flex;gap:8px;padding:10px 12px;border-top:1px solid var(--border);align-items:flex-end;background:var(--card)}
.chat-input-area textarea{flex:1;padding:10px 12px;border:2px solid var(--border);border-radius:14px;font-size:.85rem;background:var(--bg);color:var(--txt);resize:none;font-family:inherit;line-height:1.4;max-height:120px}
.chat-input-area textarea:focus{outline:none;border-color:var(--acc)}
#btn-chat-send{padding:10px 16px;background:var(--acc);color:#fff;border:none;border-radius:14px;font-size:1.1rem;cursor:pointer;flex-shrink:0;transition:.15s}
#btn-chat-send:hover{background:var(--acc2)}
#btn-chat-send:disabled{opacity:.5;cursor:wait}
.btn-gen{margin-top:12px;padding:9px 22px;background:var(--acc);color:#fff;border:none;border-radius:20px;font-size:.85rem;font-weight:600;cursor:pointer;transition:.2s;display:inline-block}
.btn-gen:hover{background:var(--acc2);transform:translateY(-2px)}
.btn-gen:disabled{opacity:.6;cursor:wait;transform:none}
.btn-swap{margin-top:10px;padding:7px 14px;background:var(--bg);color:var(--txt2);border:1px solid var(--border);border-radius:var(--r);font-size:.78rem;cursor:pointer;width:100%;transition:.15s;text-align:center}
.btn-swap:hover{background:var(--accL);color:var(--acc);border-color:var(--acc)}
.btn-swap:disabled{opacity:.5;cursor:wait}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:300;align-items:center;justify-content:center;padding:16px}
.modal-overlay.on{display:flex}
.modal{background:var(--card);border-radius:var(--r2);padding:24px;max-width:540px;width:100%;max-height:88vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,.25)}
.modal-head{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px}
.modal-head h2{color:var(--acc);font-size:1.2rem;flex:1}
.modal-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--txt2);flex-shrink:0;margin-left:8px}
.modal .rmeta{margin-bottom:12px}
.modal h4{color:var(--txt);margin:12px 0 6px;font-size:.9rem;border-bottom:1px solid var(--border);padding-bottom:4px}
.modal ul{list-style:none;padding:0}
.modal ul li{padding:3px 0 3px 18px;position:relative;font-size:.83rem}
.modal ul li::before{content:"â€¢";position:absolute;left:3px;color:var(--acc);font-weight:700}
.modal ol{padding-left:20px}
.modal ol li{margin-bottom:6px;font-size:.83rem}
.modal-actions{display:flex;gap:8px;margin-top:18px;flex-wrap:wrap}
.btn-accept{padding:9px 18px;background:var(--acc);color:#fff;border:none;border-radius:var(--r);font-size:.85rem;font-weight:600;cursor:pointer;flex:1}
.btn-accept:hover{background:var(--acc2)}
.btn-reject{padding:9px 18px;background:var(--bg);color:var(--txt2);border:1px solid var(--border);border-radius:var(--r);font-size:.85rem;cursor:pointer;flex:1}
.btn-reject:hover{border-color:var(--acc);color:var(--acc)}
</style>
</head>
<body>
<div class="wrap">
<header>
<h1>ğŸ½ï¸ Planificateur Menus SantÃ©</h1>
<p>Ã‰quilibrÃ© â€¢ Anti-cholestÃ©rol â€¢ IG bas â€¢ Gourmand</p>
<div class="wk" id="wk-label">ğŸ“… Samedi 14 â†’ Vendredi 20 fÃ©vrier 2026</div>
<br>
<button id="btn-gen" class="btn-gen" onclick="genererSemaine()">ğŸ—“ï¸ GÃ©nÃ©rer la semaine</button>
</header>
<div class="tabs">
<button class="on" onclick="tab('apercu',this)">ğŸ“… Semaine</button>
<button onclick="tab('recettes',this)">ğŸ‘¨â€ğŸ³ Recettes</button>
<button onclick="tab('courses',this)">ğŸ›’ Liste de courses</button>
<button onclick="tab('chat',this)">ğŸ’¬ NutriCoach</button>
</div>

<!-- ===== APERÃ‡U ===== -->
<div id="apercu" class="pnl on">
<div class="grid" id="weekgrid"></div>
<div class="ctr">
<span class="ntag nt1">IG bas</span> <span class="ntag nt2">Anti-cholestÃ©rol</span> <span class="ntag nt3">Fibres &amp; omÃ©ga-3</span><br><br>
PrÃ©pa <b>â‰¤ 30 min</b> â€¢ Cuisson <b>â‰¤ 45 min</b> â€¢ LÃ©gumes de <b>saison fÃ©vrier</b>
</div>
</div>

<!-- ===== RECETTES ===== -->
<div id="recettes" class="pnl">

<div class="recipe" id="recipe-0">
<button class="btn-back" onclick="goMenu()">â† Retour au menu</button>
<div class="recipe-top"><h3>Tajine de poulet, lÃ©gumes d'hiver et pois chiches</h3><div class="r-ico">ğŸ¥˜</div></div>
<a class="recipe-link" href="https://lacerisesurlemaillot.fr/poulet-au-four-facon-tajine/" target="_blank" rel="noopener">ğŸ”— Recette similaire sur LaCeriseSurLeMaillot.fr (IG bas)</a>
<div class="rmeta"><span><b>PrÃ©pa :</b> 20 min</span><span><b>Cuisson :</b> 35 min</span><span><b>Pour :</b> 2</span><span><b>ğŸ“…</b> Sam. 14</span></div>
<h4>IngrÃ©dients</h4>
<ul>
<li>400g cuisses ou blancs de poulet fermier en morceaux</li>
<li>1 boÃ®te pois chiches Ã©gouttÃ©s (240g)</li>
<li>3 carottes en rondelles â€¢ 2 navets en quartiers â€¢ Â½ butternut en cubes</li>
<li>1 oignon Ã©mincÃ© â€¢ 2 gousses d'ail</li>
<li>1 boÃ®te tomates concassÃ©es (400g) â€¢ 300ml bouillon de volaille</li>
<li>1 c.c. chaque : curcuma, cumin, paprika, gingembre + pincÃ©e cannelle</li>
<li>2 c.s. huile d'olive â€¢ Coriandre fraÃ®che â€¢ 150g boulgour</li>
</ul>
<h4>PrÃ©paration</h4>
<ol>
<li>Chauffer l'huile dans une cocotte, dorer le poulet 5 min. RÃ©server.</li>
<li>Revenir oignon + ail 3 min. Ajouter toutes les Ã©pices 1 min.</li>
<li>Ajouter carottes, navets, butternut, tomates et bouillon.</li>
<li>Remettre poulet + pois chiches. Couvrir, mijoter 30 min feu doux.</li>
<li>Cuire le boulgour 10 min. Parsemer de coriandre, servir.</li>
</ol>
</div>

<div class="recipe" id="recipe-1">
<button class="btn-back" onclick="goMenu()">â† Retour au menu</button>
<div class="recipe-top"><h3>Poulet rÃ´ti citron-romarin, purÃ©e cÃ©leri-panais</h3><div class="r-ico">ğŸ—</div></div>
<a class="recipe-link" href="https://www.santemagazine.fr/alimentation/regime-alimentaire/regime-anti-cholesterol/une-semaine-de-menus-anticholesterol-173890" target="_blank" rel="noopener">ğŸ”— Menus anti-cholestÃ©rol sur SantÃ©Magazine.fr</a>
<div class="rmeta"><span><b>PrÃ©pa :</b> 15 min</span><span><b>Cuisson :</b> 30 min</span><span><b>Pour :</b> 2</span><span><b>ğŸ“…</b> Dim. 15</span></div>
<h4>IngrÃ©dients</h4>
<ul>
<li>400g blancs de poulet â€¢ 2 citrons (jus + zestes) â€¢ 2 branches romarin</li>
<li>2 c.s. huile d'olive â€¢ 2 gousses d'ail â€¢ Sel, poivre</li>
<li><b>PurÃ©e :</b> 1 cÃ©leri-rave (â‰ˆ400g) â€¢ 2 panais â€¢ 1 c.s. crÃ¨me lÃ©gÃ¨re 15% â€¢ Muscade</li>
<li>200g riz basmati</li>
</ul>
<h4>PrÃ©paration</h4>
<ol>
<li>Four 180Â°C. MÃ©langer jus citron, huile, ail, romarin. Mariner 10 min.</li>
<li>Enfourner 25-30 min. Cuire cÃ©leri-rave + panais vapeur 20 min.</li>
<li>Ã‰craser avec crÃ¨me, muscade. Cuire riz 12 min. Servir avec jus de cuisson.</li>
</ol>
</div>

<div class="recipe" id="recipe-2">
<button class="btn-back" onclick="goMenu()">â† Retour au menu</button>
<div class="recipe-top"><h3>Curry de lentilles corail aux lÃ©gumes d'hiver</h3><div class="r-ico">ğŸ›</div></div>
<a class="recipe-link" href="https://cuisinerigbas.com/dhal-lentilles-corail/" target="_blank" rel="noopener">ğŸ”— Recette dahl IG bas sur CuisinerIGbas.com</a>
<div class="rmeta"><span><b>PrÃ©pa :</b> 10 min</span><span><b>Cuisson :</b> 25 min</span><span><b>Pour :</b> 2</span><span><b>ğŸ“…</b> Lun. 17</span></div>
<h4>IngrÃ©dients</h4>
<ul>
<li>200g lentilles corail â€¢ 200ml lait de coco light</li>
<li>2 carottes en rondelles â€¢ 1 navet en dÃ©s â€¢ 1 oignon â€¢ 2 gousses d'ail</li>
<li>2 c.c. curry â€¢ 1 c.c. cumin â€¢ 400ml bouillon lÃ©gumes â€¢ 2 c.s. huile colza</li>
<li>Coriandre fraÃ®che â€¢ 150g quinoa</li>
</ul>
<h4>PrÃ©paration</h4>
<ol>
<li>Rincer lentilles. Revenir oignon + ail dans huile colza 3 min.</li>
<li>Ajouter curry + cumin 1 min. Puis carottes, navet, lentilles, bouillon.</li>
<li>Mijoter 20 min feu doux. Cuire quinoa 12 min.</li>
<li>Ajouter lait de coco, rÃ©chauffer 2 min. Servir sur quinoa + coriandre.</li>
</ol>
</div>

<div class="recipe" id="recipe-3">
<button class="btn-back" onclick="goMenu()">â† Retour au menu</button>
<div class="recipe-top"><h3>Soupe de lÃ©gumes + Omelette champignons-chÃ¨vre</h3><div class="r-ico">ğŸ¥£</div></div>
<a class="recipe-link" href="https://www.primevere.com/idees-recettes/plats/" target="_blank" rel="noopener">ğŸ”— Plats allÃ©gÃ©s sur PrimevÃ¨re.com</a>
<div class="rmeta"><span><b>PrÃ©pa :</b> 15 min</span><span><b>Cuisson :</b> 30 min</span><span><b>Pour :</b> 2</span><span><b>ğŸ“…</b> Mar. 18</span></div>
<h4>IngrÃ©dients</h4>
<ul>
<li><b>Soupe :</b> 2 poireaux â€¢ 2 carottes â€¢ 1 navet â€¢ 1 branche cÃ©leri â€¢ 2 PDT â€¢ 1L bouillon lÃ©gumes â€¢ 1 c.s. huile olive â€¢ Herbes de Provence</li>
<li><b>Omelette :</b> 4 Å“ufs â€¢ 150g champignons â€¢ 30g chÃ¨vre â€¢ 1 c.s. huile olive â€¢ Persil</li>
<li>Pain de seigle</li>
</ul>
<h4>PrÃ©paration</h4>
<ol>
<li>Revenir poireaux 3 min, ajouter lÃ©gumes + bouillon, mijoter 25 min.</li>
<li>Sauter champignons 5 min, verser Å“ufs battus, cuire 3-4 min.</li>
<li>Parsemer chÃ¨vre, plier, cuire 1 min. Servir soupe puis omelette + pain.</li>
</ol>
</div>

<div class="recipe" id="recipe-4">
<button class="btn-back" onclick="goMenu()">â† Retour au menu</button>
<div class="recipe-top"><h3>Dinde sautÃ©e aux champignons, brocolis vapeur</h3><div class="r-ico">ğŸ¦ƒ</div></div>
<a class="recipe-link" href="https://jow.fr/fr/recipes/escalope-de-dinde-a-la-creme-de-champignons-et-puree-maison-8v44i1zqjxs002yd0d3n" target="_blank" rel="noopener">ğŸ”— Recette similaire sur Jow.fr</a>
<div class="rmeta"><span><b>PrÃ©pa :</b> 15 min</span><span><b>Cuisson :</b> 20 min</span><span><b>Pour :</b> 2</span><span><b>ğŸ“…</b> Mer. 19</span></div>
<h4>IngrÃ©dients</h4>
<ul>
<li>400g escalopes dinde en laniÃ¨res â€¢ 300g champignons â€¢ 1 Ã©chalote</li>
<li>2 c.s. crÃ¨me lÃ©gÃ¨re 15% â€¢ 2 c.s. huile olive â€¢ Persil</li>
<li>400g brocolis â€¢ 4 pommes de terre moyennes</li>
</ul>
<h4>PrÃ©paration</h4>
<ol>
<li>Cuire pommes de terre vapeur 20 min + brocolis 12 min.</li>
<li>Dorer dinde 5 min feu vif. RÃ©server. Revenir Ã©chalote + champignons 8 min.</li>
<li>Remettre dinde, crÃ¨me, rÃ©chauffer 3 min. Parsemer persil.</li>
</ol>
</div>

<div class="recipe" id="recipe-5">
<button class="btn-back" onclick="goMenu()">â† Retour au menu</button>
<div class="recipe-top"><h3>Poisson panÃ© maison au four, riz et salade</h3><div class="r-ico">ğŸŸ</div></div>
<a class="recipe-link" href="https://www.cuisineaz.com/diaporamas/15-recettes-a-ig-bas-a-deguster-toute-l-annee-3913/interne/1.aspx" target="_blank" rel="noopener">ğŸ”— Recettes IG bas sur CuisineAZ.com</a>
<div class="rmeta"><span><b>PrÃ©pa :</b> 15 min</span><span><b>Cuisson :</b> 20 min</span><span><b>Pour :</b> 2</span><span><b>ğŸ“…</b> Jeu. 20</span></div>
<h4>IngrÃ©dients</h4>
<ul>
<li>2 filets cabillaud/colin (â‰ˆ400g) â€¢ 80g chapelure complÃ¨te â€¢ 1 Å“uf</li>
<li>2 c.s. farine blÃ© complet â€¢ 1 c.c. paprika â€¢ Zeste 1 citron â€¢ Thym, persil</li>
<li>2 c.s. huile olive â€¢ 200g riz basmati â€¢ MÃ¢che + vinaigrette colza</li>
</ul>
<h4>PrÃ©paration</h4>
<ol>
<li>Four 200Â°C. Paner : farine â†’ Å“uf battu â†’ chapelure assaisonnÃ©e.</li>
<li>Plaque + papier cuisson, filet d'huile. Enfourner 18-20 min.</li>
<li>Cuire riz 12 min. Servir avec mÃ¢che, vinaigrette colza et citron.</li>
</ol>
</div>

<div class="recipe" id="recipe-6">
<button class="btn-back" onclick="goMenu()">â† Retour au menu</button>
<div class="recipe-top"><h3>Salade composÃ©e pommes de terre, betteraves, thon</h3><div class="r-ico">ğŸ¥—</div></div>
<a class="recipe-link" href="https://www.marieclaire.fr/cuisine/18-recettes-anti-cholesterol-saines-et-gourmandes,1453308.asp" target="_blank" rel="noopener">ğŸ”— Recettes anti-cholestÃ©rol sur MarieClaire.fr</a>
<div class="rmeta"><span><b>PrÃ©pa :</b> 15 min</span><span><b>Cuisson :</b> 20 min</span><span><b>Pour :</b> 2</span><span><b>ğŸ“…</b> Ven. 20</span></div>
<h4>IngrÃ©dients</h4>
<ul>
<li>500g pommes de terre Charlotte â€¢ 200g betteraves cuites â€¢ 4 Å“ufs</li>
<li>1 boÃ®te thon naturel (240g) â€¢ 2 tomates â€¢ Â½ oignon rouge â€¢ MÃ¢che</li>
<li>10 olives noires (facult.)</li>
<li><b>Vinaigrette :</b> 3 c.s. huile colza â€¢ 1 c.s. vinaigre cidre â€¢ 1 c.c. moutarde â€¢ Persil, ciboulette</li>
</ul>
<h4>PrÃ©paration</h4>
<ol>
<li>Pommes de terre vapeur 20 min. TiÃ©dir, couper en rondelles.</li>
<li>Å’ufs durs 10 min, refroidir, couper en quartiers.</li>
<li>Vinaigrette : moutarde + vinaigre + sel, fouetter avec huile colza + herbes.</li>
<li>Disposer mÃ¢che, PDT, betteraves, Å“ufs, thon, tomates, oignon. Arroser.</li>
</ol>
</div>
</div>

<!-- ===== CHAT ===== -->
<div id="chat" class="pnl">
<div class="chat-wrap">
  <div class="chat-messages" id="chat-messages">
  </div>
  <div class="chat-input-area">
    <textarea id="chat-input" rows="2" placeholder="Question ou instructionâ€¦"></textarea>
    <button id="btn-chat-send" onclick="envoyerChat()">â¤</button>
  </div>
</div>
</div>

<!-- ===== COURSES ===== -->
<div id="courses" class="pnl">
<div class="shop">
<h2>ğŸ›’ Liste de courses</h2>
<p class="shop-sub">Semaine du 14 au 20 fÃ©vrier 2026 â€” Pour 2 personnes</p>
<div class="ctr" id="compteur"></div>

<div class="toggle-rayons" onclick="document.getElementById('rnav').classList.toggle('open')">ğŸ“ Navigation par rayon â–¾</div>
<div class="rayon-nav" id="rnav">
<span onclick="sTo('cat-legumes')">ğŸ¥¬ LÃ©gumes</span>
<span onclick="sTo('cat-fruits')">ğŸ Fruits</span>
<span onclick="sTo('cat-viandes')">ğŸ¥© Viandes</span>
<span onclick="sTo('cat-laitier')">ğŸ¥š Laitier</span>
<span onclick="sTo('cat-feculents')">ğŸŒ¾ FÃ©culents</span>
<span onclick="sTo('cat-boulangerie')">ğŸ Boulangerie</span>
<span onclick="sTo('cat-epicerie')">ğŸ«™ Ã‰picerie</span>
<span onclick="sTo('cat-herbes')">ğŸŒ¿ Herbes</span>
<span onclick="sTo('cat-oleagineux')">ğŸ¥œ OlÃ©agineux</span>
<span onclick="sTo('cat-traiteur')">ğŸ«• Traiteur</span>
<span onclick="sTo('cat-boissons')">ğŸ¥¤ Boissons</span>
<span onclick="sTo('cat-surgeles')">ğŸ§Š SurgelÃ©s</span>
<span onclick="sTo('cat-entretien')">ğŸ§¹ Entretien</span>
<span onclick="sTo('cat-sante')">ğŸ’Š SantÃ©</span>
<span onclick="sTo('cat-corps')">ğŸ§´ Corps</span>
<span onclick="sTo('cat-divers')">ğŸ·ï¸ Divers</span>
</div>

<div id="liste-principale">

<div class="scat" id="cat-legumes"><h4>ğŸ¥¬ LÃ©gumes frais</h4><div class="si" data-cat="legumes">
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">6 carottes</span><span class="sr">Sam. tajine â€¢ Lun. curry â€¢ Mar. soupe</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 cÃ©leri-rave (â‰ˆ400g)</span><span class="sr">Dim. purÃ©e cÃ©leri-panais</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">2 panais</span><span class="sr">Dim. purÃ©e cÃ©leri-panais</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">3 navets</span><span class="sr">Sam. tajine â€¢ Lun. curry â€¢ Mar. soupe</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Â½ butternut (â‰ˆ400g)</span><span class="sr">Sam. tajine</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">450g champignons de Paris</span><span class="sr">Mar. omelette â€¢ Mer. dinde</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">400g brocolis</span><span class="sr">Mer. dinde champignons</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">2 poireaux</span><span class="sr">Mar. soupe lÃ©gumes</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 branche cÃ©leri</span><span class="sr">Mar. soupe lÃ©gumes</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">2 endives</span><span class="sr">Dim. collation endives-noix</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 concombre</span><span class="sr">Sam. collation cruditÃ©s-houmous</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 botte radis</span><span class="sr">Lun. collation nordique</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 poivron</span><span class="sr">Mer. collation cruditÃ©s-tzatziki</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">3 sachets mÃ¢che/laitue</span><span class="sr">Sam. tajine â€¢ Lun. curry â€¢ Jeu. poisson â€¢ Ven. salade</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">5 oignons + Â½ oignon rouge</span><span class="sr">Sam. tajine â€¢ Lun. curry â€¢ Mar. soupe â€¢ Ven. salade</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 Ã©chalote</span><span class="sr">Mer. dinde champignons</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 tÃªte d'ail</span><span class="sr">Sam. tajine â€¢ Dim. poulet â€¢ Lun. curry â€¢ Mar. soupe</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">3 tomates</span><span class="sr">Ven. salade composÃ©e</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 barquette tomates cerises</span><span class="sr">Dim. collation endives-noix</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">200g betteraves cuites</span><span class="sr">Ven. salade + collation houmous betterave</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">100g Ã©pinards frais</span><span class="sr">Mar. collation smoothie vert</span></label>
</div></div>

<div class="scat" id="cat-fruits"><h4>ğŸ Fruits</h4><div class="si" data-cat="fruits">
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">3 pommes</span><span class="sr">Sam.+Mar. petits-dÃ©j</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 poire</span><span class="sr">Lun. petit-dÃ©j</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">2 oranges</span><span class="sr">Dim.+Ven. petits-dÃ©j</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 kiwi</span><span class="sr">Jeu. petit-dÃ©j</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">2 clÃ©mentines</span><span class="sr">Mer. petit-dÃ©j</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 banane</span><span class="sr">Mar. collation smoothie vert</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Fruits de saison variÃ©s</span><span class="sr">Jeu. collation salade de fruits</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">5 citrons</span><span class="sr">Quotidien eau citronnÃ©e â€¢ Dim. poulet â€¢ Jeu. poisson</span></label>
</div></div>

<div class="scat" id="cat-viandes"><h4>ğŸ¥© Viandes, Volailles & Poissons</h4><div class="si" data-cat="viandes">
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">400g cuisses/blancs poulet</span><span class="sr">Sam. tajine poulet pois chiches</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">400g blancs poulet</span><span class="sr">Dim. poulet rÃ´ti citron-romarin</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">400g escalopes dinde</span><span class="sr">Mer. dinde sautÃ©e champignons</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">400g filets cabillaud/colin</span><span class="sr">Jeu. poisson panÃ© maison</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 boÃ®te thon naturel (240g)</span><span class="sr">Ven. salade composÃ©e</span></label>
</div></div>

<div class="scat" id="cat-laitier"><h4>ğŸ¥š Å’ufs & Produits laitiers</h4><div class="si" data-cat="laitier">
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">15 Å“ufs</span><span class="sr">Dim.+Mer.+Ven. pdj â€¢ Lun. collation â€¢ Mar. omelette â€¢ Jeu. panure â€¢ Ven. salade</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">500g fromage blanc 0/3%</span><span class="sr">Sam.+Lun.+Jeu. petits-dÃ©j</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">2 yaourts nature</span><span class="sr">Mar. petit-dÃ©j â€¢ Jeu. collation salade fruits</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">100ml crÃ¨me lÃ©gÃ¨re 15%</span><span class="sr">Dim. purÃ©e cÃ©leri â€¢ Mer. dinde champignons</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">30g fromage de chÃ¨vre</span><span class="sr">Mar. omelette champignons-chÃ¨vre</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">100g beurre demi-sel</span><span class="sr">Dim.+Mer. petits-dÃ©j (modÃ©rÃ©)</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">200ml lait d'amande</span><span class="sr">Mar. collation smoothie vert</span></label>
</div></div>

<div class="scat" id="cat-feculents"><h4>ğŸŒ¾ FÃ©culents & LÃ©gumineuses</h4><div class="si" data-cat="feculents">
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">400g riz basmati</span><span class="sr">Dim. poulet rÃ´ti â€¢ Jeu. poisson panÃ©</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">150g quinoa</span><span class="sr">Lun. curry lentilles</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">150g boulgour</span><span class="sr">Sam. tajine poulet</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">200g lentilles corail</span><span class="sr">Lun. curry lentilles</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 boÃ®te pois chiches (400g)</span><span class="sr">Sam. tajine poulet</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">80g chapelure complÃ¨te</span><span class="sr">Jeu. poisson panÃ© maison</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Farine blÃ© complet (2 c.s.)</span><span class="sr">Jeu. poisson panÃ© maison</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1kg pommes de terre Charlotte</span><span class="sr">Mar. soupe â€¢ Mer. dinde â€¢ Ven. salade</span></label>
</div></div>

<div class="scat" id="cat-boulangerie"><h4>ğŸ Boulangerie</h4><div class="si" data-cat="boulangerie">
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 pain de seigle tranchÃ©</span><span class="sr">Sam.+Dim. petits-dÃ©j â€¢ Mar. omelette</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 pain aux cÃ©rÃ©ales</span><span class="sr">Mer. petit-dÃ©j</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 pain complet</span><span class="sr">Ven. petit-dÃ©j</span></label>
</div></div>

<div class="scat" id="cat-epicerie"><h4>ğŸ«™ Ã‰picerie & Condiments</h4><div class="si" data-cat="epicerie">
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Huile d'olive</span><span class="sr">Sam. tajine â€¢ Dim. poulet â€¢ Mar. soupe+omelette â€¢ Mer. dinde â€¢ Jeu. poisson</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Huile de colza</span><span class="sr">Lun. curry+collation â€¢ Jeu.+Ven. vinaigrettes</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 boÃ®te lait coco light</span><span class="sr">Lun. curry lentilles</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 boÃ®te tomates concassÃ©es</span><span class="sr">Sam. tajine poulet</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Ã‰pices : curry, cumin, paprika, curcuma, gingembre, cannelle</span><span class="sr">Sam. tajine â€¢ Lun. curry â€¢ Jeu. poisson</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Herbes de Provence</span><span class="sr">Mar. soupe lÃ©gumes</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Miel</span><span class="sr">Sam.+Lun. petits-dÃ©j</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Moutarde de Dijon</span><span class="sr">Ven. vinaigrette salade composÃ©e</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Vinaigre de cidre</span><span class="sr">Ven. vinaigrette salade composÃ©e</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Bouillon lÃ©gumes (cubes)</span><span class="sr">Lun. curry â€¢ Mar. soupe</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Bouillon volaille (cubes)</span><span class="sr">Sam. tajine poulet</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">10 olives noires (facult.)</span><span class="sr">Ven. salade composÃ©e</span></label>
</div></div>

<div class="scat" id="cat-herbes"><h4>ğŸŒ¿ Herbes fraÃ®ches</h4><div class="si" data-cat="herbes">
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">2 branches romarin</span><span class="sr">Dim. poulet rÃ´ti citron-romarin</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 bouquet persil</span><span class="sr">Mar. omelette â€¢ Mer. dinde â€¢ Ven. vinaigrette</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 bouquet coriandre</span><span class="sr">Sam. tajine â€¢ Lun. curry</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">1 bouquet ciboulette</span><span class="sr">Ven. vinaigrette salade composÃ©e</span></label>
</div></div>

<div class="scat" id="cat-oleagineux"><h4>ğŸ¥œ OlÃ©agineux & Graines</h4><div class="si" data-cat="oleagineux">
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">200g amandes</span><span class="sr">Sam.+Jeu. petits-dÃ©j</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">200g noix</span><span class="sr">Lun. petit-dÃ©j â€¢ Dim. collation endives-noix</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">100g noisettes</span><span class="sr">Mar. petit-dÃ©j</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">50g graines de courge</span><span class="sr">Lun. petit-dÃ©j â€¢ Jeu. collation</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">50g graines de lin moulues</span><span class="sr">Mar. smoothie â€¢ Jeu. petit-dÃ©j</span></label>
</div></div>

<div class="scat" id="cat-traiteur"><h4>ğŸ«• Fait maison / Traiteur</h4><div class="si" data-cat="traiteur">
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Houmous (maison ou pot)</span><span class="sr">Sam. collation cruditÃ©s</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Houmous de betterave</span><span class="sr">Ven. collation cruditÃ©s</span></label>
<label class="sitem"><input type="checkbox" onchange="bascule(this)"><span class="sn">Tzatziki (maison ou pot)</span><span class="sr">Mer. collation cruditÃ©s</span></label>
</div></div>

<div class="scat" id="cat-boissons"><h4>ğŸ¥¤ Boissons</h4><div class="si" data-cat="boissons"></div>
<p class="ph">Ajoutez ci-dessous : eau, jus, cafÃ©, thÃ©, lait vÃ©gÃ©talâ€¦</p></div>

<div class="scat" id="cat-surgeles"><h4>ğŸ§Š SurgelÃ©s</h4><div class="si" data-cat="surgeles"></div>
<p class="ph">Ajoutez ci-dessous : lÃ©gumes surgelÃ©s, poisson surgelÃ©â€¦</p></div>

<div class="scat" id="cat-entretien"><h4>ğŸ§¹ Entretien</h4><div class="si" data-cat="entretien"></div>
<p class="ph">Ajoutez ci-dessous : liquide vaisselle, lessive, nettoyant, Ã©pongesâ€¦</p></div>

<div class="scat" id="cat-sante"><h4>ğŸ’Š SantÃ© / Pharmacie</h4><div class="si" data-cat="sante"></div>
<p class="ph">Ajoutez ci-dessous : pansements, vitaminesâ€¦</p></div>

<div class="scat" id="cat-corps"><h4>ğŸ§´ Soin du corps</h4><div class="si" data-cat="corps"></div>
<p class="ph">Ajoutez ci-dessous : shampoing, savon, crÃ¨meâ€¦</p></div>

<div class="scat" id="cat-divers"><h4>ğŸ·ï¸ Divers</h4><div class="si" data-cat="divers"></div>
<p class="ph">Ajoutez ci-dessous : piles, ampoulesâ€¦</p></div>

</div>

<div class="caddie"><h3>âœ… Dans le caddie</h3>
<div id="caddie"><p class="caddie-empty">Cochez les produits pour les ajouter ici.</p></div></div>

<div class="add-area"><h4>â• Ajouter un produit</h4>
<div class="add-row">
<input type="text" id="add-nom" placeholder="Nom du produit" onkeydown="if(event.key==='Enter')ajP()">
<select id="add-rayon">
<option value="legumes">ğŸ¥¬ LÃ©gumes</option><option value="fruits">ğŸ Fruits</option>
<option value="viandes">ğŸ¥© Viandes</option><option value="laitier">ğŸ¥š Laitier</option>
<option value="feculents">ğŸŒ¾ FÃ©culents</option><option value="boulangerie">ğŸ Boulangerie</option>
<option value="epicerie">ğŸ«™ Ã‰picerie</option><option value="herbes">ğŸŒ¿ Herbes</option>
<option value="oleagineux">ğŸ¥œ OlÃ©agineux</option><option value="traiteur">ğŸ«• Traiteur</option>
<option value="boissons">ğŸ¥¤ Boissons</option><option value="surgeles">ğŸ§Š SurgelÃ©s</option>
<option value="entretien">ğŸ§¹ Entretien</option><option value="sante">ğŸ’Š SantÃ©</option>
<option value="corps">ğŸ§´ Corps</option><option value="divers" selected>ğŸ·ï¸ Divers</option>
</select>
<button onclick="ajP()">Ajouter</button>
</div></div>

<p style="margin-top:20px;padding:14px;background:var(--bg);border-radius:var(--r);font-size:.8rem;color:var(--txt2)">
<b>ğŸ’¡</b> Cochez â†’ produit dans le caddie. DÃ©cochez dans le caddie â†’ retour liste. Cliquez Â« Navigation par rayon Â» pour sauter Ã  une catÃ©gorie.
</p>
</div>
</div>

<div class="modal-overlay" id="recette-modal">
<div class="modal">
  <div class="modal-head">
    <h2 id="modal-titre"></h2>
    <button class="modal-close" onclick="fermerModal()">âœ•</button>
  </div>
  <div class="rmeta" id="modal-meta"></div>
  <h4>IngrÃ©dients</h4>
  <ul id="modal-ingredients"></ul>
  <h4>PrÃ©paration</h4>
  <ol id="modal-etapes"></ol>
  <div class="modal-actions">
    <button class="btn-accept" onclick="accepterRecette()">âœ“ Adopter cette recette</button>
    <button class="btn-reject" onclick="chercherAutre()">â†º En chercher une autre</button>
  </div>
</div>
</div>
</div>

<script>
var J=[
{id:0,nom:"Samedi 14",pdj:"Eau citronnÃ©e â€¢ Fromage blanc 3% + miel â€¢ 1 pomme â€¢ 6 amandes",col:"BÃ¢tonnets carottes et concombre â€¢ Houmous",din:"Tajine de poulet, lÃ©gumes d'hiver et pois chiches â€¢ Boulgour â€¢ MÃ¢che",dn:"Tajine poulet"},
{id:1,nom:"Dimanche 15",pdj:"Eau citronnÃ©e â€¢ 2 Å“ufs Ã  la coque â€¢ Pain seigle + beurre â€¢ 1 orange",col:"Salade d'endives aux noix â€¢ Tomates cerises",din:"Poulet rÃ´ti citron-romarin â€¢ PurÃ©e cÃ©leri-panais â€¢ Riz basmati",dn:"Poulet rÃ´ti"},
{id:2,nom:"Lundi 17",pdj:"Eau citronnÃ©e â€¢ Fromage blanc 0% + graines courge â€¢ 1 poire â€¢ Noix",col:"Radis â€¢ Å’uf dur â€¢ BÃ¢tonnets cÃ©leri â€¢ Huile colza",din:"Curry lentilles corail lÃ©gumes d'hiver â€¢ Quinoa â€¢ MÃ¢che",dn:"Curry lentilles"},
{id:3,nom:"Mardi 18",pdj:"Eau citronnÃ©e â€¢ 1 pomme â€¢ Noisettes â€¢ 1 yaourt nature",col:"Smoothie vert (Ã©pinards, banane, lait amande, graines lin)",din:"Soupe lÃ©gumes â€¢ Omelette champignons-chÃ¨vre â€¢ Pain seigle",dn:"Soupe+Omelette"},
{id:4,nom:"Mercredi 19",pdj:"Eau citronnÃ©e â€¢ Omelette herbes â€¢ Pain cÃ©rÃ©ales â€¢ 1 clÃ©mentine",col:"BÃ¢tonnets cÃ©leri et poivron â€¢ Tzatziki",din:"Dinde sautÃ©e champignons â€¢ Brocolis vapeur â€¢ PDT vapeur",dn:"Dinde champignons"},
{id:5,nom:"Jeudi 20",pdj:"Eau citronnÃ©e â€¢ Fromage blanc 3% + graines lin â€¢ 1 kiwi â€¢ Amandes",col:"Salade de fruits â€¢ Yaourt nature â€¢ Graines courge",din:"Poisson panÃ© maison au four â€¢ Riz basmati â€¢ Salade verte colza",dn:"Poisson panÃ©"},
{id:6,nom:"Vendredi 20",pdj:"Eau citronnÃ©e â€¢ 2 Å“ufs brouillÃ©s â€¢ Pain complet + huile olive â€¢ 1 orange",col:"BÃ¢tonnets carottes â€¢ Houmous de betterave",din:"Salade composÃ©e : PDT, betteraves, Å“ufs, thon, vinaigrette colza",dn:"Salade composÃ©e"}
];
function rW(){
var g=document.getElementById('weekgrid');g.innerHTML='';
J.forEach(function(j,i){
var o='';J.forEach(function(j2,i2){if(i2!==i)o+='<option value="'+i2+'">'+j2.nom+' â€” '+j2.dn+'</option>';});
g.innerHTML+='<div class="day"><h3>'+j.nom+'</h3>'+
'<div class="meal"><div class="ml">â˜€ï¸ Petit-dÃ©jeuner</div><div class="mc">'+j.pdj+'</div></div>'+
'<div class="meal"><div class="ml">ğŸ¥— Collation midi</div><div class="mc">'+j.col+'</div></div>'+
'<div class="meal meal-din" onclick="goRecette('+i+')" title="Voir la recette"><div class="ml">ğŸ½ï¸ DÃ®ner<span class="lien-din">â†— voir recette</span></div><div class="mc">'+j.din+'</div></div>'+
'<div class="swap-row"><select>'+o+'</select><button onclick="sw('+i+',this)">â†” Ã©changer dÃ®ner</button></div>'+
'<button class="btn-swap" onclick="changerRecette('+i+',this)">â†º Autre recette</button></div>';
});
}
function sw(f,b){var s=b.previousElementSibling;var t=parseInt(s.value);
var d=J[f].din,n=J[f].dn;J[f].din=J[t].din;J[f].dn=J[t].dn;J[t].din=d;J[t].dn=n;rW();}
rW();

function tab(id,btn){
document.querySelectorAll('.pnl').forEach(function(p){p.classList.remove('on')});
document.querySelectorAll('.tabs button').forEach(function(b){b.classList.remove('on')});
document.getElementById(id).classList.add('on');btn.classList.add('on');
}
function sTo(id){var e=document.getElementById(id);if(e)e.scrollIntoView({behavior:'smooth',block:'start'});}

function mC(){
var r=0,h=0;
document.querySelectorAll('#liste-principale .sitem').forEach(function(e){r++;if(e.style.display==='none')h++;});
var c=document.querySelectorAll('#caddie .sitem').length;
document.getElementById('compteur').innerHTML='<b>'+(r-h)+'</b> produit'+((r-h)>1?'s':'')+' Ã  acheter â€” <b>'+c+'</b> dans le caddie';
}
function bascule(cb){
var it=cb.closest('.sitem');var cd=document.getElementById('caddie');
if(cb.checked){
var em=cd.querySelector('.caddie-empty');if(em)em.remove();
var cl=it.cloneNode(true);cl.querySelector('input').checked=true;
cl.querySelector('input').onchange=function(){deb(this)};
cd.appendChild(cl);it.style.display='none';
if(db)db.ref('courses/coches/'+fbKey(it.querySelector('.sn').textContent)).set(true);
}mC();
}
function deb(cb){
var it=cb.closest('.sitem');var nm=it.querySelector('.sn').textContent;
document.querySelectorAll('#liste-principale .sitem').forEach(function(o){
if(o.querySelector('.sn').textContent===nm&&o.style.display==='none'){o.style.display='';o.querySelector('input').checked=false;}
});it.remove();
var cd=document.getElementById('caddie');
if(!cd.querySelector('.sitem'))cd.innerHTML='<p class="caddie-empty">Cochez les produits pour les ajouter ici.</p>';
if(db)db.ref('courses/coches/'+fbKey(nm)).remove();
mC();
}
function ajP(){
var n=document.getElementById('add-nom').value.trim();var r=document.getElementById('add-rayon').value;
if(!n)return;var c=document.querySelector('.si[data-cat="'+r+'"]');if(!c)return;
var ph=c.closest('.scat').querySelector('.ph');if(ph)ph.remove();
var l=document.createElement('label');l.className='sitem';
l.innerHTML='<input type="checkbox" onchange="bascule(this)"><span class="sn">'+n+'</span><span class="sr">AjoutÃ© manuellement</span>';
c.appendChild(l);document.getElementById('add-nom').value='';
if(db)db.ref('courses/ajoutes').push({nom:n,rayon:r});
mC();
}
mC();
function goRecette(idx){
  var btn=document.querySelectorAll('.tabs button')[1];
  tab('recettes',btn);
  var e=document.getElementById('recipe-'+idx);
  if(e)e.scrollIntoView({behavior:'instant',block:'start'});
}
function goMenu(){
  var btn=document.querySelector('.tabs button');
  tab('apercu',btn);
}
initIngredients();
document.getElementById('chat-input').onkeydown = function(e){
  if(e.key==='Enter' && !e.shiftKey){e.preventDefault();envoyerChat();}
};
document.getElementById('chat-input').oninput = function(){
  this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px';
};

// ===== PHASE 5 â€” MODIFICATION D'INGRÃ‰DIENT =====
var ingCounter = 0;
var ingData = {};

function initIngredients() {
  document.querySelectorAll('.recipe ul li').forEach(function(li) {
    li.classList.add('ing-item');
    li.onclick = function() { editerIngredient(this); };
  });
  document.querySelectorAll('.recipe h4').forEach(function(h4) {
    if (h4.textContent.trim() === 'IngrÃ©dients' && !h4.nextElementSibling.classList.contains('ing-hint')) {
      var hint = document.createElement('p');
      hint.className = 'ing-hint';
      hint.textContent = 'âœï¸ Cliquez sur un ingrÃ©dient pour le modifier';
      h4.parentNode.insertBefore(hint, h4.nextElementSibling);
    }
  });
}

function editerIngredient(li) {
  if (li.dataset.editing) return;
  var id = 'ing-' + (++ingCounter);
  li.id = id;
  ingData[id] = li.textContent.trim();
  li.dataset.editing = '1';
  li.classList.remove('ing-item');
  li.onclick = null;

  var opts = [
    ['legumes','ğŸ¥¬ LÃ©gumes'],['fruits','ğŸ Fruits'],['viandes','ğŸ¥© Viandes'],
    ['laitier','ğŸ¥š Laitier'],['feculents','ğŸŒ¾ FÃ©culents'],['epicerie','ğŸ«™ Ã‰picerie'],
    ['herbes','ğŸŒ¿ Herbes'],['oleagineux','ğŸ¥œ OlÃ©agineux'],['boulangerie','ğŸ Boulangerie']
  ].map(function(o){return '<option value="'+o[0]+'">'+o[1]+'</option>';}).join('');

  li.innerHTML = '<div class="ing-edit" onclick="event.stopPropagation()">'+
    '<input id="inp-'+id+'" type="text" onkeydown="ingKey(event,\''+id+'\')">'+
    '<select id="sel-'+id+'">'+opts+'</select>'+
    '<button class="ing-btn-ok" onclick="ingOk(\''+id+'\');return false;">âœ“</button>'+
    '<button class="ing-btn-cancel" onclick="ingAnnuler(\''+id+'\');return false;">âœ•</button>'+
  '</div>';

  var input = document.getElementById('inp-'+id);
  input.value = ingData[id];
  input.focus();
  input.select();
}

function ingKey(e, id) {
  if (e.key === 'Enter') ingOk(id);
  if (e.key === 'Escape') ingAnnuler(id);
}

function ingOk(id) {
  var li = document.getElementById(id);
  if (!li) return;
  var nouveau = document.getElementById('inp-'+id).value.trim();
  var rayon = document.getElementById('sel-'+id).value;
  var ancien = ingData[id];
  delete ingData[id];
  delete li.dataset.editing;

  if (!nouveau) { ingAnnuler(id); return; }

  li.textContent = nouveau;
  li.classList.add('ing-item');
  if (nouveau !== ancien) li.classList.add('ing-changed');
  li.onclick = function() { editerIngredient(this); };

  if (nouveau === ancien) return;

  // Sauvegarder la modification dans Firebase
  var recipeDiv = li.closest('.recipe');
  if (recipeDiv && db) {
    var recipeIdx = recipeDiv.id.replace('recipe-', '');
    db.ref('ingredients/' + recipeIdx + '/' + fbKey(ancien)).set({original: ancien, nouveau: nouveau});
  }

  document.querySelectorAll('#liste-principale .sitem').forEach(function(el) {
    var nm = el.querySelector('.sn').textContent.toLowerCase();
    var mots = ancien.toLowerCase().split(' ').filter(function(m){return m.length > 3;});
    if (mots.some(function(m){return nm.includes(m);})) {
      el.style.opacity = '0.4';
      el.title = 'â†’ RemplacÃ© par : ' + nouveau;
    }
  });

  var c = document.querySelector('.si[data-cat="'+rayon+'"]');
  if (c) {
    var ph = c.closest('.scat').querySelector('.ph');
    if (ph) ph.remove();
    var l = document.createElement('label');
    l.className = 'sitem';
    l.innerHTML = '<input type="checkbox" onchange="bascule(this)"><span class="sn">'+nouveau+'</span><span class="sr">âœï¸ IngrÃ©dient modifiÃ©</span>';
    c.appendChild(l);
  }
  if (db) db.ref('courses/ajoutes').push({nom:nouveau, rayon:rayon});
  mC();
}

function ingAnnuler(id) {
  var li = document.getElementById(id);
  if (!li) return;
  var ancien = ingData[id] || '';
  delete ingData[id];
  delete li.dataset.editing;
  li.textContent = ancien;
  li.classList.add('ing-item');
  li.onclick = function() { editerIngredient(this); };
}

// ===== PHASE 6 â€” NUTRICOACH CHAT =====
var chatHisto = [];

function envoyerChat() {
  var input = document.getElementById('chat-input');
  var msg = input.value.trim();
  if (!msg) return;
  ajouterMsg('user', msg);
  input.value = '';
  input.style.height = 'auto';
  var btn = document.getElementById('btn-chat-send');
  btn.disabled = true;
  var typingId = afficherTyping();
  var menusCtx = J.map(function(j){return {nom:j.nom, din:j.din};});
  fetch('/api/chat', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({message:msg, historique:chatHisto, menus:menusCtx})
  })
  .then(function(r){return r.json();})
  .then(function(data){
    retirerTyping(typingId);
    btn.disabled = false;
    chatHisto.push({role:'user',content:msg});
    chatHisto.push({role:'assistant',content:data.reponse});
    if(chatHisto.length > 20) chatHisto = chatHisto.slice(-20);
    ajouterMsg('bot', data.reponse);
    if(data.action) executerActionChat(data.action);
  })
  .catch(function(){
    retirerTyping(typingId);
    btn.disabled = false;
    ajouterMsg('bot','âŒ Erreur de connexion. RÃ©essayez.');
  });
}

function ajouterMsg(role, texte, type) {
  var cont = document.getElementById('chat-messages');
  var div = document.createElement('div');
  div.className = 'msg msg-' + (role==='user'?'user':'bot') + (type?' '+type:'');
  var fmt = texte
    .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
    .replace(/\*(.*?)\*/g,'<i>$1</i>')
    .replace(/\n- /g,'<br>â€¢ ')
    .replace(/\n/g,'<br>');
  div.innerHTML = '<div class="msg-bubble">'+fmt+'</div>';
  cont.appendChild(div);
  cont.scrollTop = cont.scrollHeight;
}

function afficherTyping() {
  var cont = document.getElementById('chat-messages');
  var div = document.createElement('div');
  var id = 'typing-'+Date.now();
  div.id = id; div.className = 'msg msg-bot chat-typing';
  div.innerHTML = '<div class="msg-bubble">NutriCoach rÃ©digeâ€¦</div>';
  cont.appendChild(div);
  cont.scrollTop = cont.scrollHeight;
  return id;
}

function retirerTyping(id) {
  var el = document.getElementById(id);
  if(el) el.remove();
}

function executerActionChat(action) {
  if (action.type === 'remplacer_repas' && action.recette) {
    var idx = action.jour_idx;
    if (J[idx]) {
      J[idx].din = action.recette.description || action.recette.nom;
      J[idx].dn = action.recette.nom;
      rW();
      if (action.recette.coursesAAjouter) {
        action.recette.coursesAAjouter.forEach(function(item){
          var c = document.querySelector('.si[data-cat="'+item.rayon+'"]');
          if(c){var l=document.createElement('label');l.className='sitem';
            l.innerHTML='<input type="checkbox" onchange="bascule(this)"><span class="sn">'+item.nom+'</span><span class="sr">ğŸ’¬ '+J[idx].nom+'</span>';
            c.appendChild(l);}
        });
        mC();
      }
      if(db) db.ref('menus/'+idx).set({din:J[idx].din,dn:J[idx].dn});
      ajouterMsg('bot','âœ… Planning mis Ã  jour !','msg-action');
    }
  } else if (action.type === 'generer_semaine') {
    genererSemaine(true);
  } else if (action.type === 'ajouter_courses' && action.produits) {
    action.produits.forEach(function(item){
      var c=document.querySelector('.si[data-cat="'+item.rayon+'"]');
      if(c){
        var ph=c.closest('.scat').querySelector('.ph');if(ph)ph.remove();
        var l=document.createElement('label');l.className='sitem';
        l.innerHTML='<input type="checkbox" onchange="bascule(this)"><span class="sn">'+item.nom+'</span><span class="sr">ğŸ’¬ AjoutÃ© par NutriCoach</span>';
        c.appendChild(l);
      }
      if(db)db.ref('courses/ajoutes').push({nom:item.nom,rayon:item.rayon});
    });
    mC();
    ajouterMsg('bot','âœ… '+action.produits.length+' produit(s) ajoutÃ©(s) Ã  votre liste !','msg-action');
  }
}

// ===== PHASE 7 â€” GÃ‰NÃ‰RER LA SEMAINE =====
function genererSemaine(skipConfirm) {
  if (!skipConfirm && !confirm('GÃ©nÃ©rer de nouveaux menus pour la semaine prochaine ?\nLes menus actuels seront remplacÃ©s.')) return;
  var btn = document.getElementById('btn-gen');
  btn.disabled = true;
  btn.textContent = 'â³ GÃ©nÃ©ration en coursâ€¦';

  var today = new Date();
  var day = today.getDay();
  var daysUntilSat = ((6 - day) + 7) % 7;
  if (daysUntilSat === 0) daysUntilSat = 7;

  var joursNoms = ['Samedi','Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi'];
  var moisFr = ['janvier','fÃ©vrier','mars','avril','mai','juin','juillet','aoÃ»t','septembre','octobre','novembre','dÃ©cembre'];

  var joursDates = [];
  for (var i = 0; i < 7; i++) {
    var d = new Date(today);
    d.setDate(today.getDate() + daysUntilSat + i);
    joursDates.push(joursNoms[i] + ' ' + d.getDate());
  }
  var sat = new Date(today); sat.setDate(today.getDate() + daysUntilSat);
  var ven = new Date(sat); ven.setDate(sat.getDate() + 6);
  var dateDebut = sat.getDate() + ' ' + moisFr[sat.getMonth()] + ' ' + sat.getFullYear();
  var dateFin = ven.getDate() + ' ' + moisFr[ven.getMonth()] + ' ' + ven.getFullYear();

  fetch('/api/menus', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({jours: joursDates, dateDebut: dateDebut, dateFin: dateFin})
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    appliquerNouveauxMenus(data);
    btn.disabled = false;
    btn.textContent = 'ğŸ—“ï¸ GÃ©nÃ©rer la semaine';
  })
  .catch(function() {
    alert('Erreur lors de la gÃ©nÃ©ration. RÃ©essayez.');
    btn.disabled = false;
    btn.textContent = 'ğŸ—“ï¸ GÃ©nÃ©rer la semaine';
  });
}

function appliquerNouveauxMenus(data) {
  // 1. Mettre Ã  jour le tableau J
  data.jours.forEach(function(jour, i) {
    if (J[i]) {
      J[i].nom = jour.nom;
      J[i].pdj = jour.pdj;
      J[i].col = jour.col;
      J[i].din = jour.din;
      J[i].dn = jour.dn;
    }
  });

  // 2. Mettre Ã  jour le label de semaine
  if (data.semaine) {
    document.getElementById('wk-label').textContent = 'ğŸ“… ' + data.semaine;
  }

  // 3. RafraÃ®chir le planning
  rW();

  // 4. Reconstruire la section Recettes
  var recDiv = document.getElementById('recettes');
  recDiv.innerHTML = '';
  data.jours.forEach(function(jour, i) {
    var r = jour.recette;
    if (!r) return;
    recDiv.innerHTML +=
      '<div class="recipe" id="recipe-'+i+'">' +
      '<button class="btn-back" onclick="goMenu()">â† Retour au menu</button>' +
      '<div class="recipe-top"><h3>'+r.nom+'</h3><div class="r-ico">'+r.emoji+'</div></div>' +
      '<div class="rmeta"><span><b>PrÃ©pa :</b> '+r.prepTime+'</span><span><b>Cuisson :</b> '+r.cookTime+'</span><span><b>Pour :</b> 2</span><span><b>ğŸ“…</b> '+jour.nom+'</span></div>' +
      '<h4>IngrÃ©dients</h4>' +
      '<ul>'+r.ingredients.map(function(ing){return '<li>'+ing+'</li>';}).join('')+'</ul>' +
      '<h4>PrÃ©paration</h4>' +
      '<ol>'+r.etapes.map(function(e){return '<li>'+e+'</li>';}).join('')+'</ol>' +
      '</div>';
  });
  initIngredients();

  // 5. Ajouter les nouvelles courses (sans dupliquer)
  data.jours.forEach(function(jour) {
    if (!jour.recette || !jour.recette.coursesAAjouter) return;
    jour.recette.coursesAAjouter.forEach(function(item) {
      var existe = false;
      document.querySelectorAll('#liste-principale .sitem .sn').forEach(function(el) {
        if (el.textContent.toLowerCase() === item.nom.toLowerCase()) existe = true;
      });
      if (!existe) {
        var c = document.querySelector('.si[data-cat="'+item.rayon+'"]');
        if (c) {
          var l = document.createElement('label');
          l.className = 'sitem';
          l.innerHTML = '<input type="checkbox" onchange="bascule(this)"><span class="sn">'+item.nom+'</span><span class="sr">'+jour.nom+'</span>';
          c.appendChild(l);
        }
      }
    });
  });
  mC();

  // 6. Sauvegarder dans Firebase
  if (db) {
    data.jours.forEach(function(jour, i) {
      db.ref('menus/'+i).set({nom:jour.nom, pdj:jour.pdj, col:jour.col, din:jour.din, dn:jour.dn});
    });
    if (data.semaine) db.ref('semaine').set(data.semaine);
    db.ref('ingredients').remove();
  }
}

// ===== PHASE 4 â€” AUTRE RECETTE =====
var recetteEnCours = null;

function changerRecette(idx, btn, recettesRefusees) {
  btn.textContent = 'â³ Recherche en coursâ€¦';
  btn.disabled = true;
  var autresRecettes = J.filter(function(j,i){return i!==idx;}).map(function(j){return j.dn;});
  fetch('/api/recette', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({jour:J[idx].nom, recetteActuelle:J[idx].dn, autresRecettes:autresRecettes, recettesRefusees:recettesRefusees||[]})
  })
  .then(function(r){return r.json();})
  .then(function(data){
    recetteEnCours = {idx:idx, data:data, refusees:recettesRefusees||[]};
    afficherModal(data);
    btn.textContent = 'â†º Autre recette';
    btn.disabled = false;
  })
  .catch(function(){
    alert('Erreur lors de la recherche. RÃ©essayez.');
    btn.textContent = 'â†º Autre recette';
    btn.disabled = false;
  });
}

function afficherModal(data) {
  document.getElementById('modal-titre').textContent = data.emoji + ' ' + data.nom;
  document.getElementById('modal-meta').innerHTML =
    '<span><b>PrÃ©pa :</b> '+data.prepTime+'</span><span><b>Cuisson :</b> '+data.cookTime+'</span><span><b>Pour :</b> 2</span>';
  document.getElementById('modal-ingredients').innerHTML =
    data.ingredients.map(function(i){return '<li>'+i+'</li>';}).join('');
  document.getElementById('modal-etapes').innerHTML =
    data.etapes.map(function(e){return '<li>'+e+'</li>';}).join('');
  document.getElementById('recette-modal').classList.add('on');
}

function fermerModal() {
  document.getElementById('recette-modal').classList.remove('on');
  recetteEnCours = null;
}

function accepterRecette() {
  if (!recetteEnCours) return;
  var idx = recetteEnCours.idx;
  var data = recetteEnCours.data;
  J[idx].din = data.description;
  J[idx].dn = data.nom;
  rW();
  if (data.coursesAAjouter) {
    data.coursesAAjouter.forEach(function(item) {
      var c = document.querySelector('.si[data-cat="'+item.rayon+'"]');
      if (c) {
        var l = document.createElement('label');
        l.className = 'sitem';
        l.innerHTML = '<input type="checkbox" onchange="bascule(this)"><span class="sn">'+item.nom+'</span><span class="sr">â†º '+J[idx].nom+'</span>';
        c.appendChild(l);
      }
    });
    mC();
  }
  if (db) db.ref('menus/'+idx).set({din:J[idx].din, dn:J[idx].dn});
  fermerModal();
}

function chercherAutre() {
  if (!recetteEnCours) return;
  var idx = recetteEnCours.idx;
  var refusees = (recetteEnCours.refusees || []).concat([recetteEnCours.data.nom]);
  fermerModal();
  var btns = document.querySelectorAll('.btn-swap');
  if (btns[idx]) changerRecette(idx, btns[idx], refusees);
}

// ===== FIREBASE =====
var db=null;
function fbKey(nom){return nom.replace(/[.#$[\]/]/g,'-').replace(/\s+/g,'_').substring(0,60);}

function appliquerIngredientsFirebase(ingredients){
  if(!ingredients)return;
  Object.keys(ingredients).forEach(function(idx){
    var recipeDiv=document.getElementById('recipe-'+idx);
    if(!recipeDiv)return;
    var changes=ingredients[idx];
    Object.values(changes).forEach(function(change){
      recipeDiv.querySelectorAll('ul li').forEach(function(li){
        if(li.textContent.trim()===change.original){
          li.textContent=change.nouveau;
          li.classList.add('ing-changed');
        }
      });
    });
  });
}

function appliquerDepuisFirebase(data){
  var coches=data.coches||{};
  var ajoutes=data.ajoutes||{};
  // 1. Ajouter les produits manuels absents du DOM
  Object.values(ajoutes).forEach(function(item){
    var dansDOM=false;
    document.querySelectorAll('.sitem .sn').forEach(function(el){if(el.textContent===item.nom)dansDOM=true;});
    if(!dansDOM){
      var c=document.querySelector('.si[data-cat="'+item.rayon+'"]');
      if(c){var ph=c.closest('.scat').querySelector('.ph');if(ph)ph.remove();
        var l=document.createElement('label');l.className='sitem';
        l.innerHTML='<input type="checkbox" onchange="bascule(this)"><span class="sn">'+item.nom+'</span><span class="sr">AjoutÃ© manuellement</span>';
        c.appendChild(l);}
    }
  });
  // 2. Cocher les produits prÃ©sents dans Firebase mais pas dans le caddie
  document.querySelectorAll('#liste-principale .sitem').forEach(function(it){
    var nm=it.querySelector('.sn').textContent;
    var coche=coches[fbKey(nm)];
    if(coche&&it.style.display!=='none'){
      var cd=document.getElementById('caddie');
      var em=cd.querySelector('.caddie-empty');if(em)em.remove();
      var cl=it.cloneNode(true);cl.querySelector('input').checked=true;
      cl.querySelector('input').onchange=function(){deb(this);};
      cd.appendChild(cl);it.style.display='none';
    }else if(!coche&&it.style.display==='none'){
      it.style.display='';it.querySelector('input').checked=false;
    }
  });
  // 3. Retirer du caddie les produits supprimÃ©s de Firebase (depuis un autre appareil)
  var toRemove=[];
  document.querySelectorAll('#caddie .sitem').forEach(function(it){
    var nm=it.querySelector('.sn').textContent;
    if(!coches[fbKey(nm)])toRemove.push(it);
  });
  toRemove.forEach(function(it){it.remove();});
  var cd=document.getElementById('caddie');
  if(!cd.querySelector('.sitem'))cd.innerHTML='<p class="caddie-empty">Cochez les produits pour les ajouter ici.</p>';
  mC();
}

var firebaseConfig={
  apiKey:"AIzaSyBr09zcjmNN7hsKyr_832GulpGQc9xfZOo",
  authDomain:"menu-de-la-semaine-9bed7.firebaseapp.com",
  databaseURL:"https://menu-de-la-semaine-9bed7-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"menu-de-la-semaine-9bed7",
  storageBucket:"menu-de-la-semaine-9bed7.firebasestorage.app",
  messagingSenderId:"18330977147",
  appId:"1:18330977147:web:2ef6f58c6baf85ec9e73de"
};
firebase.initializeApp(firebaseConfig);
db=firebase.database();
db.ref('/').on('value',function(snapshot){
  var data=snapshot.val()||{};
  // Sync menus modifiÃ©s
  if (data.menus) {
    Object.keys(data.menus).forEach(function(i){
      var idx=parseInt(i);
      if(J[idx]&&(J[idx].din!==data.menus[i].din)){
        J[idx].din=data.menus[i].din;
        J[idx].dn=data.menus[i].dn;
      }
    });
    rW();
  }
  appliquerDepuisFirebase(data.courses || {});
  appliquerIngredientsFirebase(data.ingredients || null);
});
</script>
</body>
</html>
